åŸºæ–¼æŠ€è¡“ç°¡å ±ï¼Œæˆ‘å°‡åŸ·è¡Œç²¾ç¢ºæœ‰æ•ˆçš„ä¿®å¾©æ–¹æ¡ˆã€‚è®“æˆ‘å€‘ç«‹å³é–‹å§‹è§£æ±ºç‰¹å¾µè¨ˆç®—å¤±æ•—é€™å€‹é—œéµå•é¡Œã€‚

ğŸš€ ç«‹å³åŸ·è¡Œï¼šç‰¹å¾µè¨ˆç®—å®‰å…¨å¢å¼·ä¿®å¾©
æ­¥é©Ÿ1: å‰µå»ºå®‰å…¨çš„æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å™¨
python
# src/features/technical_indicators.py
import pandas as pd
import numpy as np
import talib as ta
from typing import Dict, Tuple, Optional
import logging

logger = logging.getLogger(__name__)

class TechnicalIndicatorCalculator:
    """å®‰å…¨çš„æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å™¨ï¼ˆé‡å°æ•¸æ“šä¸è¶³æƒ…æ³å„ªåŒ–ï¼‰"""
    
    @staticmethod
    def safe_ema(close_prices: pd.Series, period: int) -> Optional[pd.Series]:
        """å®‰å…¨çš„EMAè¨ˆç®— - è™•ç†æ•¸æ“šä¸è¶³æƒ…æ³"""
        try:
            if close_prices is None or len(close_prices) == 0:
                logger.warning(f"EMA{period}è¨ˆç®—å¤±æ•—: æ•¸æ“šç‚ºç©º")
                return None
                
            if len(close_prices) < period:
                # æ•¸æ“šä¸è¶³æ™‚ï¼Œä½¿ç”¨å¯ç”¨æ•¸æ“šè¨ˆç®—
                available_period = min(period, len(close_prices))
                if available_period >= 5:  # æœ€å°è¦æ±‚
                    logger.debug(f"EMA{period}æ•¸æ“šä¸è¶³ï¼Œä½¿ç”¨EMA{available_period}")
                    return ta.EMA(close_prices, timeperiod=available_period)
                else:
                    logger.warning(f"EMA{period}æ•¸æ“šåš´é‡ä¸è¶³: {len(close_prices)}è¡Œ")
                    return None
                    
            return ta.EMA(close_prices, timeperiod=period)
        except Exception as e:
            logger.error(f"EMA{period}è¨ˆç®—éŒ¯èª¤: {e}")
            return None
    
    @staticmethod
    def safe_rsi(close_prices: pd.Series, period: int = 14) -> Optional[pd.Series]:
        """å®‰å…¨çš„RSIè¨ˆç®—"""
        try:
            if close_prices is None or len(close_prices) < period + 1:
                logger.warning(f"RSI{period}æ•¸æ“šä¸è¶³: {len(close_prices) if close_prices else 0} < {period + 1}")
                return None
            return ta.RSI(close_prices, timeperiod=period)
        except Exception as e:
            logger.error(f"RSI{period}è¨ˆç®—éŒ¯èª¤: {e}")
            return None
    
    @staticmethod
    def safe_bollinger_bands(close_prices: pd.Series, period: int = 20, nbdev: float = 2.0) -> Optional[Tuple]:
        """å®‰å…¨çš„å¸ƒæ—å¸¶è¨ˆç®—"""
        try:
            if close_prices is None or len(close_prices) < period:
                logger.warning(f"å¸ƒæ—å¸¶æ•¸æ“šä¸è¶³: {len(close_prices) if close_prices else 0} < {period}")
                return None
            return ta.BBANDS(close_prices, timeperiod=period, nbdevup=nbdev, nbdevdn=nbdev)
        except Exception as e:
            logger.error(f"å¸ƒæ—å¸¶è¨ˆç®—éŒ¯èª¤: {e}")
            return None
    
    @staticmethod
    def calculate_basic_indicators(close_prices: pd.Series, min_data: int = 5) -> Dict:
        """è¨ˆç®—åŸºæœ¬æŠ€è¡“æŒ‡æ¨™ï¼ˆé©æ‡‰æ•¸æ“šä¸è¶³æƒ…æ³ï¼‰"""
        indicators = {}
        
        if close_prices is None or len(close_prices) < min_data:
            logger.warning(f"æŠ€è¡“æŒ‡æ¨™è¨ˆç®—è·³é: æ•¸æ“šä¸è¶³ {len(close_prices) if close_prices else 0} < {min_data}")
            return indicators
        
        # EMAæŒ‡æ¨™ï¼ˆé©æ‡‰æ€§è¨ˆç®—ï¼‰
        indicators['ema_20'] = TechnicalIndicatorCalculator.safe_ema(close_prices, 20)
        indicators['ema_50'] = TechnicalIndicatorCalculator.safe_ema(close_prices, 50)
        
        # RSIæŒ‡æ¨™ï¼ˆéœ€è¦æ›´å¤šæ•¸æ“šï¼‰
        if len(close_prices) >= 15:
            indicators['rsi_14'] = TechnicalIndicatorCalculator.safe_rsi(close_prices, 14)
        
        # å¸ƒæ—å¸¶ï¼ˆéœ€è¦æ›´å¤šæ•¸æ“šï¼‰
        if len(close_prices) >= 20:
            bb_result = TechnicalIndicatorCalculator.safe_bollinger_bands(close_prices, 20)
            if bb_result:
                indicators['bb_upper'], indicators['bb_middle'], indicators['bb_lower'] = bb_result
        
        # ç°¡å–®ç§»å‹•å¹³å‡ï¼ˆæ›´å¯¬å®¹ï¼‰
        try:
            if len(close_prices) >= 5:
                indicators['sma_10'] = ta.SMA(close_prices, timeperiod=min(10, len(close_prices)))
        except Exception as e:
            logger.error(f"SMAè¨ˆç®—éŒ¯èª¤: {e}")
        
        return indicators
æ­¥é©Ÿ2: åœ¨ä¿¡è™Ÿç”Ÿæˆå™¨ä¸­æ·»åŠ ç‰¹å¾µè¨ˆç®—è¨ºæ–·
python
# åœ¨ src/strategies/rule_based_signal_generator.py çš„ generate_signal æ–¹æ³•ä¸­æ·»åŠ 

def generate_signal(self, symbol: str, multi_tf_data: Dict[str, pd.DataFrame]) -> Optional[Dict]:
    """ç”Ÿæˆäº¤æ˜“ä¿¡å·ï¼ˆå¸¶ç‰¹å¾µè¨ˆç®—è¨ºæ–·ï¼‰"""
    try:
        # æ•¸æ“šé©—è­‰
        if not self._validate_data(multi_tf_data):
            return None
            
        # ğŸ”§ ç‰¹å¾µè¨ˆç®—è¨ºæ–·
        logger.info(f"ğŸ” ç‰¹å¾µè¨ˆç®—è¨ºæ–· - {symbol}:")
        
        # æå–å„æ™‚é–“æ¡†æ¶æ•¸æ“š
        h1_data = multi_tf_data['1h']
        m15_data = multi_tf_data['15m'] 
        m5_data = multi_tf_data['5m']
        
        logger.info(f"   æ•¸æ“šå½¢ç‹€: 1h={h1_data.shape}, 15m={m15_data.shape}, 5m={m5_data.shape}")
        
        # è¨ºæ–·æŠ€è¡“æŒ‡æ¨™è¨ˆç®—
        from src.features.technical_indicators import TechnicalIndicatorCalculator
        
        # è¨ˆç®—1hæŠ€è¡“æŒ‡æ¨™
        h1_indicators = TechnicalIndicatorCalculator.calculate_basic_indicators(h1_data['close'])
        logger.info(f"   1hæŠ€è¡“æŒ‡æ¨™: {len(h1_indicators)}å€‹è¨ˆç®—æˆåŠŸ")
        
        # æª¢æŸ¥é—œéµæŒ‡æ¨™
        critical_indicators = ['ema_20', 'ema_50']
        for indicator in critical_indicators:
            status = "âœ…" if h1_indicators.get(indicator) is not None else "âŒ"
            logger.info(f"     {status} {indicator}: {len(h1_indicators[indicator]) if h1_indicators.get(indicator) is not None else 'N/A'}")
        
        # å¦‚æœé—œéµæŒ‡æ¨™ç¼ºå¤±ï¼Œç„¡æ³•ç”Ÿæˆæœ‰æ•ˆä¿¡è™Ÿ
        if h1_indicators.get('ema_20') is None:
            logger.warning(f"   âš ï¸ é—œéµæŒ‡æ¨™ç¼ºå¤±ï¼Œè·³éä¿¡è™Ÿç”Ÿæˆ")
            return None
            
        # ç¹¼çºŒåŸæœ‰ICT/SMCä¿¡è™Ÿç”Ÿæˆé‚è¼¯
        signal = self._generate_ict_smc_signals(symbol, multi_tf_data)
        
        if signal and signal.get('direction') != 'NONE':
            logger.info(f"   âœ… ä¿¡è™Ÿç”ŸæˆæˆåŠŸ: {signal.get('direction')}")
            # è¨˜éŒ„ç‰¹å¾µè¨ˆç®—æˆåŠŸçµ±è¨ˆ
            self._pipeline_stats['stage3_with_direction'] += 1
        else:
            logger.info(f"   âš ï¸ ç„¡æœ‰æ•ˆä¿¡è™Ÿ")
            self._pipeline_stats['stage3_no_direction'] += 1
            
        return signal
        
    except Exception as e:
        logger.error(f"âŒ {symbol} ä¿¡è™Ÿç”Ÿæˆç•°å¸¸: {e}")
        import traceback
        logger.error(f"è©³ç´°å †æ£§: {traceback.format_exc()}")
        return None
æ­¥é©Ÿ3: æ›´æ–°Pipelineçµ±è¨ˆä»¥è·Ÿè¸ªç‰¹å¾µè¨ˆç®—
python
# åœ¨ src/core/unified_scheduler.py çš„è¨ˆæ•¸å™¨é‡ç½®éƒ¨åˆ†æ›´æ–°

# æ¯æ¬¡æƒæå‘¨æœŸé–‹å§‹å‰é‡ç½®è¨ˆæ•¸å™¨
if hasattr(self.self_learning_trader, 'signal_generator'):
    self.self_learning_trader.signal_generator._pipeline_stats = {
        'stage0_total_symbols': 0,
        'stage1_valid_data': 0,
        'stage1_rejected_data': 0,
        'stage3_with_direction': 0,  # æ–°å¢ï¼šæœ‰æ–¹å‘çš„ä¿¡è™Ÿ
        'stage3_no_direction': 0,    # æ–°å¢ï¼šç„¡æ–¹å‘çš„ä¿¡è™Ÿ
        'feature_calculation_success': 0,  # æ–°å¢ï¼šç‰¹å¾µè¨ˆç®—æˆåŠŸ
        'feature_calculation_failed': 0,   # æ–°å¢ï¼šç‰¹å¾µè¨ˆç®—å¤±æ•—
    }
    logger.info("ğŸ”§ Pipelineçµ±è¨ˆè¨ˆæ•¸å™¨å·²é‡ç½®ï¼ˆåŒ…å«ç‰¹å¾µè¨ˆç®—è·Ÿè¸ªï¼‰")
æ­¥é©Ÿ4: ç«‹å³éƒ¨ç½²ä¿®å¾©
bash
# 1. å‰µå»ºç‰¹å¾µè¨ˆç®—ç›®éŒ„å’Œæ–‡ä»¶
mkdir -p src/features/

# 2. å‰µå»ºæŠ€è¡“æŒ‡æ¨™è¨ˆç®—å™¨
cat > src/features/technical_indicators.py << 'EOF'
# [ä¸Šé¢TechnicalIndicatorCalculatoré¡çš„ä»£ç¢¼]
EOF

# 3. æ›´æ–°ä¿¡è™Ÿç”Ÿæˆå™¨ï¼ˆæ‰‹å‹•æ·»åŠ è¨ºæ–·ä»£ç¢¼åˆ°rule_based_signal_generator.pyï¼‰

# 4. éƒ¨ç½²ä¿®å¾©
git add .
git commit -m "fix(v3.19.2): ç‰¹å¾µè¨ˆç®—å®‰å…¨å¢å¼· + è©³ç´°è¨ºæ–·"
git push origin main

# 5. ç›£æ§ç‰¹å¾µè¨ˆç®—æ—¥èªŒ
railway logs --follow | grep -E "ç‰¹å¾µè¨ˆç®—è¨ºæ–·|æŠ€è¡“æŒ‡æ¨™|EMA|âŒ|âœ…"
ğŸ“Š é æœŸä¿®å¾©æ•ˆæœ
ä¿®å¾©æˆåŠŸå¾Œæ‡‰è©²çœ‹åˆ°ï¼š
text
ğŸ” ç‰¹å¾µè¨ˆç®—è¨ºæ–· - BTCUSDT:
   æ•¸æ“šå½¢ç‹€: 1h=(12,5), 15m=(40,5), 5m=(120,5)
   1hæŠ€è¡“æŒ‡æ¨™: 4å€‹è¨ˆç®—æˆåŠŸ
     âœ… ema_20: 12
     âœ… ema_50: 12
     âŒ rsi_14: N/A
     âœ… sma_10: 12
   âœ… ä¿¡è™Ÿç”ŸæˆæˆåŠŸ: LONG

ğŸ“Š Pipelineé€²åº¦å¿«ç…§ï¼ˆå·²æƒæ50å€‹ï¼‰
   Stage1é©—è­‰: æœ‰æ•ˆ=50, æ‹’çµ•=0
   Stage3æ–¹å‘: æœ‰=15, ç„¡=35
   ç‰¹å¾µè¨ˆç®—: æˆåŠŸ=50, å¤±æ•—=0

â±ï¸  å¹³å‡åˆ†ææ™‚é–“: 45.9ms  â† âœ… ä¸å†æ˜¯0.0ms
å¦‚æœæ•¸æ“šä»ç„¶ä¸è¶³çš„é©æ‡‰æ€§è™•ç†ï¼š
text
ğŸ” ç‰¹å¾µè¨ˆç®—è¨ºæ–· - BTCUSDT:
   æ•¸æ“šå½¢ç‹€: 1h=(8,5), 15m=(25,5), 5m=(75,5)
   1hæŠ€è¡“æŒ‡æ¨™: 3å€‹è¨ˆç®—æˆåŠŸ
     âœ… ema_20: 8 (ä½¿ç”¨EMA8)
     âœ… ema_50: 8 (ä½¿ç”¨EMA8) 
     âŒ rsi_14: N/A
     âœ… sma_10: 8
   âœ… ä¿¡è™Ÿç”ŸæˆæˆåŠŸ: SHORT
ğŸ¯ é—œéµæ”¹é€²é»
âœ… éŒ¯èª¤è™•ç†: æ‰€æœ‰æŠ€è¡“æŒ‡æ¨™è¨ˆç®—éƒ½æœ‰try-catchä¿è­·

âœ… æ•¸æ“šé©æ‡‰: æ•¸æ“šä¸è¶³æ™‚ä½¿ç”¨å¯ç”¨æ•¸æ“šè¨ˆç®—ï¼ˆEMA20 â†’ EMA8ï¼‰

âœ… è©³ç´°è¨ºæ–·: æ˜ç¢ºé¡¯ç¤ºæ¯å€‹æŒ‡æ¨™çš„è¨ˆç®—ç‹€æ…‹

âœ… çµ±è¨ˆè·Ÿè¸ª: æ–°å¢ç‰¹å¾µè¨ˆç®—æˆåŠŸ/å¤±æ•—çµ±è¨ˆ

âœ… æ¼¸é€²å¼: éš¨ç€æ•¸æ“šç©ç´¯ï¼ŒæŒ‡æ¨™è¨ˆç®—è¶Šä¾†è¶Šæº–ç¢º

ğŸ”„ ä¸‹ä¸€æ­¥é©—è­‰
éƒ¨ç½²å¾Œé‡é»ç›£æ§ï¼š

bash
# ç›£æ§ç‰¹å¾µè¨ˆç®—ç‹€æ…‹
railway logs --follow | grep "ç‰¹å¾µè¨ˆç®—è¨ºæ–·"

# ç›£æ§åˆ†ææ™‚é–“è®ŠåŒ–
railway logs --follow | grep "å¹³å‡åˆ†ææ™‚é–“"

# ç›£æ§ä¿¡è™Ÿç”Ÿæˆ
railway logs --follow | grep "ä¿¡è™Ÿç”ŸæˆæˆåŠŸ"
æˆåŠŸæ¨™èªŒï¼š

å¹³å‡åˆ†ææ™‚é–“å¾0.0mså¢åŠ åˆ°æ­£å¸¸ç¯„åœï¼ˆ10-100msï¼‰

çœ‹åˆ°"ç‰¹å¾µè¨ˆç®—è¨ºæ–·"æ—¥èªŒé¡¯ç¤ºæŒ‡æ¨™è¨ˆç®—æˆåŠŸ

é–‹å§‹ç”Ÿæˆäº¤æ˜“ä¿¡è™Ÿ