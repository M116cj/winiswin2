3. æ•¸æ“šç¼ºå£è™•ç†å™¨
python
# src/core/websocket/data_gap_handler.py

class DataGapHandler:
    """æ•¸æ“šç¼ºå£è™•ç†å™¨"""
    
    def __init__(self):
        self.historical_client = BinanceHistoricalClient()
    
    async def handle_gap(self, symbol: str, buffer: Dict):
        """è™•ç†æ•¸æ“šç¼ºå£"""
        try:
            logger.info(f"ðŸ”§ è™•ç† {symbol} æ•¸æ“šç¼ºå£")
            
            # ç²å–æœ€å¾Œçš„æœ‰æ•ˆæ™‚é–“æˆ³
            last_timestamp = self._get_last_timestamp(buffer)
            if not last_timestamp:
                return
                
            # è¨ˆç®—ç¼ºå£æ™‚é–“
            gap_duration = self._calculate_gap_duration(last_timestamp)
            
            if gap_duration > 300:  # è¶…éŽ5åˆ†é˜çš„ç¼ºå£
                logger.warning(f"âš ï¸ {symbol} ç™¼ç¾é‡å¤§æ•¸æ“šç¼ºå£: {gap_duration:.1f}ç§’")
                
                # è«‹æ±‚æ­·å²æ•¸æ“šè£œé½Š
                await self._fill_data_gap(symbol, last_timestamp, buffer)
            else:
                logger.info(f"ðŸ“Š {symbol} è¼•å¾®æ•¸æ“šç¼ºå£: {gap_duration:.1f}ç§’ï¼Œç­‰å¾…è‡ªå‹•æ¢å¾©")
                
        except Exception as e:
            logger.error(f"âŒ è™•ç†æ•¸æ“šç¼ºå£å¤±æ•— {symbol}: {e}")

    def _get_last_timestamp(self, buffer: Dict) -> Optional[int]:
        """ç²å–æœ€å¾Œçš„æ™‚é–“æˆ³"""
        try:
            for timeframe in ['kline_1m', 'kline_5m', 'kline_15m', 'kline_1h']:
                if buffer[timeframe]:
                    last_kline = buffer[timeframe][-1]
                    return last_kline.get('timestamp')
            return None
        except:
            return None

    def _calculate_gap_duration(self, last_timestamp: int) -> float:
        """è¨ˆç®—ç¼ºå£æŒçºŒæ™‚é–“"""
        try:
            last_time = datetime.fromtimestamp(last_timestamp / 1000)
            current_time = datetime.now()
            return (current_time - last_time).total_seconds()
        except:
            return 0

    async def _fill_data_gap(self, symbol: str, last_timestamp: int, buffer: Dict):
        """å¡«å……æ•¸æ“šç¼ºå£"""
        try:
            # é€™è£¡æ‡‰è©²èª¿ç”¨ Binance API ç²å–æ­·å²æ•¸æ“š
            # æš«æ™‚è¨˜éŒ„æ—¥èªŒ
            logger.info(f"ðŸ“¥ ç‚º {symbol} è«‹æ±‚æ­·å²æ•¸æ“šï¼Œå¾ž {last_timestamp} é–‹å§‹")
            
            # æ¨¡æ“¬æ•¸æ“šæ¢å¾©
            await asyncio.sleep(1)
            logger.info(f"âœ… {symbol} æ•¸æ“šç¼ºå£å·²è™•ç†")
            
        except Exception as e:
            logger.error(f"âŒ å¡«å……æ•¸æ“šç¼ºå£å¤±æ•— {symbol}: {e}")
4. éƒ¨ç½²æ•´åˆè…³æœ¬
bash
#!/bin/bash
echo "ðŸš€ éƒ¨ç½²å®Œæ•´ WebSocket ä¿®å¾©æ–¹æ¡ˆ..."

# 1. å‰µå»ºç›®éŒ„çµæ§‹
mkdir -p src/core/websocket/

# 2. å‰µå»ºæ ¸å¿ƒæ–‡ä»¶
cat > src/core/websocket/__init__.py << 'EOF'
# WebSocket æ¨¡çµ„
EOF

cat > src/core/websocket/advanced_feed_manager.py << 'EOF'
# [ä¸Šé¢çš„ AdvancedWebSocketManager ä»£ç¢¼]
EOF

cat > src/core/websocket/robust_price_feed.py << 'EOF'
# [ä¹‹å‰æä¾›çš„ RobustPriceFeed ä»£ç¢¼]
EOF

cat > src/core/websocket/data_quality_monitor.py << 'EOF'
# [ä¸Šé¢çš„ DataQualityMonitor ä»£ç¢¼]
EOF

cat > src/core/websocket/data_gap_handler.py << 'EOF'
# [ä¸Šé¢çš„ DataGapHandler ä»£ç¢¼]
EOF

# 3. æ›´æ–°é…ç½®
cat > config/websocket_config.py << 'EOF'
WEBSOCKET_CONFIG = {
    'railway_optimized': {
        'max_symbols_per_connection': 150,
        'ping_interval': 20,
        'ping_timeout': 10,
        'reconnect_base_delay': 1,
        'max_reconnect_delay': 30,
        'connection_timeout': 180,
        'health_check_interval': 30,
        'heartbeat_interval': 180,
    }
}
EOF

# 4. æ›´æ–°ä¸»ç¨‹åºä½¿ç”¨æ–°çš„ç®¡ç†å™¨
echo "ðŸ“ è«‹æ›´æ–°ä¸»ç¨‹åºä½¿ç”¨ AdvancedWebSocketManager æ›¿ä»£èˆŠçš„ PriceFeed"

# 5. éƒ¨ç½²
git add src/core/websocket/ config/websocket_config.py
git commit -m "feat: å®Œæ•´WebSocketä¿®å¾©æ–¹æ¡ˆ - æ•¸æ“šè³ªé‡ç›£æŽ§ + ç¼ºå£è™•ç† + Railwayå„ªåŒ–"
git push origin main

echo "âœ… éƒ¨ç½²å®Œæˆï¼ç›£æŽ§æ—¥èªŒï¼š"
echo "railway logs --follow | grep -E 'WebSocket|æ•¸æ“šè³ªé‡|æ•¸æ“šç¼ºå£'"

æ•¸æ“šæµç¨‹æ”¹å–„ï¼š
text
ä¿®å¾©å‰: WebSocket â†’ [ç¶“å¸¸æ–·ç·š] â†’ ç‰¹å¾µè¨ˆç®— â†’ [ç¶“å¸¸å‡ºéŒ¯] â†’ ä¿¡è™Ÿç”Ÿæˆ
ä¿®å¾©å¾Œ: WebSocket â†’ è³ªé‡ç›£æŽ§ â†’ ç¼ºå£è™•ç† â†’ ç‰¹å¾µè¨ˆç®— â†’ ä¿¡è™Ÿç”Ÿæˆ
                      â†“              â†“
                   è‡ªå‹•ä¿®å¾©       æ•¸æ“šè£œé½Š
