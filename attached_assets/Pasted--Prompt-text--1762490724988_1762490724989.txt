系統架構優化 Prompt
text
你現在是一位資深系統架構師和代碼重構專家。基於已完成的系統審計報告，我需要你執行完整的系統優化。

## 🎯 任務目標

對整個交易機器人系統進行**深度重構和優化**，基於審計報告中的發現，實現以下目標：

### 核心指標
- **代碼行數減少**: 42,752 → 28,000行 (↓34%)
- **文件數量減少**: 114 → 76個文件 (↓33%)  
- **類數量減少**: 141 → 95個類 (↓33%)
- **性能提升**: 啟動時間↓30%，內存使用↓25%

## 📋 具體執行要求

### 階段1: 數據層統一 (最高優先級)

#### 1.1 啟用PostgreSQL作為唯一數據源
```python
# 當前問題: 3個數據存儲系統並存
❌ JSONL文件 (data/trades.jsonl)
❌ SQLite數據庫 (trading_data.db)  
❌ PostgreSQL (Railway) - 已創建但未使用！

# 要求: 統一使用PostgreSQL
✅ 刪除JSONL和SQLite相關代碼
✅ 修改main.py使用PostgreSQL
✅ 創建UnifiedTradeRecorder
1.2 合併TradeRecorder實現
python
# 當前問題: 4個重複的TradeRecorder
❌ src/managers/trade_recorder.py (800行)
❌ src/managers/optimized_trade_recorder.py (400行) 
❌ src/core/trade_recorder.py (600行)
❌ src/managers/enhanced_trade_recorder.py (300行)

# 要求: 合併為單一實現
✅ 創建src/managers/unified_trade_recorder.py
✅ 保留ML特徵收集功能
✅ 使用PostgreSQL批量操作
1.3 合併技術指標引擎
python
# 當前問題: 2個同名但不同實現的引擎
❌ src/core/elite/technical_indicator_engine.py (1200行)
❌ src/technical/elite_technical_engine.py (900行)

# 要求: 保留一個，刪除另一個
✅ 選擇保留src/core/elite/technical_indicator_engine.py
✅ 刪除src/technical/elite_technical_engine.py
✅ 更新所有導入路徑
階段2: 架構優化
2.1 WebSocket系統合併
python
# 當前問題: 8個WebSocket相關文件，職責重疊
❌ base_feed.py, optimized_base_feed.py, advanced_feed_manager.py等

# 要求: 創建統一協調器
✅ 創建src/core/websocket/orchestrator.py
✅ 合併重複的心跳和重連邏輯
✅ 簡化Feed層級結構
2.2 配置管理統一
python
# 當前問題: 2個配置類讀取相同環境變數
❌ src/config.py
❌ src/database/config.py

# 要求: 合併為單一配置類
✅ 刪除src/database/config.py
✅ 擴展src/config.py包含數據庫配置
✅ 統一環境變數管理
2.3 日誌系統標準化
python
# 當前問題: 混用SmartLogger和標準logging
✅ 30個文件使用SmartLogger
❌ 84個文件使用標準logging

# 要求: 全面使用SmartLogger
✅ 創建src/utils/logger_factory.py
✅ 全局替換標準logging為SmartLogger
✅ 統一日誌配置和限流
階段3: 代碼清理和性能優化
3.1 清理未使用代碼
python
# 要求: 徹底清理
✅ 刪除未使用的導入語句 (估計50-80個)
✅ 刪除未使用的變數和函數
✅ 刪除空實現和註釋掉的代碼
✅ 優化import順序和結構
3.2 性能優化
python
# 要求: 關鍵性能改進
✅ 確保aiofiles正確安裝和使用
✅ 實現數據庫批量操作
✅ 優化循環和I/O操作
✅ 調整連接池配置
🔧 技術實施標準
代碼質量要求
python
# 1. 單一職責原則
class UnifiedTradeRecorder:
    # 只負責交易記錄，不包含業務邏輯
    pass

# 2. 依賴注入
def __init__(self, db_service: TradingDataService):
    self.db_service = db_service  # 而不是直接實例化

# 3. 錯誤處理一致性
try:
    # 數據庫操作
except psycopg2.Error as e:
    logger.error(f"數據庫錯誤: {e}")
    raise
except Exception as e:
    logger.error(f"未知錯誤: {e}")
    raise

# 4. 類型提示
def save_trade(self, trade_data: Dict) -> Optional[int]:
    """保存交易記錄"""
    pass
文件組織標準
text
src/
├── core/           # 核心業務邏輯
├── database/       # 數據層
├── managers/       # 管理器
├── ml/            # 機器學習
├── strategies/    # 交易策略
├── utils/         # 工具類
└── config.py      # 統一配置
性能標準
啟動時間: < 10秒

內存使用: < 500MB

數據庫查詢: < 50ms

WebSocket延遲: < 100ms

📊 驗證標準
功能驗證清單
所有交易正常記錄到PostgreSQL

ML模型正常訓練和預測

WebSocket實時數據正常

技術指標計算一致

配置加載正確

日誌輸出一致

性能驗證清單
啟動時間降低30%

內存使用降低25%

數據庫查詢性能提升

無內存泄漏

代碼質量驗證
無LSP錯誤和警告

單元測試通過率100%

代碼覆蓋率>80%

無安全漏洞

🚨 風險控制和回退方案
高風險操作
python
# 1. 數據存儲遷移
✅ 完整備份現有數據
✅ 創建數據遷移腳本
✅ 逐步遷移，驗證數據一致性

# 2. 核心組件重構
✅ 保持向後兼容的API
✅ 分階段部署
✅ 詳細的回退計劃
回退機制
bash
# 立即回退
git checkout HEAD~1

# 恢復備份  
cp src/managers/trade_recorder.py.backup src/managers/trade_recorder.py

# Railway自動回滾
# (通過git revert或重新部署上一版本)
📝 交付物要求
1. 完整的優化後代碼
所有修改的文件

新的統一組件

更新後的配置

清理後的代碼結構

2. 變更文檔
markdown
## 變更總結
- 刪除文件: 38個
- 修改文件: 25個  
- 新增文件: 5個
- 代碼行數: -14,752行

## 性能改進
- 啟動時間: -30%
- 內存使用: -25%
- 代碼維護性: +60%
3. 部署指南
環境變數配置

數據庫遷移步驟

驗證檢查清單

故障排除指南

🎯 執行優先級
Phase 1 (立即執行)
✅ 啟用PostgreSQL作為主數據庫

✅ 創建UnifiedTradeRecorder

✅ 刪除JSONL和SQLite相關代碼

✅ 合併技術指標引擎

Phase 2 (本週內完成)
✅ WebSocket系統合併

✅ 配置管理統一

✅ 日誌系統標準化

Phase 3 (下週完成)
✅ 清理未使用代碼

✅ 性能優化

✅ 測試和文檔更新

⚡ 特殊注意事項
Railway環境適配
python
# 使用Railway提供的環境變數
DATABASE_URL = os.getenv('DATABASE_URL')  # 內部連接
DATABASE_PUBLIC_URL = os.getenv('DATABASE_PUBLIC_URL')  # 外部連接

# 資源限制優化
DB_MAX_CONNECTIONS = 10  # Railway推薦值
生產環境就緒
python
# 錯誤恢復機制
def robust_operation(self):
    for attempt in range(3):
        try:
            return self._operation()
        except Exception as e:
            if attempt == 2:
                raise
            time.sleep(2 ** attempt)

# 資源清理
def __del__(self):
    if hasattr(self, 'connection_pool'):
        self.connection_pool.closeall()
🏁 開始執行
基於已完成的系統審計報告，立即開始第一階段優化：

首先修改main.py - 啟用PostgreSQL並創建UnifiedTradeRecorder

然後創建unified_trade_recorder.py - 合併所有TradeRecorder功能

接著刪除重複文件 - 移除JSONL和SQLite相關代碼

最後更新所有導入 - 確保系統一致性

要求: 提供完整的、可立即運行的優化後代碼，確保每個修改都經過驗證且向後兼容。

開始執行吧！🚀

text

這個 prompt 的特點：

1. **極度具體** - 基於審計報告的具體發現，提供精確的修改目標
2. **可執行性強** - 給出具體的代碼示例和文件路徑
3. **風險控制** - 包含完整的驗證標準和回退方案
4. **階段化實施** - 明確的三階段執行計劃
5. **質量保證** - 詳細的代碼質量標準和性能要求
6. **交付明確** - 清晰的交付物要求和驗證清單

使用這個 prompt，AI 將能夠基於現有的審計報告，系統性地執行整個代碼庫的優化，實現預期的性能改進和代碼精簡目標。
