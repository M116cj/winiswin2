 CRITICAL FIX REQUIRED - ç«‹å³æ‰§è¡Œ
æ£€æµ‹åˆ° UnifiedTradeRecorder å¯¹è±¡ç¼ºå°‘ get_trades æ–¹æ³•ï¼Œè¿™æ˜¯ç³»ç»Ÿå…³é”®åŠŸèƒ½é”™è¯¯ã€‚ä»¥ä¸‹æ˜¯ç²¾ç¡®ä¿®å¤æŒ‡ä»¤ï¼š

ğŸ”§ STEP 1: è¯Šæ–­ UnifiedTradeRecorder ç±»ç»“æ„
æ‰§è¡Œç±»ç»“æ„åˆ†æï¼š

text
# æ–‡ä»¶ä½ç½®ï¼šsrc/core/unified_trade_recorder.py
# åˆ†æ UnifiedTradeRecorder ç±»çš„ç°æœ‰æ–¹æ³•

æ‰§è¡Œä»¥ä¸‹è¯Šæ–­ï¼š
1. æ£€æŸ¥ UnifiedTradeRecorder ç±»çš„å®Œæ•´å®šä¹‰
2. åˆ—å‡ºæ‰€æœ‰ç°æœ‰æ–¹æ³•
3. ç¡®è®¤æ•°æ®å­˜å‚¨æœºåˆ¶ï¼ˆPostgreSQL / JSONLï¼‰
4. è¯†åˆ«è·å–äº¤æ˜“è®°å½•çš„ç›¸å…³æ–¹æ³•
5. ç¡®å®šæ–¹æ³•å‘½åä¸ä¸€è‡´é—®é¢˜
é¢„æœŸå‘ç°ï¼š

å¯èƒ½çš„æ–¹æ³•åï¼šget_trade_history, fetch_trades, load_trades, get_all_trades

æ•°æ®æºï¼šPostgreSQL trades è¡¨ æˆ– trades.jsonl æ–‡ä»¶

æ¥å£ä¸ä¸€è‡´ï¼šè°ƒåº¦å™¨æœŸæœ›çš„æ–¹æ³•åä¸å®é™…æ–¹æ³•åä¸åŒ¹é…

ğŸ› ï¸ STEP 2: å®ç°ç¼ºå¤±çš„ get_trades æ–¹æ³•
æ‰§è¡Œç²¾ç¡®ä»£ç ä¿®å¤ï¼š

text
# åœ¨ UnifiedTradeRecorder ç±»ä¸­æ·»åŠ  get_trades æ–¹æ³•

ä¿®å¤æ–¹æ¡ˆé€‰æ‹©ï¼ˆæ ¹æ®å®é™…æƒ…å†µé€‰æ‹©ä¸€ç§ï¼‰ï¼š

æ–¹æ¡ˆ A: æ·»åŠ é€‚é…å™¨æ–¹æ³•ï¼ˆæ¨èï¼‰
class UnifiedTradeRecorder:
    def get_trades(self, days: int = 30, limit: int = 1000):
        """é€‚é…å™¨æ–¹æ³• - ç»Ÿä¸€æ¥å£"""
        # è°ƒç”¨ç°æœ‰çš„å®é™…æ–¹æ³•
        return self.get_trade_history(days=days, limit=limit)  # æˆ–å®é™…æ–¹æ³•å

æ–¹æ¡ˆ B: å®ç°å®Œæ•´çš„æ–°æ–¹æ³•  
class UnifiedTradeRecorder:
    def get_trades(self, days: int = 30, limit: int = 1000, symbol: str = None):
        """è·å–äº¤æ˜“è®°å½•çš„ç»Ÿä¸€æ–¹æ³•"""
        try:
            # ä¼˜å…ˆä» PostgreSQL è·å–
            if hasattr(self, 'pg_pool') and self.pg_pool:
                return await self._get_trades_from_postgresql(days, limit, symbol)
            else:
                # å›é€€åˆ° JSONL æ–‡ä»¶
                return await self._get_trades_from_jsonl(days, limit, symbol)
        except Exception as e:
            logger.error(f"è·å–äº¤æ˜“è®°å½•å¤±è´¥: {e}")
            return []

æ–¹æ¡ˆ C: æ–¹æ³•åˆ«åï¼ˆå¿«é€Ÿä¿®å¤ï¼‰
class UnifiedTradeRecorder:
    get_trades = get_trade_history  # æˆ–å®é™…çš„æ–¹æ³•å¼•ç”¨
ğŸ“Š STEP 3: ç¡®ä¿æ•°æ®è®¿é—®ä¸€è‡´æ€§
ä¿®å¤æ•°æ®è®¿é—®å±‚ï¼š

text
# å®ç°ç»Ÿä¸€çš„æ•°æ®è®¿é—®é€»è¾‘

1. PostgreSQL æ•°æ®è®¿é—®æ–¹æ³•ï¼š
async def _get_trades_from_postgresql(self, days, limit, symbol=None):
    query = """
    SELECT * FROM trades 
    WHERE created_at >= NOW() - INTERVAL '%s days'
    {symbol_filter}
    ORDER BY created_at DESC 
    LIMIT %s
    """.format(symbol_filter=f"AND symbol = '{symbol}'" if symbol else "")
    
    async with self.pg_pool.acquire() as conn:
        return await conn.fetch(query, days, limit)

2. JSONL å›é€€æ–¹æ³•ï¼š
async def _get_trades_from_jsonl(self, days, limit, symbol=None):
    trades = []
    cutoff_time = datetime.now() - timedelta(days=days)
    
    try:
        with open('data/trades.jsonl', 'r') as f:
            for line in f:
                trade = json.loads(line)
                trade_time = datetime.fromisoformat(trade['timestamp'])
                if trade_time >= cutoff_time:
                    if not symbol or trade.get('symbol') == symbol:
                        trades.append(trade)
                if len(trades) >= limit:
                    break
    except FileNotFoundError:
        logger.warning("trades.jsonl æ–‡ä»¶ä¸å­˜åœ¨")
    
    return trades[-limit:]  # è¿”å›æœ€æ–°çš„è®°å½•
ğŸ”„ STEP 4: æ›´æ–°è°ƒåº¦å™¨è°ƒç”¨
ä¿®å¤ UnifiedScheduler è°ƒç”¨ï¼š

text
# æ–‡ä»¶ï¼šsrc/core/unified_scheduler.py
# æ›´æ–°é”™è¯¯çš„è°ƒç”¨ä»£ç 

ä¿®å¤å‰ï¼š
try:
    trades = recorder.get_trades(days=7)  # è¿™é‡Œä¼šæŠ¥é”™
    stats = calculate_trade_stats(trades)
    display_stats(stats)
except Exception as e:
    logger.error(f"æ˜¾ç¤ºå†å²ç»Ÿè®¡å¤±è´¥: {e}")

ä¿®å¤åï¼š
try:
    # ä½¿ç”¨æ­£ç¡®çš„æ–¹æ³•å
    trades = recorder.get_trade_history(days=7)  # æˆ– recorder.get_trades(days=7)
    stats = calculate_trade_stats(trades)
    display_stats(stats)
except Exception as e:
    logger.error(f"æ˜¾ç¤ºå†å²ç»Ÿè®¡å¤±è´¥: {e}")
ğŸ§ª STEP 5: éªŒè¯ä¿®å¤ç»“æœ
æ‰§è¡ŒéªŒè¯æµ‹è¯•ï¼š

text
# éªŒè¯ä¿®å¤çš„å®Œæ•´æ€§

æµ‹è¯• 1: æ–¹æ³•å­˜åœ¨æ€§éªŒè¯
def test_method_existence():
    recorder = UnifiedTradeRecorder()
    assert hasattr(recorder, 'get_trades'), "get_trades æ–¹æ³•ä¸å­˜åœ¨"
    assert callable(recorder.get_trades), "get_trades ä¸å¯è°ƒç”¨"

æµ‹è¯• 2: æ•°æ®è¿”å›éªŒè¯  
async def test_data_retrieval():
    recorder = UnifiedTradeRecorder()
    trades = await recorder.get_trades(days=7, limit=50)
    assert isinstance(trades, list), "åº”è¯¥è¿”å›åˆ—è¡¨"
    if trades:
        assert 'symbol' in trades[0], "äº¤æ˜“è®°å½•åº”åŒ…å« symbol å­—æ®µ"
        assert 'outcome' in trades[0], "äº¤æ˜“è®°å½•åº”åŒ…å« outcome å­—æ®µ"

æµ‹è¯• 3: é”™è¯¯å¤„ç†éªŒè¯
async def test_error_handling():
    recorder = UnifiedTradeRecorder()
    # æµ‹è¯•æ— æ•ˆå‚æ•°
    trades = await recorder.get_trades(days=-1, limit=0)
    assert trades == [], "æ— æ•ˆå‚æ•°åº”è¿”å›ç©ºåˆ—è¡¨"
ğŸ“‹ æ‰§è¡Œæ£€æŸ¥æ¸…å•
ä¿®å¤å®ŒæˆéªŒè¯ï¼š

text
âœ… UnifiedTradeRecorder ç±»å·²åŒ…å« get_trades æ–¹æ³•
âœ… æ–¹æ³•ç­¾åæ­£ç¡®ï¼š(self, days=30, limit=1000, symbol=None)
âœ… æ•°æ®æºè®¿é—®æ­£å¸¸ï¼ˆPostgreSQL + JSONL å›é€€ï¼‰
âœ… é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„
âœ… UnifiedScheduler è°ƒç”¨æ›´æ–°
âœ… éªŒè¯æµ‹è¯•å…¨éƒ¨é€šè¿‡
âœ… å†å²ç»Ÿè®¡æ˜¾ç¤ºåŠŸèƒ½æ¢å¤æ­£å¸¸