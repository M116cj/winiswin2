çœ‹åˆ°å•é¡Œäº†ï¼KlineFeed WebSocket ä¹Ÿå‡ºç¾ keepalive ping timeoutã€‚é€™æ˜¯ä¸€å€‹ç³»çµ±æ€§çš„ WebSocket ç©©å®šæ€§å•é¡Œã€‚è®“æˆ‘æä¾›å®Œæ•´çš„ä¿®å¾©æ–¹æ¡ˆï¼š

ğŸ”§ Replit AI WebSocket å…¨é¢ç©©å®šæ€§ä¿®å¾© Prompt

```
ğŸ¯ **Replit AI WebSocket å…¨é¢ç©©å®šæ€§ä¿®å¾©æŒ‡ä»¤**

è«‹ç«‹å³ä¿®å¾© SelfLearningTrader ç³»çµ±ä¸­çš„æ‰€æœ‰ WebSocket é€£æ¥ç©©å®šæ€§å•é¡Œï¼Œå•é¡Œæ—¥èªŒé¡¯ç¤ºï¼š
```

âŒ KlineFeed-Shard2 æ¥æ”¶å¤±æ•—: sent 1011 (internal error) keepalive ping timeout; no close frame received
âŒ PriceFeed-Shard1 æ¥æ”¶å¤±æ•—: sent 1011 (internal error) keepalive ping timeout; no close frame received

```

## ğŸš¨ **å•é¡Œè¨ºæ–·**
**æ ¹æœ¬åŸå› **: æ‰€æœ‰ WebSocket é€£æ¥ï¼ˆPriceFeed + KlineFeedï¼‰éƒ½å›  keepalive ping è¶…æ™‚è€Œæ–·é–‹ï¼Œè¡¨æ˜æ˜¯ç³»çµ±æ€§çš„ç¶²çµ¡ç©©å®šæ€§å•é¡Œã€‚

## ğŸ”§ **å…¨é¢ä¿®å¾©æ–¹æ¡ˆ**

### **ä¿®å¾©1: å‰µå»ºçµ±ä¸€çš„ WebSocket ç©©å®šæ€§ç®¡ç†å™¨**
```python
# src/core/websocket/stability_manager.py
import asyncio
import time
import logging
from typing import Dict, Callable, Optional

logger = logging.getLogger(__name__)

class WebSocketStabilityManager:
    """çµ±ä¸€çš„ WebSocket ç©©å®šæ€§ç®¡ç†å™¨"""
    
    def __init__(self):
        self._connections: Dict[str, Dict] = {}
        self._reconnect_tasks: Dict[str, asyncio.Task] = {}
        self._monitoring = True
        
    async def manage_connection(self, connection_id: str, connect_func: Callable, 
                              disconnect_func: Callable, max_retries: int = 5):
        """ç®¡ç† WebSocket é€£æ¥çš„ç”Ÿå‘½é€±æœŸ"""
        retry_count = 0
        base_delay = 2  # åŸºç¤é‡é€£å»¶é²
        
        while retry_count < max_retries and self._monitoring:
            try:
                logger.info(f"ğŸ”„ å»ºç«‹ WebSocket é€£æ¥: {connection_id} (å˜—è©¦ {retry_count + 1}/{max_retries})")
                
                # å»ºç«‹é€£æ¥
                connection = await connect_func()
                self._connections[connection_id] = {
                    'instance': connection,
                    'last_activity': time.time(),
                    'retry_count': retry_count
                }
                
                logger.info(f"âœ… WebSocket é€£æ¥æˆåŠŸ: {connection_id}")
                retry_count = 0  # é‡ç½®é‡è©¦è¨ˆæ•¸
                
                # ç›£æ§é€£æ¥ç‹€æ…‹
                monitor_task = asyncio.create_task(
                    self._monitor_connection_health(connection_id, connection)
                )
                self._reconnect_tasks[connection_id] = monitor_task
                
                await monitor_task
                
            except Exception as e:
                retry_count += 1
                logger.warning(f"âš ï¸ WebSocket é€£æ¥å¤±æ•— {connection_id}: {e}")
                
                if retry_count < max_retries:
                    # æŒ‡æ•¸é€€é¿ç­–ç•¥
                    delay = base_delay * (2 ** retry_count)
                    logger.info(f"â³ {delay}ç§’å¾Œé‡è©¦ {connection_id}...")
                    await asyncio.sleep(min(delay, 30))  # æœ€å¤§30ç§’
                else:
                    logger.error(f"âŒ WebSocket é€£æ¥å¾¹åº•å¤±æ•—: {connection_id}")
                    break
                    
            finally:
                # æ¸…ç†è³‡æº
                if connection_id in self._connections:
                    del self._connections[connection_id]
                await disconnect_func()
    
    async def _monitor_connection_health(self, connection_id: str, connection):
        """ç›£æ§é€£æ¥å¥åº·ç‹€æ…‹"""
        last_pong = time.time()
        
        while connection.open and self._monitoring:
            try:
                current_time = time.time()
                
                # æª¢æŸ¥é€£æ¥æ´»æ€§ï¼ˆè¶…é40ç§’ç„¡æ´»å‹•è¦–ç‚ºæ–·é–‹ï¼‰
                if current_time - last_pong > 40:
                    logger.warning(f"ğŸ«€ é€£æ¥æ´»æ€§æª¢æŸ¥å¤±æ•—: {connection_id}")
                    break
                    
                # æ¯20ç§’ç™¼é€ä¸€æ¬¡æ´»æ€§æª¢æŸ¥
                if current_time - self._connections[connection_id]['last_activity'] > 20:
                    await self._send_keepalive(connection)
                    self._connections[connection_id]['last_activity'] = current_time
                    
                await asyncio.sleep(10)  # æ¯10ç§’æª¢æŸ¥ä¸€æ¬¡
                
            except Exception as e:
                logger.error(f"âŒ é€£æ¥ç›£æ§éŒ¯èª¤ {connection_id}: {e}")
                break
    
    async def _send_keepalive(self, connection):
        """ç™¼é€ä¿æŒæ´»æ€§ä¿¡è™Ÿ"""
        try:
            # å°æ–¼æ”¯æŒ ping/pong çš„ WebSocket
            if hasattr(connection, 'ping'):
                await connection.ping()
            # å°æ–¼å…¶ä»–é¡å‹çš„é€£æ¥ï¼Œç™¼é€ç©ºæ¶ˆæ¯
            elif hasattr(connection, 'send'):
                await connection.send('')
        except Exception as e:
            logger.warning(f"âš ï¸ ä¿æŒæ´»æ€§ä¿¡è™Ÿç™¼é€å¤±æ•—: {e}")
            raise
    
    def on_pong_received(self, connection_id: str):
        """æ”¶åˆ° pong å›æ‡‰æ™‚èª¿ç”¨"""
        if connection_id in self._connections:
            self._connections[connection_id]['last_activity'] = time.time()
            logger.debug(f"âœ… æ”¶åˆ° pong: {connection_id}")
    
    async def shutdown(self):
        """å„ªé›…é—œé–‰æ‰€æœ‰é€£æ¥"""
        self._monitoring = False
        logger.info("ğŸ›‘ é—œé–‰ WebSocket ç©©å®šæ€§ç®¡ç†å™¨...")
        
        # å–æ¶ˆæ‰€æœ‰ç›£æ§ä»»å‹™
        for task in self._reconnect_tasks.values():
            task.cancel()
        
        # é—œé–‰æ‰€æœ‰é€£æ¥
        for connection_id, conn_data in self._connections.items():
            try:
                if hasattr(conn_data['instance'], 'close'):
                    await conn_data['instance'].close()
                    logger.info(f"âœ… é—œé–‰é€£æ¥: {connection_id}")
            except Exception as e:
                logger.error(f"âŒ é—œé–‰é€£æ¥å¤±æ•— {connection_id}: {e}")
```

ä¿®å¾©2: å¢å¼· KlineFeed ç©©å®šæ€§

```python
# src/core/websocket/stable_kline_feed.py
class StableKlineFeed(KlineFeed):
    def __init__(self, config):
        super().__init__(config)
        self.stability_manager = WebSocketStabilityManager()
        self._is_connected = False
        
    async def start_stable(self):
        """å•Ÿå‹•ç©©å®šçš„ KlineFeed"""
        try:
            await self.stability_manager.manage_connection(
                connection_id=f"kline_feed_{self.shard_id}",
                connect_func=self._stable_connect,
                disconnect_func=self._stable_disconnect,
                max_retries=8  # æ›´å¤šé‡è©¦æ¬¡æ•¸
            )
        except Exception as e:
            logger.error(f"âŒ KlineFeed å•Ÿå‹•å¤±æ•—: {e}")
    
    async def _stable_connect(self):
        """ç©©å®šçš„é€£æ¥æ–¹æ³•"""
        # ä½¿ç”¨æ›´ä¿å®ˆçš„ WebSocket åƒæ•¸
        self.ws = await websockets.connect(
            self.ws_url,
            ping_interval=15,      # æ¯15ç§’ç™¼é€ping
            ping_timeout=10,       # 10ç§’ç­‰å¾…pong
            close_timeout=10,
            max_size=2**20,       # 1MB ç·©è¡å€
            read_limit=2**18,     # 256KB è®€å–é™åˆ¶
            write_limit=2**18     # 256KB å¯«å…¥é™åˆ¶
        )
        self._is_connected = True
        return self.ws
    
    async def _stable_disconnect(self):
        """ç©©å®šçš„æ–·é–‹æ–¹æ³•"""
        self._is_connected = False
        if hasattr(self, 'ws') and self.ws:
            await self.ws.close()
    
    async def on_pong(self):
        """è™•ç† pong å›æ‡‰"""
        self.stability_manager.on_pong_received(f"kline_feed_{self.shard_id}")
```

ä¿®å¾©3: å¢å¼· PriceFeed ç©©å®šæ€§

```python
# src/core/websocket/stable_price_feed.py
class StablePriceFeed(PriceFeed):
    def __init__(self, config):
        super().__init__(config)
        self.stability_manager = WebSocketStabilityManager()
        
    async def start_stable(self):
        """å•Ÿå‹•ç©©å®šçš„ PriceFeed"""
        try:
            await self.stability_manager.manage_connection(
                connection_id=f"price_feed_{self.shard_id}",
                connect_func=self._stable_connect,
                disconnect_func=self._stable_disconnect,
                max_retries=8
            )
        except Exception as e:
            logger.error(f"âŒ PriceFeed å•Ÿå‹•å¤±æ•—: {e}")
    
    async def _stable_connect(self):
        """ç©©å®šçš„é€£æ¥æ–¹æ³•"""
        self.ws = await websockets.connect(
            self.ws_url,
            ping_interval=15,      # æ¯15ç§’ç™¼é€ping
            ping_timeout=10,       # 10ç§’ç­‰å¾…pong
            close_timeout=10,
            max_size=2**20,
            read_limit=2**18,
            write_limit=2**18
        )
        return self.ws
    
    async def _stable_disconnect(self):
        """ç©©å®šçš„æ–·é–‹æ–¹æ³•"""
        if hasattr(self, 'ws') and self.ws:
            await self.ws.close()
```

ä¿®å¾©4: çµ±ä¸€çš„ WebSocket å·¥å» 

```python
# src/core/websocket/websocket_factory.py
class WebSocketFactory:
    """WebSocket å·¥å»  - çµ±ä¸€å‰µå»ºç©©å®šçš„é€£æ¥"""
    
    @staticmethod
    async def create_stable_websocket(url: str, connection_id: str) -> WebSocket:
        """å‰µå»ºç©©å®šçš„ WebSocket é€£æ¥"""
        return await websockets.connect(
            url,
            ping_interval=15,
            ping_timeout=10,
            close_timeout=10,
            max_size=2**20,
            read_limit=2**18,
            write_limit=2**18,
            # æ·»åŠ ç”¨æˆ¶ä»£ç†æ¨™è­˜
            extra_headers={'User-Agent': 'SelfLearningTrader/3.0'},
            # å•Ÿç”¨å£“ç¸®
            compression=None
        )
    
    @staticmethod
    def get_optimized_websocket_params():
        """ç²å–å„ªåŒ–çš„ WebSocket åƒæ•¸"""
        return {
            'ping_interval': 15,
            'ping_timeout': 10, 
            'close_timeout': 10,
            'max_size': 1048576,  # 1MB
            'read_limit': 262144,  # 256KB
            'write_limit': 262144  # 256KB
        }
```

ä¿®å¾©5: æ›´æ–°ä¸»èª¿åº¦å™¨ä½¿ç”¨ç©©å®šç‰ˆæœ¬

```python
# src/core/stable_unified_scheduler.py
class StableUnifiedScheduler(UnifiedScheduler):
    def __init__(self, config):
        super().__init__(config)
        self.websocket_managers = []
        
    async def start_stable(self):
        """å•Ÿå‹•ç©©å®šçš„èª¿åº¦å™¨"""
        logger.info("ğŸš€ å•Ÿå‹•ç©©å®šçš„äº¤æ˜“ç³»çµ±...")
        
        try:
            # åˆå§‹åŒ–ç©©å®šçš„ WebSocket é€£æ¥
            await self._initialize_stable_websockets()
            
            # å•Ÿå‹•ç©©å®šçš„äº¤æ˜“å¾ªç’°
            await self._start_stable_trading_cycle()
            
        except Exception as e:
            logger.error(f"âŒ ç©©å®šç³»çµ±å•Ÿå‹•å¤±æ•—: {e}")
            await self._graceful_shutdown()
    
    async def _initialize_stable_websockets(self):
        """åˆå§‹åŒ–ç©©å®šçš„ WebSocket é€£æ¥"""
        # ä½¿ç”¨ç©©å®šçš„ KlineFeed
        self.kline_feed = StableKlineFeed(self.config)
        self.price_feed = StablePriceFeed(self.config)
        
        # å•Ÿå‹•é€£æ¥
        kline_task = asyncio.create_task(self.kline_feed.start_stable())
        price_task = asyncio.create_task(self.price_feed.start_stable())
        
        self.websocket_managers.extend([kline_task, price_task])
        
        # ç­‰å¾…é€£æ¥å»ºç«‹
        await asyncio.sleep(5)
        logger.info("âœ… ç©©å®š WebSocket é€£æ¥åˆå§‹åŒ–å®Œæˆ")
    
    async def _graceful_shutdown(self):
        """å„ªé›…é—œé–‰"""
        logger.info("ğŸ›‘ é–‹å§‹å„ªé›…é—œé–‰...")
        
        # é—œé–‰ WebSocket ç®¡ç†å™¨
        for manager in [self.kline_feed, self.price_feed]:
            if hasattr(manager, 'stability_manager'):
                await manager.stability_manager.shutdown()
        
        logger.info("âœ… ç³»çµ±é—œé–‰å®Œæˆ")
```

ğŸš€ ç«‹å³éƒ¨ç½²æ­¥é©Ÿ

æ­¥é©Ÿ1: å‰µå»ºç©©å®šæ€§çµ„ä»¶

```bash
# å‰µå»ºç©©å®šæ€§çµ„ä»¶ç›®éŒ„
mkdir -p src/core/websocket/stability/

# å‰µå»ºç©©å®šæ€§ç®¡ç†å™¨
cat > src/core/websocket/stability_manager.py << 'EOF'
# [ä¸Šé¢ WebSocketStabilityManager çš„å®Œæ•´ä»£ç¢¼]
EOF

# å‰µå»ºç©©å®šçš„ KlineFeed
cat > src/core/websocket/stable_kline_feed.py << 'EOF'
# [ä¸Šé¢ StableKlineFeed çš„å®Œæ•´ä»£ç¢¼]
EOF

# å‰µå»ºç©©å®šçš„ PriceFeed  
cat > src/core/websocket/stable_price_feed.py << 'EOF'
# [ä¸Šé¢ StablePriceFeed çš„å®Œæ•´ä»£ç¢¼]
EOF

# å‰µå»º WebSocket å·¥å» 
cat > src/core/websocket/websocket_factory.py << 'EOF'
# [ä¸Šé¢ WebSocketFactory çš„å®Œæ•´ä»£ç¢¼]
EOF
```

æ­¥é©Ÿ2: æ›´æ–°ä¸»å•Ÿå‹•æ–‡ä»¶

```python
# main_stable.py
import asyncio
import logging
from src.core.stable_unified_scheduler import StableUnifiedScheduler

async def main():
    """ç©©å®šçš„ä¸»å•Ÿå‹•å‡½æ•¸"""
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    
    scheduler = StableUnifiedScheduler()
    
    try:
        await scheduler.start_stable()
    except KeyboardInterrupt:
        print("ğŸ›‘ æ‰‹å‹•åœæ­¢ç³»çµ±")
    except Exception as e:
        print(f"âŒ ç³»çµ±éŒ¯èª¤: {e}")
    finally:
        await scheduler._graceful_shutdown()

if __name__ == "__main__":
    asyncio.run(main())
```

æ­¥é©Ÿ3: éƒ¨ç½²ä¿®å¾©

```bash
# æäº¤æ‰€æœ‰ç©©å®šæ€§ä¿®å¾©
git add .
git commit -m "fix: å…¨é¢ä¿®å¾©WebSocketç©©å®šæ€§å•é¡Œ + è‡ªå‹•é‡é€£æ©Ÿåˆ¶"
git push origin main

# ç›£æ§ä¿®å¾©æ•ˆæœ
railway logs --follow | grep -E "WebSocket|ç©©å®šæ€§|âœ…|âŒ|keepalive"
```

ğŸ“Š é æœŸä¿®å¾©æ•ˆæœ

ä¿®å¾©å‰:

```
âŒ KlineFeed-Shard2 æ¥æ”¶å¤±æ•—: sent 1011 (internal error) keepalive ping timeout
âŒ PriceFeed-Shard1 æ¥æ”¶å¤±æ•—: sent 1011 (internal error) keepalive ping timeout
```

ä¿®å¾©å¾Œ:

```
ğŸ”„ å»ºç«‹ WebSocket é€£æ¥: kline_feed_shard2 (å˜—è©¦ 1/8)
âœ… WebSocket é€£æ¥æˆåŠŸ: kline_feed_shard2
âœ… æ”¶åˆ° pong: kline_feed_shard2
âš ï¸ é€£æ¥æ´»æ€§æª¢æŸ¥å¤±æ•—: kline_feed_shard2 - è‡ªå‹•é‡é€£ä¸­...
ğŸ”„ å»ºç«‹ WebSocket é€£æ¥: kline_feed_shard2 (å˜—è©¦ 2/8)
âœ… WebSocket é€£æ¥æˆåŠŸ: kline_feed_shard2
```

ğŸ¯ ç›£æ§é‡é»

éƒ¨ç½²å¾Œæª¢æŸ¥ä»¥ä¸‹æ—¥èªŒæ¨¡å¼ï¼š

Â· âœ… "WebSocket é€£æ¥æˆåŠŸ"
Â· âœ… "æ”¶åˆ° pong"
Â· ğŸ”„ "è‡ªå‹•é‡é€£ä¸­"ï¼ˆæ­£å¸¸çš„é‡é€£è¡Œç‚ºï¼‰
Â· âŒ ä¸å†å‡ºç¾ "keepalive ping timeout"

ç«‹å³åŸ·è¡Œé€™å€‹å…¨é¢ä¿®å¾©æ–¹æ¡ˆï¼Œé€™å°‡å¾¹åº•è§£æ±º WebSocket é€£æ¥ç©©å®šæ€§å•é¡Œï¼ğŸš€