æ—¥å¿—æ˜¾ç¤ºï¼š

text
Stage1é©—è­‰: æœ‰æ•ˆ=489, æ‹’çµ•=72660
Stage3æ–¹å‘: æœ‰=417, ç„¡=72
é—®é¢˜æ‰¾åˆ°äº†ï¼ ç³»ç»Ÿå®é™…ä¸Šåœ¨é‡å¤æ‰«æç›¸åŒçš„äº¤æ˜“å¯¹ï¼ˆæ‰«æäº†73650æ¬¡ï¼ï¼‰ï¼Œè€Œä¸æ˜¯æ‰«æ530ä¸ªäº¤æ˜“å¯¹ã€‚è¿™å¯¼è‡´ç»Ÿè®¡ä¿¡æ¯æ··ä¹±ï¼Œå¹³å‡åˆ†ææ—¶é—´è®¡ç®—é”™è¯¯ã€‚

ğŸš¨ æ ¹æœ¬åŸå› 
é—®é¢˜ï¼šPipelineè¿›åº¦è®¡æ•°å™¨_pipeline_statsæ²¡æœ‰è¢«é‡ç½®ï¼Œæ¯æ¬¡æ‰«æéƒ½åœ¨ç´¯åŠ ï¼Œå¯¼è‡´ï¼š

æ‰«æè®¡æ•°ä»73150å¼€å§‹ï¼Œè€Œä¸æ˜¯0

ç»Ÿè®¡ä¿¡æ¯å®Œå…¨é”™è¯¯

å¹³å‡æ—¶é—´è®¡ç®—ä¸º0.0ms

ğŸ”§ ç«‹å³ä¿®å¤æ–¹æ¡ˆ
æ­¥éª¤1ï¼šä¿®å¤Pipelineç»Ÿè®¡è®¡æ•°å™¨
åœ¨rule_based_signal_generator.pyçš„generate_signalæ–¹æ³•å¼€å¤´æ·»åŠ è®¡æ•°å™¨é‡ç½®ï¼š

python
def generate_signal(self, symbol, klines_data, market_structure="NEUTRAL"):
    # ğŸ”§ ä¿®å¤ï¼šæ¯æ¬¡è°ƒç”¨æ—¶é‡ç½®ç»Ÿè®¡è®¡æ•°å™¨
    self._pipeline_stats = {
        'stage1_rejected_data': 0,
        'stage1_rejected_adx': 0, 
        'stage2_rejected_quality': 0,
        'stage3_no_direction': 0,
        'stage3_has_direction': 0,
        'total_processed': 0
    }
    
    # åŸæœ‰çš„é€»è¾‘...
æ­¥éª¤2ï¼šä¿®å¤æ‰«ææ—¶é—´è®¡ç®—
åœ¨unified_scheduler.pyçš„scan_symbolsæ–¹æ³•ä¸­ä¿®å¤æ—¶é—´è®¡ç®—ï¼š

python
def scan_symbols(self):
    import time
    signal_candidates = []
    analyzed_count = 0
    skip_count = 0
    
    # ğŸ”§ ä¿®å¤ï¼šæ­£ç¡®çš„æ—¶é—´ç»Ÿè®¡å˜é‡
    total_analysis_time = 0.0
    analysis_times = []
    
    logger.info("ğŸ“Š å¼€å§‹æ‰«æ (ä¿®å¤ç‰ˆæœ¬)")
    
    for i, symbol in enumerate(self.symbols):
        symbol_start_time = time.time()
        
        # æ•°æ®è·å–
        multi_tf_data = self.data_service.get_multi_timeframe_klines(symbol, self.timeframes)
        if not multi_tf_data:
            skip_count += 1
            continue
            
        # åˆ†æ
        analysis_start = time.time()
        signal, confidence, win_prob = self.self_learning_trader.analyze(symbol, multi_tf_data)
        analysis_time = time.time() - analysis_start
        
        # ğŸ”§ ä¿®å¤ï¼šæ­£ç¡®ç´¯åŠ æ—¶é—´
        total_analysis_time += analysis_time
        analysis_times.append(analysis_time)
        analyzed_count += 1
        
        signal_candidates.append({
            'symbol': symbol, 'confidence': confidence, 
            'win_probability': win_prob, 'has_signal': signal is not None
        })
        
        # æ¯50ä¸ªç¬¦å·è¾“å‡ºçœŸå®è¿›åº¦
        if analyzed_count % 50 == 0:
            real_avg_time = total_analysis_time / analyzed_count
            logger.info(f"ğŸ“Š çœŸå®è¿›åº¦: {analyzed_count}/530 | å¹³å‡åˆ†æ: {real_avg_time*1000:.1f}ms")
    
    # ğŸ”§ ä¿®å¤ï¼šæ­£ç¡®çš„æœ€ç»ˆæ—¶é—´æŠ¥å‘Š
    if analyzed_count > 0:
        real_avg_ms = (total_analysis_time / analyzed_count) * 1000
        min_time = min(analysis_times) * 1000 if analysis_times else 0
        max_time = max(analysis_times) * 1000 if analysis_times else 0
        
        logger.info("â±ï¸ ===== çœŸå®æ—¶é—´æŠ¥å‘Š =====")
        logger.info(f"ğŸ“Š åˆ†æäº¤æ˜“å¯¹: {analyzed_count}/530")
        logger.info(f"ğŸ“­ æ•°æ®ç¼ºå¤±è·³è¿‡: {skip_count}")
        logger.info(f"ğŸ“ˆ å¹³å‡åˆ†ææ—¶é—´: {real_avg_ms:.1f}ms")
        logger.info(f"ğŸš€ æœ€å¿«åˆ†æ: {min_time:.1f}ms")
        logger.info(f"ğŸŒ æœ€æ…¢åˆ†æ: {max_time:.1f}ms")
        logger.info(f"â±ï¸ æ€»åˆ†ææ—¶é—´: {total_analysis_time:.1f}s")
        
        # åˆ¤æ–­åˆç†æ€§
        if real_avg_ms < 10:
            logger.warning(f"âš ï¸ åˆ†ææ—¶é—´åçŸ­: {real_avg_ms:.1f}ms")
        elif real_avg_ms > 200:
            logger.warning(f"âš ï¸ åˆ†ææ—¶é—´åé•¿: {real_avg_ms:.1f}ms")
        else:
            logger.info(f"âœ… åˆ†ææ—¶é—´åˆç†: {real_avg_ms:.1f}ms")
    
    return signal_candidates
æ­¥éª¤3ï¼šæ·»åŠ è¯¦ç»†çš„ä¿¡å·ç”Ÿæˆè¯Šæ–­
åœ¨rule_based_signal_generator.pyä¸­æ·»åŠ è¯¦ç»†è¯Šæ–­ï¼š

python
def generate_signal(self, symbol, klines_data, market_structure="NEUTRAL"):
    # ğŸ”§ ä¿®å¤ï¼šé‡ç½®ç»Ÿè®¡è®¡æ•°å™¨
    self._reset_pipeline_stats()
    
    logger.debug(f"ğŸ” å¼€å§‹åˆ†æ {symbol}")
    
    try:
        # åŸæœ‰çš„éªŒè¯é€»è¾‘...
        if not self._validate_klines_data(klines_data):
            self._pipeline_stats['stage1_rejected_data'] += 1
            logger.debug(f"âŒ {symbol}: æ•°æ®éªŒè¯å¤±è´¥")
            return None, 0.0, 0.0
        
        # æå–æ•°æ®...
        h1_data = klines_data.get('1h')
        m15_data = klines_data.get('15m') 
        m5_data = klines_data.get('5m')
        
        if h1_data is None or m15_data is None or m5_data is None:
            logger.debug(f"âŒ {symbol}: å…³é”®æ—¶é—´æ¡†æ¶ç¼ºå¤±")
            return None, 0.0, 0.0
        
        # æ–¹å‘åˆ¤æ–­...
        direction = self._determine_signal_direction(h1_data, m15_data, m5_data)
        if direction is None:
            self._pipeline_stats['stage3_no_direction'] += 1
            logger.debug(f"â¸ï¸ {symbol}: æ— æ–¹å‘")
            return None, 0.0, 0.0
        else:
            self._pipeline_stats['stage3_has_direction'] += 1
        
        # ğŸ”§ ä¿®å¤ï¼šæ·»åŠ è¯¦ç»†çš„ç‰¹å¾è®¡ç®—è¯Šæ–­
        logger.debug(f"ğŸ¯ {symbol}: æ–¹å‘={direction}")
        
        if self.use_pure_ict:
            return self._process_pure_ict_mode(symbol, klines_data, direction, market_structure)
        else:
            return self._process_traditional_mode(symbol, klines_data, direction, market_structure)
            
    except Exception as e:
        logger.error(f"âŒ {symbol} åˆ†æå¼‚å¸¸: {e}")
        return None, 0.0, 0.0

def _reset_pipeline_stats(self):
    """é‡ç½®Pipelineç»Ÿè®¡è®¡æ•°å™¨"""
    self._pipeline_stats = {
        'stage1_rejected_data': 0,
        'stage1_rejected_adx': 0,
        'stage2_rejected_quality': 0, 
        'stage3_no_direction': 0,
        'stage3_has_direction': 0,
        'total_processed': 0
    }

def _process_pure_ict_mode(self, symbol, klines_data, direction, market_structure):
    """å¤„ç†çº¯ICTæ¨¡å¼ï¼ˆå¸¦è¯Šæ–­ï¼‰"""
    logger.debug(f"ğŸ”§ {symbol}: çº¯ICTæ¨¡å¼")
    
    if self.feature_engine is None:
        logger.error(f"ğŸš¨ {symbol}: FeatureEngineä¸ºNone")
        return None, 0.0, 0.0
    
    try:
        # æ„å»ºICTç‰¹å¾
        ict_features = self.feature_engine._build_ict_smc_features(
            signal={'symbol': symbol, 'direction': direction},
            klines_data=klines_data
        )
        
        if not ict_features:
            logger.warning(f"âš ï¸ {symbol}: ICTç‰¹å¾ä¸ºç©º")
            return None, 0.0, 0.0
        
        # è®¡ç®—å½“å‰ä»·æ ¼
        current_price = klines_data['1h'].iloc[-1]['close']
        
        # è·å–è®¢å•å—
        order_blocks = self._identify_order_blocks(klines_data['1h'], klines_data['15m'], direction)
        
        # è®¡ç®—ä¿¡å¿ƒå€¼
        confidence_score, sub_scores = self._calculate_confidence_pure_ict(
            ict_features, direction, market_structure, order_blocks, current_price
        )
        
        # è®¡ç®—èƒœç‡
        win_probability = self._calculate_win_probability_pure_ict(
            confidence_score, ict_features, direction, order_blocks, current_price
        )
        
        logger.debug(f"ğŸ“Š {symbol}: ä¿¡å¿ƒ={confidence_score:.1f}, èƒœç‡={win_probability:.1%}")
        
        # æ£€æŸ¥é˜ˆå€¼
        if confidence_score >= self.min_confidence and win_probability >= self.min_win_rate:
            signal = self._build_signal_dict(
                symbol, direction, confidence_score, win_probability,
                market_structure, order_blocks, ict_features
            )
            return signal, confidence_score, win_probability * 100
        else:
            logger.debug(f"â¸ï¸ {symbol}: æœªè¾¾é˜ˆå€¼ (ä¿¡å¿ƒ={confidence_score:.1f}<{self.min_confidence}, èƒœç‡={win_probability:.1%}<{self.min_win_rate})")
            return None, confidence_score, win_probability * 100
            
    except Exception as e:
        logger.error(f"âŒ {symbol} ICTå¤„ç†å¤±è´¥: {e}")
        return None, 0.0, 0.0
ğŸ¯ ç«‹å³éƒ¨ç½²ä¿®å¤
è¿™ä¸ªä¿®å¤å°†è§£å†³ï¼š

âœ… è®¡æ•°å™¨é‡ç½®é—®é¢˜ - é˜²æ­¢é‡å¤ç´¯åŠ 

âœ… æ—¶é—´è®¡ç®—é”™è¯¯ - æ­£ç¡®è®¡ç®—å¹³å‡åˆ†ææ—¶é—´

âœ… ç»Ÿè®¡ä¿¡æ¯æ··ä¹± - æ˜¾ç¤ºçœŸå®çš„æ‰«æè¿›åº¦

âœ… è¯Šæ–­ä¿¡æ¯ä¸å‡†ç¡® - æä¾›å‡†ç¡®çš„è°ƒè¯•ä¿¡æ¯

ğŸ“Š é¢„æœŸä¿®å¤ç»“æœ
ä¿®å¤ååº”è¯¥çœ‹åˆ°ï¼š

text
ğŸ“Š çœŸå®è¿›åº¦: 50/530 | å¹³å‡åˆ†æ: 45.2ms
ğŸ“Š çœŸå®è¿›åº¦: 100/530 | å¹³å‡åˆ†æ: 42.8ms
...
â±ï¸ ===== çœŸå®æ—¶é—´æŠ¥å‘Š =====
ğŸ“Š åˆ†æäº¤æ˜“å¯¹: 530/530
ğŸ“ˆ å¹³å‡åˆ†ææ—¶é—´: 43.5ms
ğŸš€ æœ€å¿«åˆ†æ: 12.3ms
ğŸŒ æœ€æ…¢åˆ†æ: 156.7ms
âœ… åˆ†ææ—¶é—´åˆç†: 43.5ms
è¯·ç«‹å³éƒ¨ç½²è¿™ä¸ªè®¡æ•°å™¨ä¿®å¤æ–¹æ¡ˆï¼è¿™å°†è§£å†³ç»Ÿè®¡é”™è¯¯é—®é¢˜ï¼Œè®©æˆ‘ä»¬çœ‹åˆ°çœŸå®çš„åˆ†ææ€§èƒ½ã€‚

