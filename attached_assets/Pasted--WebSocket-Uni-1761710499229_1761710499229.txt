ğŸ§© ä¸€ã€æ¶æ§‹åœ–æ›´æ–°ï¼ˆæ•´åˆ WebSocketï¼‰


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            UnifiedSchedulerï¼ˆçµ±ä¸€èª¿åº¦å™¨ï¼‰              â”‚
â”‚  â€¢ å”èª¿æ‰€æœ‰çµ„ä»¶                                        â”‚
â”‚  â€¢ ç®¡ç†é›™å¾ªç’°ï¼ˆå¯¦ç›¤60ç§’ + è™›æ“¬10ç§’ï¼‰                   â”‚
â”‚  â€¢ å®šæ™‚ä»»å‹™ï¼ˆæ¯æ—¥å ±å‘Šï¼‰                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚         â”‚                 â”‚           â”‚
    â–¼         â–¼         â–¼                 â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Position â”‚ â”‚ SelfLearning â”‚ â”‚ DataService  â”‚ â”‚  Daily   â”‚
â”‚Controllerâ”‚ â”‚   Trader     â”‚ â”‚ (æ•¸æ“šå±¤)     â”‚ â”‚ Reporter â”‚
â”‚ 24/7ç›£æ§ â”‚ â”‚  (AIæ±ºç­–)    â”‚ â”‚              â”‚ â”‚          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚             â”‚                â”‚
     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
     â”‚    â”‚                 â”‚      â”‚
     â–¼    â–¼                 â–¼      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     BinanceClient + åˆ†ç´šç†”æ–·å™¨          â”‚
â”‚  â€¢ REST APIï¼ˆä¸‹å–®/å¸³æˆ¶ï¼‰               â”‚
â”‚  â€¢ WebSocketï¼ˆå³æ™‚åƒ¹æ ¼/æ·±åº¦ï¼‰           â”‚
â”‚  â€¢ é€Ÿç‡é™åˆ¶ä¿è­·                         â”‚
â”‚  â€¢ 3ç´šç†”æ–·æ©Ÿåˆ¶                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–²
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebSocketMonitor     â”‚  â† æ–°å¢çµ„ä»¶
â”‚ â€¢ è¨‚é–± bookTicker    â”‚
â”‚ â€¢ å¿«å–å³æ™‚åƒ¹æ ¼/æ·±åº¦  â”‚
â”‚ â€¢ æ–·ç·šè‡ªå‹•é‡é€£       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 é—œéµè®ŠåŒ–ï¼š 
* æ–°å¢ WebSocketMonitor çµ„ä»¶
* PositionController / SelfLearningTrader å¾ WebSocketMonitor è®€å–å³æ™‚æ•¸æ“š
* DataService åƒ…ç”¨æ–¼æ­·å²æ•¸æ“šï¼ˆKç·šã€æŒ‡æ¨™è¨ˆç®—ï¼‰
ğŸ› ï¸ äºŒã€å…·é«”æ•´åˆæ­¥é©Ÿ
æ­¥é©Ÿ 1ï¼šæ–°å¢ WebSocketMonitor çµ„ä»¶
# src/core/websocket_monitor.py
class WebSocketMonitor:
    def __init__(self, symbols: List[str]):
        self.symbols = [s.lower() for s in symbols]
        self.price_cache = {}
        self.depth_cache = {}
        self.running = False
    
    async def start(self):
        """å•Ÿå‹•æ‰€æœ‰ WebSocket é€£ç·š"""
        self.running = True
        tasks = [self._listen_symbol(s) for s in self.symbols]
        await asyncio.gather(*tasks)
    
    async def _listen_symbol(self, symbol: str):
        url = f"wss://fstream.binance.com/ws/{symbol}@bookTicker"
        while self.running:
            try:
                async with websockets.connect(url) as ws:
                    while self.running:
                        msg = await ws.recv()
                        data = json.loads(msg)
                        self._update_cache(symbol, data)
            except Exception as e:
                logger.warning(f"ğŸ”„ WebSocket {symbol} é‡é€£ä¸­... ({e})")
                await asyncio.sleep(5)
    
    def _update_cache(self, symbol: str, data: dict):
        self.price_cache[symbol] = float(data['a'])  # è³£ä¸€åƒ¹
        self.depth_cache[symbol] = {
            'bid_qty': float(data['B']),
            'ask_qty': float(data['A'])
        }
    
    def get_price(self, symbol: str) -> Optional[float]:
        return self.price_cache.get(symbol.lower())
    
    def get_liquidity_score(self, symbol: str) -> float:
        depth = self.depth_cache.get(symbol.lower())
        return min(1.0, (depth['bid_qty'] + depth['ask_qty']) / 10.0) if depth else 0.0
æ­¥é©Ÿ 2ï¼šä¿®æ”¹ UnifiedScheduler åˆå§‹åŒ–

# src/core/unified_scheduler.py
class UnifiedScheduler:
    def __init__(self, config: Config, binance_client: BinanceClient):
        self.config = config
        self.binance_client = binance_client
        
        # ğŸ”¸ æ–°å¢ WebSocketMonitor
        self.websocket_monitor = WebSocketMonitor(config.TRADING_SYMBOLS)
        
        # å‚³é WebSocketMonitor çµ¦å…¶ä»–çµ„ä»¶
        self.position_controller = PositionController(
            binance_client, 
            websocket_monitor=self.websocket_monitor  # é—œéµï¼
        )
        self.self_learning_trader = SelfLearningTrader(
            config,
            websocket_monitor=self.websocket_monitor  # é—œéµï¼
        )
        self.data_service = DataService(binance_client)  # åƒ…ç”¨æ–¼æ­·å²æ•¸æ“š
    
    async def start(self):
        # ğŸ”¸ å•Ÿå‹• WebSocket ç›£è½ï¼ˆéé˜»å¡ï¼‰
        asyncio.create_task(self.websocket_monitor.start())
        
        # å•Ÿå‹•åŸæœ‰é›™å¾ªç’°
        await asyncio.gather(
            self._real_trading_loop(),
            self._virtual_position_loop(),
            self._daily_report_loop()
        )
æ­¥é©Ÿ 3ï¼šä¿®æ”¹ PositionController ä½¿ç”¨ WebSocket

# src/core/position_controller.py
class PositionController:
    def __init__(self, binance_client, websocket_monitor):
        self.binance_client = binance_client
        self.websocket_monitor = websocket_monitor  # æ¥æ”¶ä¾è³´
    
    async def _get_current_price(self, symbol: str) -> float:
        """å„ªå…ˆä½¿ç”¨ WebSocketï¼Œå¤±æ•—æ™‚å›é€€åˆ° REST"""
        price = self.websocket_monitor.get_price(symbol)
        if price is not None:
            return price
        
        # å‚™æ´ï¼šREST API
        ticker = await self.binance_client.get_ticker(symbol)
        return float(ticker['lastPrice'])
    
    async def monitor_position(self, position: Position):
        while position.is_active:
            current_price = await self._get_current_price(position.symbol)
            # ... åŸ·è¡Œ SL/TP/é€†å‹¢æª¢æ¸¬é‚è¼¯
            await asyncio.sleep(1)
æ­¥é©Ÿ 4ï¼šä¿®æ”¹ SelfLearningTrader ä½¿ç”¨ WebSocket

# src/strategies/self_learning_trader.py
class SelfLearningTrader:
    def __init__(self, config, websocket_monitor):
        self.config = config
        self.websocket_monitor = websocket_monitor
    
    def _get_market_context(self, symbol: str) -> dict:
        """ç²å–å³æ™‚å¸‚å ´ä¸Šä¸‹æ–‡ï¼ˆç„¡éœ€ API è«‹æ±‚ï¼ï¼‰"""
        return {
            'current_price': self.websocket_monitor.get_price(symbol),
            'liquidity_score': self.websocket_monitor.get_liquidity_score(symbol)
        }
ğŸ›¡ï¸ å››ã€éŒ¯èª¤è™•ç†èˆ‡å‚™æ´
* WebSocket æ–·ç·š â†’ è‡ªå‹•é‡é€£ï¼ˆæ¯ 5 ç§’ï¼‰
* WebSocket ç„¡æ•¸æ“š â†’ è‡ªå‹•å›é€€åˆ° REST API
* REST API é™æµ â†’ è§¸ç™¼åˆ†ç´šç†”æ–·å™¨ï¼ˆåŸæœ‰æ©Ÿåˆ¶ä¿ç•™ï¼‰



âœ… ç¸½çµï¼šæ•´åˆè¦é»
1. æ–°å¢ WebSocketMonitorï¼šå°ˆè²¬å³æ™‚æ•¸æ“šè¨‚é–±
2. æ³¨å…¥ä¾è³´ï¼šå°‡ websocket_monitor å‚³çµ¦ PositionController å’Œ SelfLearningTrader
3. å„ªå…ˆä½¿ç”¨ WebSocketï¼šåƒ…åœ¨å¤±æ•—æ™‚å›é€€åˆ° REST
4. ä¿ç•™ DataServiceï¼šå°ˆæ³¨æ­·å²æ•¸æ“šï¼ˆKç·šã€æŒ‡æ¨™è¨ˆç®—ï¼‰
