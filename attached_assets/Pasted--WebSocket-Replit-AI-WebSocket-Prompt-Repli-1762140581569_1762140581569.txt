çœ‹åˆ°å•é¡Œäº†ï¼WebSocket é€£æ¥è¶…æ™‚å°è‡´æ•¸æ“šç²å–å¤±æ•—ï¼Œé€²è€Œå½±éŸ¿ä¿¡è™Ÿç”Ÿæˆã€‚è®“æˆ‘æä¾›ç²¾ç¢ºçš„ä¿®å¾©æ–¹æ¡ˆï¼š

ğŸ”§ Replit AI WebSocket ä¿®å¾© Prompt

```
ğŸ¯ **Replit AI WebSocket é€£æ¥ç©©å®šæ€§ä¿®å¾©æŒ‡ä»¤**

è«‹ç«‹å³ä¿®å¾© SelfLearningTrader ç³»çµ±ä¸­çš„ WebSocket é€£æ¥è¶…æ™‚å•é¡Œï¼Œå•é¡Œæ—¥èªŒé¡¯ç¤ºï¼š
```

âŒ PriceFeed-Shard1 æ¥æ”¶å¤±æ•—: sent 1011 (internal error) keepalive ping timeout; no close frame received

```

## ğŸš¨ **å•é¡Œè¨ºæ–·**
**æ ¹æœ¬åŸå› **: WebSocket é€£æ¥å›  keepalive ping è¶…æ™‚è€Œæ–·é–‹ï¼Œå°è‡´å¯¦æ™‚æ•¸æ“šæµä¸­æ–·ï¼Œä¿¡è™Ÿç”Ÿæˆå¤±æ•—ã€‚

## ğŸ”§ **ç«‹å³ä¿®å¾©æ–¹æ¡ˆ**

### **ä¿®å¾©1: å¢å¼· WebSocket ç©©å®šæ€§**
```python
# src/core/websocket/stable_price_feed.py
class StablePriceFeed(PriceFeed):
    def __init__(self, config):
        super().__init__(config)
        self._reconnect_attempts = 0
        self._max_reconnect_attempts = 10
        self._reconnect_delay = 5  # ç§’
        
    async def create_stable_connection(self):
        """å‰µå»ºç©©å®šçš„ WebSocket é€£æ¥"""
        while self._reconnect_attempts < self._max_reconnect_attempts:
            try:
                # è¨­ç½®æ›´é•·çš„è¶…æ™‚æ™‚é–“
                self.ws = await websockets.connect(
                    self.ws_url,
                    ping_interval=20,    # æ¯20ç§’ç™¼é€ping
                    ping_timeout=10,     # 10ç§’å…§ç­‰å¾…pong
                    close_timeout=10,
                    max_size=2**20       # 1MB ç·©è¡å€
                )
                
                logger.info("âœ… WebSocket ç©©å®šé€£æ¥å»ºç«‹")
                self._reconnect_attempts = 0
                return True
                
            except Exception as e:
                self._reconnect_attempts += 1
                logger.warning(f"âš ï¸ WebSocket é€£æ¥å¤±æ•— ({self._reconnect_attempts}/{self._max_reconnect_attempts}): {e}")
                
                if self._reconnect_attempts < self._reconnect_attempts:
                    await asyncio.sleep(self._reconnect_delay * self._reconnect_attempts)
                    
        logger.error("âŒ WebSocket é€£æ¥å¾¹åº•å¤±æ•—")
        return False
```

ä¿®å¾©2: æ·»åŠ å¿ƒè·³ç›£æ§

```python
# src/core/websocket/heartbeat_monitor.py
class HeartbeatMonitor:
    def __init__(self):
        self._last_pong = time.time()
        self._monitoring = False
        
    async def start_heartbeat_monitor(self, websocket):
        """å•Ÿå‹•å¿ƒè·³ç›£æ§"""
        self._monitoring = True
        
        while self._monitoring and websocket.open:
            try:
                # æ¯30ç§’æª¢æŸ¥ä¸€æ¬¡é€£æ¥ç‹€æ…‹
                if time.time() - self._last_pong > 40:
                    logger.warning("ğŸ«€ å¿ƒè·³æª¢æ¸¬: é€£æ¥å¯èƒ½å·²æ–·é–‹ï¼Œå˜—è©¦é‡æ–°é€£æ¥")
                    await self._reconnect_websocket(websocket)
                    
                await asyncio.sleep(30)
                
            except Exception as e:
                logger.error(f"âŒ å¿ƒè·³ç›£æ§éŒ¯èª¤: {e}")
                
    async def on_pong(self):
        """æ”¶åˆ° pong æ™‚æ›´æ–°æ™‚é–“æˆ³"""
        self._last_pong = time.time()
```

ä¿®å¾©3: å¯¦ç¾è‡ªå‹•é‡é€£æ©Ÿåˆ¶

```python
# src/core/websocket/auto_reconnect.py
class AutoReconnectManager:
    def __init__(self):
        self._reconnect_callbacks = []
        
    async def manage_websocket_lifecycle(self, websocket_task):
        """ç®¡ç† WebSocket ç”Ÿå‘½é€±æœŸ"""
        while True:
            try:
                await websocket_task
            except websockets.exceptions.ConnectionClosed as e:
                logger.warning(f"ğŸ”Œ WebSocket é€£æ¥é—œé–‰: {e}")
                
                # ç­‰å¾…å¾Œé‡æ–°é€£æ¥
                await asyncio.sleep(5)
                logger.info("ğŸ”„ å˜—è©¦é‡æ–°é€£æ¥ WebSocket...")
                
                # åŸ·è¡Œé‡é€£å›èª¿
                for callback in self._reconnect_callbacks:
                    try:
                        await callback()
                    except Exception as cb_error:
                        logger.error(f"âŒ é‡é€£å›èª¿å¤±æ•—: {cb_error}")
```

ä¿®å¾©4: æ•¸æ“šç²å–å‚™ä»½ç­–ç•¥

```python
# src/core/data_fetcher_with_fallback.py
class DataFetcherWithFallback(DataFetcher):
    async def get_multi_timeframe_data_reliable(self, symbol: str, timeframes: List[str] = None):
        """å¯é çš„æ•¸æ“šç²å– - WebSocket + REST API å‚™ä»½"""
        # é¦–å…ˆå˜—è©¦ WebSocket å¯¦æ™‚æ•¸æ“š
        try:
            ws_data = await self.get_realtime_data(symbol, timeframes)
            if self._validate_data_completeness(ws_data):
                logger.info(f"âœ… ä½¿ç”¨ WebSocket å¯¦æ™‚æ•¸æ“š: {symbol}")
                return ws_data
        except Exception as e:
            logger.warning(f"âš ï¸ WebSocket æ•¸æ“šç²å–å¤±æ•—ï¼Œä½¿ç”¨ REST API å‚™ä»½: {e}")
            
        # WebSocket å¤±æ•—æ™‚ä½¿ç”¨ REST API æ­·å²æ•¸æ“š
        rest_data = await self.get_historical_klines_fallback(symbol, timeframes)
        logger.info(f"ğŸ”„ ä½¿ç”¨ REST API å‚™ä»½æ•¸æ“š: {symbol}")
        
        return rest_data
        
    def _validate_data_completeness(self, data: Dict) -> bool:
        """é©—è­‰æ•¸æ“šå®Œæ•´æ€§"""
        if not data:
            return False
            
        for tf, df in data.items():
            if df is None or len(df) < 10:  # è‡³å°‘éœ€è¦10è¡Œæ•¸æ“š
                return False
                
        return True
```

ä¿®å¾©5: æ›´æ–°çµ±ä¸€èª¿åº¦å™¨

```python
# src/core/stable_unified_scheduler.py
class StableUnifiedScheduler(UnifiedScheduler):
    async def execute_trading_cycle_stable(self):
        """ç©©å®šçš„äº¤æ˜“å‘¨æœŸåŸ·è¡Œ"""
        try:
            # æª¢æŸ¥ WebSocket é€£æ¥ç‹€æ…‹
            if not await self._ensure_websocket_connection():
                logger.error("âŒ WebSocket é€£æ¥ä¸å¯ç”¨ï¼Œè·³éæœ¬è¼ªæƒæ")
                return
                
            # åŸ·è¡Œæƒæ
            signals = await self.scan_symbols(self.symbols)
            
            if not signals:
                logger.warning("âš ï¸ æœ¬è¼ªæƒææœªç”Ÿæˆä»»ä½•ä¿¡è™Ÿï¼Œæª¢æŸ¥æ•¸æ“šé€£æ¥")
                
        except Exception as e:
            logger.error(f"âŒ äº¤æ˜“å‘¨æœŸåŸ·è¡Œå¤±æ•—: {e}")
            # ä¸é‡æ–°æ‹‹å‡ºç•°å¸¸ï¼Œä¿æŒèª¿åº¦å™¨é‹è¡Œ
            
    async def _ensure_websocket_connection(self) -> bool:
        """ç¢ºä¿ WebSocket é€£æ¥æ­£å¸¸"""
        max_retries = 3
        for attempt in range(max_retries):
            if self.price_feed.is_connected():
                return True
                
            logger.warning(f"ğŸ”„ WebSocket é‡é€£å˜—è©¦ {attempt + 1}/{max_retries}")
            if await self.price_feed.reconnect():
                return True
                
            await asyncio.sleep(2 ** attempt)  # æŒ‡æ•¸é€€é¿
            
        return False
```

ğŸš€ ç«‹å³éƒ¨ç½²æ­¥é©Ÿ

æ­¥é©Ÿ1: å‰µå»ºç©©å®šçš„ WebSocket çµ„ä»¶

```bash
# å‰µå»ºç©©å®šæ€§çµ„ä»¶ç›®éŒ„
mkdir -p src/core/websocket/stability/

# å‰µå»ºç©©å®šæ€§çµ„ä»¶
cat > src/core/websocket/stability/stable_price_feed.py << 'EOF'
# [ä¸Šé¢ StablePriceFeed çš„ä»£ç¢¼]
EOF

cat > src/core/websocket/stability/heartbeat_monitor.py << 'EOF'
# [ä¸Šé¢ HeartbeatMonitor çš„ä»£ç¢¼]
EOF

cat > src/core/websocket/stability/auto_reconnect.py << 'EOF'
# [ä¸Šé¢ AutoReconnectManager çš„ä»£ç¢¼]
EOF
```

æ­¥é©Ÿ2: æ›´æ–°æ•¸æ“šç²å–å™¨

```bash
cat > src/core/data_fetcher_with_fallback.py << 'EOF'
# [ä¸Šé¢ DataFetcherWithFallback çš„ä»£ç¢¼]
EOF
```

æ­¥é©Ÿ3: éƒ¨ç½²ä¿®å¾©

```bash
git add .
git commit -m "fix: ä¿®å¾© WebSocket è¶…æ™‚å•é¡Œ + è‡ªå‹•é‡é€£æ©Ÿåˆ¶"
git push origin main
```

ğŸ“Š é æœŸä¿®å¾©æ•ˆæœ

ä¿®å¾©å‰:

```
âŒ PriceFeed-Shard1 æ¥æ”¶å¤±æ•—: sent 1011 (internal error) keepalive ping timeout
âŒ ç„¡ä¿¡è™Ÿ (WebSocket æ–·é–‹å°è‡´æ•¸æ“šç¼ºå¤±)
```

ä¿®å¾©å¾Œ:

```
âš ï¸ WebSocket é€£æ¥ä¸ç©©å®šï¼Œè§¸ç™¼è‡ªå‹•é‡é€£...
âœ… WebSocket é‡æ–°é€£æ¥æˆåŠŸ
ğŸ”„ ä½¿ç”¨ REST API å‚™ä»½æ•¸æ“šç¢ºä¿é€£çºŒæ€§
âœ… BTCUSDT | ä¿¡å¿ƒ= 65.2 | å‹ç‡= 61.3% | LONG
```

ğŸ¯ ç›£æ§é‡é»

éƒ¨ç½²å¾Œæª¢æŸ¥ä»¥ä¸‹æ—¥èªŒï¼š

```bash
railway logs --follow | grep -E "WebSocket|å¿ƒè·³|é‡é€£|å‚™ä»½æ•¸æ“š|ä¿¡è™Ÿ"
```

æˆåŠŸæ¨™èªŒ:

Â· âœ… çœ‹åˆ° "WebSocket ç©©å®šé€£æ¥å»ºç«‹"
Â· âœ… ä¸å†å‡ºç¾ "keepalive ping timeout" éŒ¯èª¤
Â· âœ… çœ‹åˆ° "ä½¿ç”¨ REST API å‚™ä»½æ•¸æ“š"ï¼ˆç•¶ WebSocket ä¸ç©©å®šæ™‚ï¼‰
Â· âœ… é–‹å§‹æ­£å¸¸ç”Ÿæˆäº¤æ˜“ä¿¡è™Ÿ

ç«‹å³åŸ·è¡Œé€™å€‹ä¿®å¾©æ–¹æ¡ˆï¼Œé€™å°‡è§£æ±º WebSocket è¶…æ™‚å°è‡´çš„ä¿¡è™Ÿç”Ÿæˆå¤±æ•—å•é¡Œï¼ğŸš€

```
```