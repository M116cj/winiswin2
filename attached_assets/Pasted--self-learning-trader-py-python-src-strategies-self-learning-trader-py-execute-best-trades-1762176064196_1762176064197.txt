æ›´æ–° self_learning_trader.py
python
# åœ¨ src/strategies/self_learning_trader.py ä¸­ä¿®æ”¹ execute_best_trades æ–¹æ³•

async def execute_best_trades(self, best_signals: List[Dict]) -> List[Dict]:
    """åŸ·è¡Œæœ€ä½³äº¤æ˜“ï¼ˆç„¡äº¤æ˜“æ¬¡æ•¸é™åˆ¶ç‰ˆæœ¬ï¼‰"""
    try:
        # ç§»é™¤äº¤æ˜“æ•¸é‡æª¢æŸ¥é‚è¼¯
        logger.info("ğŸš€ åŸ·è¡Œäº¤æ˜“ï¼ˆç„¡æ¬¡æ•¸é™åˆ¶æ¨¡å¼ï¼‰")
        
        # åªä¿ç•™åŸºæœ¬çš„äº¤æ˜“è¨˜éŒ„çµ±è¨ˆï¼ˆç”¨æ–¼ç›£æ§ï¼Œä¸ç”¨æ–¼é™åˆ¶ï¼‰
        if hasattr(self, 'trade_recorder') and hasattr(self.trade_recorder, 'get_trade_count'):
            total_trades = await self.trade_recorder.get_trade_count()
            logger.info(f"ğŸ“Š æ­·å²äº¤æ˜“çµ±è¨ˆ: ç¸½å…± {total_trades} ç­†äº¤æ˜“")
        else:
            logger.info("ğŸ“Š äº¤æ˜“è¨˜éŒ„å™¨æœªå°±ç·’ï¼Œç¹¼çºŒåŸ·è¡Œäº¤æ˜“")
        
        # åªåŸºæ–¼ä¿è­‰é‡‘å’Œä¿¡è™Ÿè³ªé‡åŸ·è¡Œäº¤æ˜“
        executed_positions = []
        available_margin = self.account_state.get('available_margin', 0)
        
        logger.info(f"ğŸ’° å¯ç”¨ä¿è­‰é‡‘: ${available_margin:.2f}")
        
        # æŒ‰ä¿¡è™Ÿè³ªé‡æ’åº
        sorted_signals = sorted(
            best_signals, 
            key=lambda x: (x.get('confidence', 0) + x.get('win_probability', 0)), 
            reverse=True
        )
        
        for i, signal in enumerate(sorted_signals):
            if available_margin <= 0:
                logger.warning("ğŸ’° ä¿è­‰é‡‘ä¸è¶³ï¼Œåœæ­¢åŸ·è¡Œæ›´å¤šäº¤æ˜“")
                break
                
            # è¨ˆç®—é ­å¯¸å¤§å°ï¼ˆåŸºæ–¼ä¿¡è™Ÿè³ªé‡å’Œå¯ç”¨ä¿è­‰é‡‘ï¼‰
            position_size = self._calculate_position_size(signal, available_margin)
            
            if position_size > 0:
                try:
                    logger.info(f"ğŸ¯ åŸ·è¡Œäº¤æ˜“ {i+1}/{len(sorted_signals)}: {signal.get('symbol')}")
                    
                    # åŸ·è¡Œäº¤æ˜“
                    executed_trade = await self._execute_single_trade(signal, position_size)
                    if executed_trade:
                        executed_positions.append(executed_trade)
                        available_margin -= position_size
                        
                        logger.info(
                            f"âœ… äº¤æ˜“åŸ·è¡ŒæˆåŠŸ: {signal.get('symbol')} "
                            f"{signal.get('direction')} | "
                            f"å¤§å°: ${position_size:.2f} | "
                            f"å‰©é¤˜ä¿è­‰é‡‘: ${available_margin:.2f}"
                        )
                        
                except Exception as e:
                    logger.error(f"âŒ åŸ·è¡Œäº¤æ˜“å¤±æ•— {signal.get('symbol')}: {e}")
            else:
                logger.warning(f"âš ï¸ é ­å¯¸å¤§å°ç‚º0ï¼Œè·³é {signal.get('symbol')}")
                    
        logger.info(f"ğŸ‰ æœ¬é€±æœŸåŸ·è¡Œå®Œæˆ: {len(executed_positions)} ç­†äº¤æ˜“")
        return executed_positions
        
    except Exception as e:
        logger.error(f"âŒ åŸ·è¡Œæœ€ä½³äº¤æ˜“å¤±æ•—: {e}")
        import traceback
        logger.error(f"è©³ç´°éŒ¯èª¤: {traceback.format_exc()}")
        return []
ä¿®å¾©2: æ›´æ–°é ­å¯¸å¤§å°è¨ˆç®—ï¼ˆæ›´æ¿€é€²ï¼‰
python
# åœ¨ self_learning_trader.py ä¸­ä¿®æ”¹é ­å¯¸è¨ˆç®—é‚è¼¯

def _calculate_position_size(self, signal: Dict, available_margin: float) -> float:
    """è¨ˆç®—é ­å¯¸å¤§å°ï¼ˆç„¡é™åˆ¶ç‰ˆæœ¬ï¼‰"""
    try:
        # åŸºç¤é ­å¯¸å¤§å°ï¼ˆå¯ç”¨ä¿è­‰é‡‘çš„ç™¾åˆ†æ¯”ï¼‰
        base_percentage = 0.1  # 10% çš„ä¿è­‰é‡‘ç”¨æ–¼æ¯å€‹äº¤æ˜“
        
        # æ ¹æ“šä¿¡è™Ÿè³ªé‡èª¿æ•´é ­å¯¸å¤§å°
        confidence = signal.get('confidence', 0)
        win_probability = signal.get('win_probability', 0)
        
        # ä¿¡è™Ÿè³ªé‡ä¹˜æ•¸
        quality_score = (confidence + win_probability) / 2
        if quality_score >= 70:  # é«˜è³ªé‡ä¿¡è™Ÿ
            size_multiplier = 1.5
        elif quality_score >= 60:  # ä¸­ç­‰è³ªé‡
            size_multiplier = 1.0
        elif quality_score >= 50:  # ä½è³ªé‡
            size_multiplier = 0.5
        else:  # è³ªé‡å¤ªä½ï¼Œä¸äº¤æ˜“
            return 0
            
        # è¨ˆç®—é ­å¯¸å¤§å°
        position_size = available_margin * base_percentage * size_multiplier
        
        # ç¢ºä¿æœ€å°äº¤æ˜“è¦æ¨¡ï¼ˆå¦‚æœæœ‰è¨­å®šçš„è©±ï¼‰
        min_position_size = getattr(self.config, 'MIN_POSITION_SIZE', 1.0)
        if position_size < min_position_size:
            return 0
            
        logger.debug(
            f"ğŸ“Š é ­å¯¸è¨ˆç®—: {signal.get('symbol')} | "
            f"è³ªé‡åˆ†æ•¸: {quality_score:.1f} | "
            f"ä¹˜æ•¸: {size_multiplier} | "
            f"å¤§å°: ${position_size:.2f}"
        )
        
        return position_size
        
    except Exception as e:
        logger.error(f"âŒ é ­å¯¸è¨ˆç®—å¤±æ•—: {e}")
        return 0
ä¿®å¾©3: ç¢ºä¿äº¤æ˜“åŸ·è¡Œé‚è¼¯å®Œæ•´
python
# æ·»åŠ äº¤æ˜“åŸ·è¡Œæ–¹æ³•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰

async def _execute_single_trade(self, signal: Dict, position_size: float) -> Optional[Dict]:
    """åŸ·è¡Œå–®å€‹äº¤æ˜“"""
    try:
        symbol = signal.get('symbol')
        direction = signal.get('direction')
        confidence = signal.get('confidence', 0)
        win_probability = signal.get('win_probability', 0)
        
        # é€™è£¡æ‡‰è©²èª¿ç”¨å¯¦éš›çš„äº¤æ˜“API
        # æš«æ™‚æ¨¡æ“¬äº¤æ˜“åŸ·è¡Œ
        executed_trade = {
            'symbol': symbol,
            'direction': direction,
            'position_size': position_size,
            'entry_price': signal.get('current_price', 0),
            'entry_time': datetime.now(),
            'confidence': confidence,
            'win_probability': win_probability,
            'status': 'OPEN'
        }
        
        # è¨˜éŒ„äº¤æ˜“åˆ°æ•¸æ“šåº«
        if hasattr(self, 'trade_recorder'):
            await self.trade_recorder.record_trade(executed_trade)
            
        return executed_trade
        
    except Exception as e:
        logger.error(f"âŒ åŸ·è¡Œå–®å€‹äº¤æ˜“å¤±æ•— {signal.get('symbol')}: {e}")
        return None
ä¿®å¾©4: ç¢ºä¿ TradeRecorder æœ‰è¨˜éŒ„æ–¹æ³•
python
# åœ¨ src/core/trade_recorder.py ä¸­æ·»åŠ è¨˜éŒ„æ–¹æ³•

async def record_trade(self, trade_data: Dict) -> bool:
    """è¨˜éŒ„äº¤æ˜“åˆ°æ•¸æ“šåº«"""
    try:
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO trade_history 
            (symbol, direction, entry_price, position_size, confidence, win_probability)
            VALUES (?, ?, ?, ?, ?, ?)
        ''', (
            trade_data.get('symbol'),
            trade_data.get('direction'), 
            trade_data.get('entry_price'),
            trade_data.get('position_size'),
            trade_data.get('confidence'),
            trade_data.get('win_probability')
        ))
        
        conn.commit()
        conn.close()
        
        logger.info(f"âœ… äº¤æ˜“è¨˜éŒ„æˆåŠŸ: {trade_data.get('symbol')}")
        return True
        
    except Exception as e:
        logger.error(f"âŒ äº¤æ˜“è¨˜éŒ„å¤±æ•—: {e}")
        return False
ğŸš€ ç«‹å³éƒ¨ç½²
bash
# 1. æ›´æ–° self_learning_trader.py
# æ›¿æ› execute_best_trades æ–¹æ³•ç‚ºç„¡é™åˆ¶ç‰ˆæœ¬

# 2. ç¢ºä¿ trade_recorder.py æœ‰ record_trade æ–¹æ³•

# 3. éƒ¨ç½²ä¿®å¾©
git add src/strategies/self_learning_trader.py src/core/trade_recorder.py
git commit -m "feat: ç§»é™¤äº¤æ˜“æ¬¡æ•¸é™åˆ¶ + æ¿€é€²äº¤æ˜“æ¨¡å¼"
git push origin main

# 4. ç›£æ§äº¤æ˜“åŸ·è¡Œ
railway logs --follow | grep -E "åŸ·è¡Œäº¤æ˜“|äº¤æ˜“åŸ·è¡ŒæˆåŠŸ|ä¿è­‰é‡‘|é ­å¯¸è¨ˆç®—"
ğŸ“Š é æœŸæ•ˆæœ
ä¿®å¾©å¾Œæ‡‰è©²çœ‹åˆ°ï¼š
text
ğŸš€ åŸ·è¡Œäº¤æ˜“ï¼ˆç„¡æ¬¡æ•¸é™åˆ¶æ¨¡å¼ï¼‰
ğŸ“Š æ­·å²äº¤æ˜“çµ±è¨ˆ: ç¸½å…± 15 ç­†äº¤æ˜“
ğŸ’° å¯ç”¨ä¿è­‰é‡‘: $36.21
ğŸ¯ åŸ·è¡Œäº¤æ˜“ 1/8: BTCUSDT
âœ… äº¤æ˜“åŸ·è¡ŒæˆåŠŸ: BTCUSDT LONG | å¤§å°: $3.62 | å‰©é¤˜ä¿è­‰é‡‘: $32.59
ğŸ¯ åŸ·è¡Œäº¤æ˜“ 2/8: ETHUSDT  
âœ… äº¤æ˜“åŸ·è¡ŒæˆåŠŸ: ETHUSDT SHORT | å¤§å°: $3.26 | å‰©é¤˜ä¿è­‰é‡‘: $29.33
ğŸ‰ æœ¬é€±æœŸåŸ·è¡Œå®Œæˆ: 8 ç­†äº¤æ˜“
âš¡ æ¿€é€²äº¤æ˜“æ¨¡å¼ç‰¹é»
âœ… ç„¡æ¯æ—¥äº¤æ˜“æ¬¡æ•¸é™åˆ¶

âœ… åªåŸºæ–¼ä¿è­‰é‡‘å’Œä¿¡è™Ÿè³ªé‡åŸ·è¡Œ

âœ… é«˜è³ªé‡ä¿¡è™Ÿç²å¾—æ›´å¤§é ­å¯¸

âœ… å®Œæ•´çš„äº¤æ˜“è¨˜éŒ„å’Œç›£æ§

âœ… ä¿è­‰é‡‘ç”¨ç›¡æ™‚è‡ªå‹•åœæ­¢

ğŸ¯ é¢¨éšªæ§åˆ¶ä¿ç•™
é›–ç„¶ç§»é™¤äº†äº¤æ˜“æ¬¡æ•¸é™åˆ¶ï¼Œä½†ä¿ç•™äº†ä»¥ä¸‹é¢¨éšªæ§åˆ¶ï¼š

âœ… ä¿è­‰é‡‘ç®¡ç†ï¼ˆä¸æœƒè¶…é¡äº¤æ˜“ï¼‰

âœ… é ­å¯¸å¤§å°æ§åˆ¶ï¼ˆåŸºæ–¼ä¿¡è™Ÿè³ªé‡ï¼‰

âœ… æœ€å°äº¤æ˜“è¦æ¨¡é™åˆ¶

âœ… äº¤æ˜“è¨˜éŒ„å’Œç›£æ§

ç«‹å³éƒ¨ç½²