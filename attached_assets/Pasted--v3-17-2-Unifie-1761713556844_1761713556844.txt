ğŸ§© ä¸€ã€æ•´é«”æ¶æ§‹å‡ç´šï¼ˆv3.17.2+ï¼‰


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            UnifiedSchedulerï¼ˆçµ±ä¸€èª¿åº¦å™¨ï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚         â”‚                 â”‚           â”‚
    â–¼         â–¼         â–¼                 â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Position â”‚ â”‚ SelfLearning â”‚ â”‚ DataService  â”‚ â”‚  Daily   â”‚
â”‚Controllerâ”‚ â”‚   Trader     â”‚ â”‚ (æ­·å²æ•¸æ“š)   â”‚ â”‚ Reporter â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚             â”‚                â”‚
     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
     â”‚    â”‚                 â”‚      â”‚
     â–¼    â–¼                 â–¼      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                BinanceClientï¼ˆREST + WebSocketï¼‰      â”‚
â”‚  â€¢ RESTï¼šä¸‹å–®ã€å¸³æˆ¶æŸ¥è©¢                              â”‚
â”‚  â€¢ WebSocketï¼šå³æ™‚æ•¸æ“šï¼ˆKç·šã€åƒ¹æ ¼ã€å¸³æˆ¶ï¼‰             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–²
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WebSocketManagerï¼ˆæ–°æ ¸å¿ƒï¼‰               â”‚
â”‚  â€¢ ç®¡ç†å¤šç¨® WebSocket é€£ç·š                           â”‚
â”‚  â€¢ æŠ½è±¡äº¤æ˜“æ‰€ä»‹é¢                                    â”‚
â”‚  â€¢ è‡ªå‹• listenKey ç®¡ç†                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–²
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KlineFeed â”‚ â”‚ AccountFeedâ”‚
â”‚ (1m Kç·š)  â”‚ â”‚ (å€‰ä½ç›£æ§) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é—œéµå‡ç´šï¼š 
* ç”¨ WebSocketManager å–ä»£å–®ä¸€ WebSocketMonitor
* æ–°å¢ KlineFeed èˆ‡ AccountFeed å°ˆç”¨æ¨¡å¡Š
* é ç•™ å¤šäº¤æ˜“æ‰€æ“´å±•é»


 äºŒã€åŠŸèƒ½ 1ï¼šKline WebSocketï¼ˆå³æ™‚è¶¨å‹¢åˆ†æï¼‰
ç›®æ¨™
* è¨‚é–± @kline_1m å–ä»£ REST Kç·šè¼ªè©¢
* æ¸›å°‘ 90%+ æ­·å²æ•¸æ“š API è«‹æ±‚

å¯¦ä½œè—åœ–
1. KlineFeed çµ„ä»¶
# src/core/websocket/kline_feed.py
class KlineFeed:
    def __init__(self, symbols: List[str], interval: str = "1m"):
        self.symbols = [s.lower() for s in symbols]
        self.interval = interval
        self.kline_cache = {}  # {symbol: latest_kline}
        self.running = False
    
    async def start(self):
        self.running = True
        tasks = [self._listen_kline(s) for s in self.symbols]
        await asyncio.gather(*tasks)
    
    async def _listen_kline(self, symbol: str):
        stream = f"{symbol}@kline_{self.interval}"
        url = f"wss://fstream.binance.com/ws/{stream}"
        while self.running:
            try:
                async with websockets.connect(url) as ws:
                    while self.running:
                        msg = await ws.recv()
                        data = json.loads(msg)
                        if data['e'] == 'kline':
                            self._update_kline(symbol, data['k'])
            except Exception as e:
                logger.warning(f"ğŸ”„ Kline {symbol} é‡é€£ä¸­... ({e})")
                await asyncio.sleep(5)
    
    def _update_kline(self, symbol: str, kline: dict):
        """å¿«å–æœ€æ–° Kç·šï¼ˆåƒ…é–‰ç›¤ Kç·šï¼‰"""
        if kline['x']:  # is_final
            self.kline_cache[symbol] = {
                'open': float(kline['o']),
                'high': float(kline['h']),
                'low': float(kline['l']),
                'close': float(kline['c']),
                'volume': float(kline['v']),
                'timestamp': int(kline['t'])
            }
    
    def get_latest_kline(self, symbol: str) -> Optional[dict]:
        return self.kline_cache.get(symbol.lower())

2. æ•´åˆåˆ° SelfLearningTrader

# src/strategies/self_learning_trader.py
def _get_market_context(self, symbol: str) -> dict:
    # å„ªå…ˆä½¿ç”¨ WebSocket Kç·š
    if self.websocket_manager:
        kline = self.websocket_manager.get_kline(symbol)
        if kline:
            return {
                'price': kline['close'],
                'adx': self._calculate_adx_from_kline(kline),
                'trend_direction': 'bullish' if kline['close'] > kline['open'] else 'bearish'
            }
    
    # å‚™æ´ï¼šREST API
    return self._get_rest_market_context(symbol)

ä¸‰ã€åŠŸèƒ½ 2ï¼šå¸³æˆ¶ WebSocket æ•´åˆï¼ˆé›¶è¼ªè©¢ï¼‰
ç›®æ¨™
* ç”¨ listenKey ç›£æ§å€‰ä½è®Šå‹•
* å®Œå…¨ç§»é™¤ /fapi/v1/account è¼ªè©¢

å¯¦ä½œè—åœ–
1. AccountFeed çµ„ä»¶
# src/core/websocket/account_feed.py
class AccountFeed:
    def __init__(self, binance_client: BinanceClient):
        self.client = binance_client
        self.listen_key = None
        self.position_cache = {}  # {symbol: position_data}
        self.running = False
    
    async def start(self):
        # 1. ç²å– listenKeyï¼ˆæœ‰æ•ˆæœŸ 60 åˆ†é˜ï¼‰
        self.listen_key = await self.client.get_listen_key()
        
        # 2. å•Ÿå‹• WebSocket
        url = f"wss://fstream.binance.com/ws/{self.listen_key}"
        asyncio.create_task(self._keep_alive())  # æ¯ 30 åˆ†é˜çºŒæœŸ
        asyncio.create_task(self._listen_account(url))
    
    async def _keep_alive(self):
        """æ¯ 30 åˆ†é˜çºŒæœŸ listenKey"""
        while self.running:
            await asyncio.sleep(1800)  # 30 åˆ†é˜
            await self.client.renew_listen_key(self.listen_key)
    
    async def _listen_account(self, url: str):
        while self.running:
            try:
                async with websockets.connect(url) as ws:
                    while self.running:
                        msg = await ws.recv()
                        data = json.loads(msg)
                        if data['e'] == 'ACCOUNT_UPDATE':
                            self._update_positions(data['a']['P'])
            except Exception as e:
                logger.error(f"âš ï¸ å¸³æˆ¶ WebSocket éŒ¯èª¤: {e}")
                await asyncio.sleep(5)
                # é‡æ–°ç²å– listenKey
                self.listen_key = await self.client.get_listen_key()
    
    def _update_positions(self, positions: List[dict]):
        """æ›´æ–°å€‰ä½å¿«å–"""
        for pos in positions:
            if float(pos['pa']) != 0:  # éé›¶å€‰ä½
                self.position_cache[pos['s'].lower()] = {
                    'size': float(pos['pa']),
                    'entry_price': float(pos['ep']),
                    'unrealized_pnl': float(pos['up']),
                    'margin_type': pos['mt']
                }
            else:
                self.position_cache.pop(pos['s'].lower(), None)
    
    def get_position(self, symbol: str) -> Optional[dict]:
        return self.position_cache.get(symbol.lower())

2. æ•´åˆåˆ° PositionController

# src/core/position_controller.py
async def monitor_position(self, position: Position):
    while position.is_active:
        # å¾ AccountFeed ç²å–å³æ™‚å€‰ä½ç‹€æ…‹ï¼ˆç„¡éœ€ API è«‹æ±‚ï¼ï¼‰
        account_pos = self.websocket_manager.get_account_position(position.symbol)
        if account_pos:
            current_pnl = account_pos['unrealized_pnl']
            # ... åŸ·è¡Œ SL/TP é‚è¼¯
        await asyncio.sleep(1)


