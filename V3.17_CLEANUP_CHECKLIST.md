# 🧹 v3.17+ 徹底清理檢查清單

**目標**: 移除所有 v3.16 及更早版本的遺留代碼，實現極簡、無技術債的架構

**清理類型**: 破壞性升級（不保留向下兼容）

---

## ✅ 清理檢查清單

### 📁 1. 刪除整個目錄

#### src/ml/ - 所有深度學習模塊（已棄用）
```bash
rm -rf src/ml/
```

**包含的文件（25個）**:
- ✅ `adaptive_learner.py` - 自適應學習器
- ✅ `adaptive_strategy_evolver.py` - 策略演化器
- ✅ `async_batch_predictor.py` - 批量預測器
- ✅ `data_archiver.py` - 數據歸檔
- ✅ `data_processor.py` - 數據處理器
- ✅ `drift_detector.py` - 漂移檢測
- ✅ `ensemble_model.py` - 集成模型
- ✅ `feature_cache.py` - 特徵緩存（重複）
- ✅ `feature_discovery_network.py` - 特徵發現網絡（DL）
- ✅ `feature_importance_monitor.py` - 特徵重要性監控
- ✅ `high_quality_filter.py` - 高質量過濾器
- ✅ `hyperparameter_tuner.py` - 超參數調優
- ✅ `imbalance_handler.py` - 不平衡處理
- ✅ `label_leakage_validator.py` - 標籤泄漏驗證
- ✅ `light_feature_vector.py` - 輕量級特徵向量
- ✅ `liquidity_prediction_model.py` - 流動性預測模型（DL）
- ✅ `market_structure_autoencoder.py` - 市場結構自動編碼器（DL）
- ✅ `model_persistence.py` - 模型持久化（改用 XGBoost）
- ✅ `model_quantizer.py` - 模型量化（TFLite）
- ✅ `model_trainer.py` - 模型訓練器
- ✅ `multivariate_drift.py` - 多變量漂移
- ✅ `predictor.py` - ML 預測器（重構到 Controller）
- ✅ `quality_training_pipeline.py` - 質量訓練管道
- ✅ `target_optimizer.py` - 目標優化器
- ✅ `uncertainty_quantifier.py` - 不確定性量化

**原因**: v3.17+ 使用純 XGBoost，無需 TensorFlow/PyTorch 深度學習模型

---

#### docs/archive/ - 歷史文檔
```bash
rm -rf docs/archive/
```

**原因**: v3.0-v3.2 的歷史文檔已無參考價值

---

#### data/training_cache/ - 舊訓練緩存
```bash
rm -rf data/training_cache/
```

**原因**: 避免舊數據污染新訓練

---

#### reports/ - 舊版報告（如果存在）
```bash
# 僅保留 v3.17+ 報告目錄
mkdir -p reports/daily
rm -rf reports/v3.16/ reports/v3.15/ reports/legacy/
```

---

### 📄 2. 刪除單個文件

#### src/managers/risk_manager.py
```bash
rm src/managers/risk_manager.py
```

**原因**: 風險邏輯已整合到 `LeverageEngine` 和 `PositionSizer`

---

#### src/core/performance_modules.py
```bash
rm src/core/performance_modules.py
```

**原因**: v3.16.0 特定模塊，v3.17+ 不使用

---

#### src/core/market_regime_predictor.py
```bash
rm src/core/market_regime_predictor.py
```

**原因**: v3.16.0 特定模塊

---

#### src/core/dynamic_feature_generator.py
```bash
rm src/core/dynamic_feature_generator.py
```

**原因**: v3.16.0 特定模塊

---

#### src/core/liquidity_hunter.py
```bash
rm src/core/liquidity_hunter.py
```

**原因**: v3.16.0 特定模塊

---

#### src/core/memory_mapped_features.py
```bash
rm src/core/memory_mapped_features.py
```

**原因**: v3.15.0 優化，v3.17+ 不使用

---

#### scripts/convert_to_tflite.py
```bash
rm scripts/convert_to_tflite.py
```

**原因**: TensorFlow Lite 已棄用

---

#### scripts/convert_xgboost_to_onnx.py
```bash
rm scripts/convert_xgboost_to_onnx.py
```

**原因**: ONNX 轉換已棄用

---

#### scripts/check_onnx_compatibility.py
```bash
rm scripts/check_onnx_compatibility.py
```

**原因**: ONNX 相關腳本已棄用

---

### 🗑️ 3. 清理模型文件

```bash
# 刪除所有 TensorFlow/ONNX 模型
find data/models/ -name "*.h5" -delete
find data/models/ -name "*.tflite" -delete
find data/models/ -name "*.onnx" -delete
find models/ -name "*.h5" -delete
find models/ -name "*.tflite" -delete
find models/ -name "*.onnx" -delete

# 僅保留 XGBoost 模型
# 保留: *.ubj, *.json, *.pkl (XGBoost 原生格式)
```

---

### 📝 4. 清理舊版文檔

```bash
# 刪除 v3.0-v3.16 架構文檔
rm ARCHITECTURE_v3.14.0.md
rm ARCHITECTURE_v3.15.0.md
rm SYSTEM_AUDIT_REPORT_v3.16.1.md
rm SYSTEM_OVERVIEW_v3.16.2.md
rm v3.14.0_CODE_AUDIT_REPORT.md

# 刪除舊版修復文檔
rm CODE_REVIEW_REPORT_v3.9.2.8.md
rm VERSION_v3.9.2.7_SUMMARY.md
rm V3.16.2_GLOBAL_PROCESS_POOL_FIX_FINAL.md
rm V3.16.2_SERIALIZATION_FIX_COMPLETE.md
rm V3.16.2_THREADPOOL_FIX_COMPLETE.md
rm V3.16.3_INCREMENTAL_LEARNING_COMPLETE.md

# 保留 v3.17+ 文檔
# V3.17_DEPLOYMENT_GUIDE.md
# V3.17_INTEGRATION_ROADMAP.md
# INTEGRATION_CHECKLIST.md
```

---

### ⚙️ 5. 清理 src/config.py

#### 移除的參數（46-51行）:
```python
# 刪除這些行：
BASE_LEVERAGE: int = 3
MAX_LEVERAGE: int = 20
MIN_LEVERAGE: int = 3
BASE_MARGIN_PCT: float = 0.10
MIN_MARGIN_PCT: float = 0.03
MAX_MARGIN_PCT: float = 0.13
```

#### 移除的參數（82行）:
```python
# 刪除：
VOLATILITY_SPIKE_MAX_LEVERAGE: int = 5
```

#### 移除的參數（127-154行）:
```python
# 刪除整個 v3.14.0-v3.16.0 配置區塊：
# ===== 自我学习配置 (v3.14.0) =====
STRATEGY_MODE  # 已移至 ConfigProfile
ENABLE_SELF_LEARNING
SELF_LEARNING_MODE
STRUCTURE_VECTOR_DIM
FEATURE_DISCOVERY_RATE
STRATEGY_EVOLUTION_INTERVAL

# ===== 训练配置 (v3.14.0) =====
REINFORCEMENT_LEARNING_ENABLED
AUTOENCODER_TRAINING_ENABLED
FEATURE_DISCOVERY_ENABLED

# ===== v3.16.0 性能模块配置 =====
ENABLE_MARKET_REGIME_PREDICTION
REGIME_PREDICTION_THRESHOLD
REGIME_PREDICTION_LOOKBACK
ENABLE_DYNAMIC_FEATURES
DYNAMIC_FEATURE_MIN_SHARPE
DYNAMIC_FEATURE_MAX_COUNT
ENABLE_LIQUIDITY_HUNTING
LIQUIDITY_HUNT_CONFIDENCE_THRESHOLD
LIQUIDITY_SLIPPAGE_TOLERANCE
```

#### 移除的參數（200-219行）:
```python
# 刪除 v3.15.0 優化配置：
ENABLE_QUANTIZATION
QUANTIZED_MODEL_PATH
ENABLE_INCREMENTAL_CACHE
ENABLE_BATCH_PREDICTION
BATCH_PREDICTION_SIZE
BATCH_MAX_DELAY
ENABLE_MEMORY_MAPPED_STORAGE
MAX_MEMORY_MAPPED_POSITIONS
FEATURE_DIMENSION
ENABLE_SMART_MONITORING
```

#### 保留的參數:
```python
# 保留這些核心參數：
MIN_CONFIDENCE: float = 0.35  # 將在 v3.17+ 中使用
MAX_SIGNALS: int = 10
IMMEDIATE_EXECUTION_RANK: int = 3
SCAN_INTERVAL
TOP_VOLATILITY_SYMBOLS
# ... 技術指標配置 ...
# ... ADX 配置 ...
# ... Order Blocks 配置 ...
# ... API 限流配置 ...
```

---

### 📦 6. 清理 requirements.txt

#### 移除的依賴:
```
tensorflow>=2.13.0          # 深度學習框架（已棄用）
tensorflow-addons>=0.19.0   # TensorFlow 擴展（已棄用）
onnxmltools>=1.11.0         # ONNX 轉換工具（已棄用）
onnxruntime>=1.18.0         # ONNX 推理引擎（已棄用）
```

#### 保留的依賴:
```
aiohttp>=3.9.1              # 異步 HTTP 客戶端
ccxt>=4.2.0                 # 加密貨幣交易所 API
discord.py>=2.3.0           # Discord 通知
pandas>=2.0.0               # 數據處理
numpy>=1.24.0,<2.0.0        # 數值計算
python-dotenv>=1.0.0        # 環境變量
psutil>=5.9.0               # 系統監控
xgboost>=2.0.0              # ML 模型（唯一保留）
scikit-learn>=1.3.0         # ML 工具（特徵工程）
aiofiles                    # 異步文件 I/O
```

---

### 🔧 7. 清理 src/core/global_pool.py

**檢查並確認**:
```python
# 確認僅使用 ThreadPoolExecutor
from concurrent.futures import ThreadPoolExecutor

# ✅ 正確
executor = ThreadPoolExecutor(max_workers=4)

# 🚨 禁止
# from concurrent.futures import ProcessPoolExecutor  # 刪除
# from multiprocessing import Pool  # 刪除
```

---

### 🧪 8. 清理測試文件（可選）

```bash
# 刪除舊版測試
rm tests/test_complete_virtual_system.py
rm tests/test_incremental_cache.py
rm tests/test_mutable_virtual_position.py
rm tests/test_performance_benchmarks.py
rm tests/test_virtual_position_integration.py

# 未來添加 v3.17+ 測試：
# tests/test_leverage_engine.py
# tests/test_position_sizer.py
# tests/test_model_rating.py
```

---

## 📊 清理統計

| 類別 | 數量 | 操作 |
|------|------|------|
| **目錄刪除** | 4個 | `src/ml/`, `docs/archive/`, `data/training_cache/`, `reports/legacy/` |
| **文件刪除** | 35+ | 模塊文件、腳本、舊文檔 |
| **配置清理** | 30+ | Config 參數移除 |
| **依賴移除** | 4個 | TensorFlow, ONNX 相關 |
| **模型清理** | 全部 | .h5, .tflite, .onnx 文件 |

**預計節省空間**: ~500MB+（主要是 TensorFlow 依賴）

**預計減少代碼**: ~5000+ 行

---

## 🚀 執行順序

### 階段 1: 安全備份（可選）
```bash
# 創建備份（以防萬一）
git add .
git commit -m "Backup before v3.17+ cleanup"
git tag v3.16.3-backup
```

### 階段 2: 刪除目錄
```bash
rm -rf src/ml/
rm -rf docs/archive/
rm -rf data/training_cache/
```

### 階段 3: 刪除單個文件
```bash
# 使用清單中的 rm 命令
rm src/managers/risk_manager.py
rm src/core/performance_modules.py
# ... 等等
```

### 階段 4: 清理模型文件
```bash
find . -name "*.h5" -delete
find . -name "*.tflite" -delete
find . -name "*.onnx" -delete
```

### 階段 5: 更新配置文件
```bash
# 手動編輯以下文件：
# - src/config.py
# - requirements.txt
# - .env.example（創建新範本）
```

### 階段 6: 驗證無序列化風險
```bash
# 檢查是否還有 ProcessPool
grep -r "ProcessPool" src/
grep -r "multiprocessing" src/

# 應該返回空或僅在註釋中
```

### 階段 7: 測試啟動
```bash
# 重新安裝依賴
pip install -r requirements.txt

# 測試導入
python -c "from src.core.config_profile import ConfigProfile; print('OK')"

# 測試啟動（不交易）
export TRADING_ENABLED=false
python src/main.py
```

---

## ✅ 驗收標準

清理完成後，確認以下條件：

- [ ] `src/ml/` 目錄不存在
- [ ] `requirements.txt` 中無 TensorFlow/ONNX
- [ ] `src/config.py` 中無 `MAX_LEVERAGE`、`BASE_LEVERAGE` 等舊參數
- [ ] `find . -name "*.h5"` 返回空
- [ ] `find . -name "*.tflite"` 返回空
- [ ] `grep -r "ProcessPool" src/` 無結果
- [ ] 系統能正常啟動（無 ImportError）
- [ ] `ls -lh` 顯示項目大小顯著減小

---

**清理版本**: v3.17+  
**創建日期**: 2025-10-28  
**風險等級**: 🔴 高（破壞性升級，不可逆）  
**建議**: 執行前創建 Git 備份標籤
