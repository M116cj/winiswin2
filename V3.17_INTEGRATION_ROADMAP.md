# 🚀 v3.17+ 整合路線圖

## 📊 當前狀態（2025-10-28）

### ✅ 已完成（P0-P1）

所有核心模塊已實施，代碼質量良好，內部邏輯完整：

- **ConfigProfile** - 環境變量驅動，含驗證
- **LeverageEngine** - 無限槓桿公式正確
- **PositionSizer** - Binance 規格檢查完整
- **SLTPAdjuster** - 動態調整邏輯穩健
- **SelfLearningTraderController** - 編排流程清晰
- **PositionMonitor24x7** - 監控邏輯完整
- **ModelRatingEngine** - 評分算法正確
- **DailyReporter** - 報告生成完整

### 🚨 待整合（P2 - 關鍵）

根據 Architect 審查，需要完成 3 個整合步驟：

---

## 📋 整合步驟 1：更新 SelfLearningTrader

**文件**: `src/strategies/self_learning_trader.py`

**目標**: 添加 `win_probability` 和 `rr_ratio` 字段

**實施方案 A（簡化版 - 推薦）**:
```python
def analyze(self, symbol: str, multi_tf_data: Dict[str, pd.DataFrame]) -> Optional[Dict]:
    # ... 現有邏輯 ...
    
    # 計算 R:R 比率
    rr_ratio = abs(take_profit - entry_price) / abs(entry_price - stop_loss)
    
    # 預測勝率（簡化版：使用歷史統計）
    win_probability = self._get_historical_win_rate()  # 默認 0.55-0.65
    
    # 添加到信號
    signal['win_probability'] = win_probability
    signal['rr_ratio'] = rr_ratio
    
    return signal

def _get_historical_win_rate(self) -> float:
    """
    獲取歷史勝率（簡化版本）
    
    進階版本可以：
    1. 基於市場結構相似度
    2. 使用 ML 模型預測
    3. 考慮當前市場狀態
    """
    # 默認保守估計
    return 0.55 + (self.training_counter / 1000) * 0.10  # 隨訓練提升
```

**實施方案 B（進階版）**:
```python
def _predict_win_probability(self, signal_features: np.ndarray) -> float:
    """
    使用 ML 模型預測勝率
    
    輸入特徵：
    - 市場結構編碼
    - 動態特徵向量
    - 流動性指標
    """
    if not hasattr(self, 'win_rate_model') or self.training_counter < 100:
        return 0.55  # 冷啟動默認值
    
    # 使用訓練好的模型預測
    prediction = self.win_rate_model.predict(signal_features)
    return np.clip(prediction, 0.4, 0.8)  # 限制在合理範圍
```

**工作量**: 1-2 小時  
**優先級**: P0（必須）

---

## 📋 整合步驟 2：適配 BinanceClient 接口

**文件**: `src/clients/binance_client.py`

**目標**: 添加 PositionMonitor24x7 需要的方法

**需要添加的方法**:
```python
async def get_all_positions(self, priority: int = 3) -> List[Dict]:
    """
    獲取所有倉位（含未實現盈虧）
    
    Args:
        priority: API 優先級（0=最高，3=最低）
        
    Returns:
        倉位列表
    """
    endpoint = "/fapi/v2/positionRisk"
    return await self._request("GET", endpoint, priority=priority)

async def place_order(
    self,
    symbol: str,
    side: str,
    order_type: str,
    quantity: float,
    price: Optional[float] = None,
    reduce_only: bool = False,
    priority: int = 3
) -> Optional[Dict]:
    """
    下訂單（支持 reduce_only 平倉）
    
    Args:
        reduce_only: 是否僅減倉（平倉）
        priority: API 優先級
    """
    params = {
        'symbol': symbol,
        'side': side,
        'type': order_type,
        'quantity': quantity,
    }
    
    if price:
        params['price'] = price
    
    if reduce_only:
        params['reduceOnly'] = 'true'
    
    endpoint = "/fapi/v1/order"
    return await self._request("POST", endpoint, params=params, priority=priority)
```

**工作量**: 2-3 小時  
**優先級**: P0（必須）

---

## 📋 整合步驟 3：更新主循環

**文件**: `src/main.py`

**目標**: 整合所有 v3.17+ 組件

**核心變更**:
```python
from src.core.config_profile import ConfigProfile
from src.core.self_learning_trader_controller import SelfLearningTraderController
from src.core.position_monitor_24x7 import PositionMonitor24x7
from src.core.model_rating_engine import ModelRatingEngine
from src.core.daily_reporter import DailyReporter

async def main():
    # 1. v3.17+ 配置驗證
    config_profile = ConfigProfile()
    is_valid, errors = config_profile.validate()
    if not is_valid:
        logger.error(f"❌ 配置驗證失敗: {errors}")
        return
    
    logger.info("=" * 60)
    logger.info("🚀 SelfLearningTrader v3.17+ 啟動")
    logger.info(config_profile.to_dict())
    logger.info("=" * 60)
    
    # 2. 初始化組件
    binance_client = BinanceClient(config)
    trade_recorder = TradeRecorder()  # 需要實現或使用現有的
    
    # 3. 創建策略和控制器
    trader = SelfLearningTrader(config)
    controller = SelfLearningTraderController(
        config_profile, trader, binance_client
    )
    
    # 4. 啟動 24/7 倉位監控
    if config_profile.position_monitor_enabled:
        monitor = PositionMonitor24x7(
            config_profile, binance_client, trade_recorder
        )
        await monitor.start()
        logger.info("✅ 24/7 倉位監控已啟動")
    
    # 5. 創建報告系統
    if config_profile.model_rating_enabled:
        rating_engine = ModelRatingEngine(config_profile)
        reporter = DailyReporter(config_profile, rating_engine, trade_recorder)
        
        # 啟動每日報告任務
        asyncio.create_task(schedule_daily_report(reporter))
        logger.info("✅ 每日報告系統已啟動")
    
    # 6. 交易主循環（使用 Controller）
    logger.info("🔄 開始交易循環...")
    
    while True:
        try:
            # 獲取賬戶權益
            account_info = await binance_client.get_account_info()
            account_equity = float(account_info.get('totalWalletBalance', 0))
            
            # 掃描交易對
            for symbol in top_symbols:
                # 獲取多時間框架數據
                multi_tf_data = await fetch_multi_timeframe_data(symbol)
                
                # 使用 Controller 分析並生成訂單
                order = await controller.analyze_and_execute(
                    symbol, multi_tf_data, account_equity
                )
                
                if order:
                    # 執行訂單（使用現有 TradingService 或直接調用）
                    result = await binance_client.place_order(
                        symbol=order['symbol'],
                        side=order['direction'],
                        order_type='MARKET',
                        quantity=order['position_size'],
                        priority=1  # 交易優先級較高
                    )
                    
                    if result:
                        # 記錄交易
                        trade_recorder.record_trade(order, result)
                        logger.info(f"✅ 訂單執行成功: {symbol}")
            
            # 循環間隔
            await asyncio.sleep(config_profile.cycle_interval)
            
        except Exception as e:
            logger.error(f"❌ 交易循環錯誤: {e}", exc_info=True)
            await asyncio.sleep(60)

async def schedule_daily_report(reporter: DailyReporter):
    """每日報告排程"""
    while True:
        now = datetime.now()
        next_run = now.replace(hour=0, minute=0, second=0, microsecond=0)
        if now >= next_run:
            next_run += timedelta(days=1)
        
        wait_seconds = (next_run - now).total_seconds()
        await asyncio.sleep(wait_seconds)
        
        # 生成報告
        await reporter.generate_daily_report(period_days=1)
```

**工作量**: 3-4 小時  
**優先級**: P0（必須）

---

## 🧪 測試計劃

### 單元測試（可選，但推薦）

```bash
# 測試槓桿計算
pytest tests/test_leverage_engine.py

# 測試倉位計算
pytest tests/test_position_sizer.py

# 測試評分系統
pytest tests/test_model_rating.py
```

### 集成測試

1. **本地測試（Replit）**:
   ```bash
   # 使用模擬數據測試
   export BINANCE_TESTNET=true
   export TRADING_ENABLED=false
   python src/main.py
   ```

2. **Railway 測試部署**:
   - 先部署到測試環境
   - 設置 `TRADING_ENABLED=false`
   - 觀察 24 小時確保無錯誤

3. **生產部署**:
   - 設置 `TRADING_ENABLED=true`
   - 初始權益設置較小（測試用）
   - 監控前 100 筆交易

---

## 📈 預期時間表

| 階段 | 任務 | 時間 | 狀態 |
|------|------|------|------|
| P0 | 8個核心模塊開發 | 8小時 | ✅ 已完成 |
| P2.1 | 更新 SelfLearningTrader | 2小時 | ⏸️ 待執行 |
| P2.2 | 適配 BinanceClient | 3小時 | ⏸️ 待執行 |
| P2.3 | 更新主循環 | 4小時 | ⏸️ 待執行 |
| P3 | 測試與調優 | 4小時 | ⏸️ 待執行 |
| **總計** | | **21小時** | **38% 完成** |

---

## 🎯 立即行動步驟

### 如果你想**立即部署使用**:

1. **簡化整合**（最快路徑，2-3小時）:
   - 僅實施步驟 1（添加字段）
   - 僅實施步驟 2（API 適配）
   - 使用最小化的主循環更新
   - 暫時不啟動 PositionMonitor24x7 和 DailyReporter

2. **驗證核心功能**:
   ```bash
   # 測試槓桿計算
   python -c "from src.core.leverage_engine import *; from src.core.config_profile import *; e = LeverageEngine(ConfigProfile()); print(e.calculate_leverage(0.70, 0.80))"
   ```

3. **逐步啟用**:
   - 第1週：Controller + LeverageEngine
   - 第2週：PositionMonitor24x7
   - 第3週：ModelRatingEngine + DailyReporter

### 如果你想**完整實施**:

1. 依序完成步驟 1 → 2 → 3
2. 添加單元測試
3. 本地測試 → Railway 測試 → 生產部署

---

## ✅ 驗收標準

完成整合後，應該能夠看到：

```
# 啟動日誌
✅ SelfLearningTraderController 初始化完成（v3.17+）
   🎯 模式: 絕對控制權（無限制槓桿）
✅ 24/7 倉位監控已啟動
✅ 每日報告系統已啟動

# 交易日誌
✅ BTCUSDT SHORT | 勝率:62% 信心:68% → 槓桿:8.5x | 數量:0.125 ...

# 監控日誌（每2秒）
📊 檢查 3 個活躍倉位

# 每日報告（00:00 UTC）
[MODEL_EVALUATOR] 📊 每日報告
✅ 評分: 78.5/100 (等級: B)
```

---

**文檔版本**: v1.0  
**最後更新**: 2025-10-28  
**下一次審查**: 完成整合後
