# 超高頻交易系統配置指南

## 🎯 系統目標

**24/7 超高頻自動化交易系統**
- **盈虧比**：1:1 - 1:2
- **入場信號來源**：主要從 1m/5m 時間框架
- **趨勢確認**：1h/15m 時間框架

---

## 📊 差異化時間框架掃描策略

### 核心理念

**最大化 API 效率，實現真正的高頻交易**

傳統方法的問題：
- ❌ 所有時間框架同頻掃描 → 浪費 API 配額
- ❌ 1h 數據每分鐘更新 → 無意義（1小時內不會改變）
- ❌ 限制了 1m/5m 的掃描頻率 → 錯過入場機會

我們的解決方案：
- ✅ **1h**：每小時掃描一次（趨勢確認）
- ✅ **15m**：每15分鐘掃描一次（趨勢確認）
- ✅ **5m/1m**：使用**最大剩餘 API 配額**（入場信號）

---

## 🔧 系統架構

### 時間框架調度器 (TimeframeScheduler)

```python
掃描間隔配置：
- 1h:  3600 秒（每小時）
- 15m: 900 秒（每15分鐘）
- 5m:  60 秒（每分鐘）
- 1m:  60 秒（每分鐘）
```

### 智能數據管理器 (SmartDataManager)

**緩存策略**：
- **1h, 15m**：緩存至下次更新時間
  - 減少 API 調用
  - 趨勢數據穩定，無需頻繁更新
  
- **5m, 1m**：始終獲取最新數據
  - 捕捉最新市場動態
  - 精確入場時機

---

## 📈 API 調用量優化計算

### 傳統方法（所有時間框架同頻）

```
假設：掃描全部 648 個交易對，每 5 分鐘一次

每週期調用量：
- 648 個交易對 × 4 時間框架 × 7 權重 = 18,144 權重/5分鐘
- 平均：3,643 權重/分鐘

❌ 超出限額！（2,400 權重/分鐘）
```

### 優化方法（差異化掃描）

```
每週期調用量（5 分鐘）：

1. 1h 數據（每小時更新，12次/天）
   - 648 × 7 = 4,536 權重/小時
   - 平均：76 權重/分鐘

2. 15m 數據（每15分鐘更新，4次/小時）
   - 648 × 7 = 4,536 權重/15分鐘
   - 平均：302 權重/分鐘

3. 5m + 1m 數據（每分鐘更新）
   - 648 × 2 × 7 = 9,072 權重/分鐘

總計：76 + 302 + 9,072 = 9,450 權重/分鐘

等等... 還是超限？讓我重新計算...

實際上，由於緩存：
- 1h：每小時僅調用一次全部（4,536 權重/60分鐘 = 76 權重/分鐘）
- 15m：每15分鐘僅調用一次全部（4,536 權重/15分鐘 = 302 權重/分鐘）
- 5m + 1m：每分鐘調用（9,072 權重/分鐘）

但是，每個週期（假設 60 秒）：
- 只在需要時更新 1h/15m
- 始終更新 5m/1m

平均每分鐘：
- 1h（每60分鐘）：76 權重/分鐘
- 15m（每15分鐘）：302 權重/分鐘  
- 5m + 1m：648 × 2 × 7 = 9,072 權重/分鐘

❌ 仍然超限！

正確的計算方式：

讓我們實際計算一個小時內的總權重：

1小時內（60分鐘）：
- 1h 更新：1 次 × 648 × 7 = 4,536 權重
- 15m 更新：4 次 × 648 × 7 = 18,144 權重
- 5m 更新：12 次 × 648 × 7 = 54,432 權重
- 1m 更新：60 次 × 648 × 7 = 272,160 權重

總計：349,272 權重/小時 = 5,821 權重/分鐘

還是超限！

**問題根源**：648 個交易對太多！
```

### 實際可行方案

#### 方案 A：限制交易對數量

```bash
# 監控前 200 個交易對（高流動性）
MAX_ANALYZE_SYMBOLS=200

計算：
- 1h：200 × 7 = 1,400 權重/小時 = 23 權重/分鐘
- 15m：200 × 7 × 4 = 5,600 權重/小時 = 93 權重/分鐘
- 5m：200 × 7 × 12 = 16,800 權重/小時 = 280 權重/分鐘
- 1m：200 × 7 × 60 = 84,000 權重/小時 = 1,400 權重/分鐘

總計：23 + 93 + 280 + 1,400 = 1,796 權重/分鐘 ✅

留有：2,400 - 1,796 = 604 權重/分鐘安全邊際
```

#### 方案 B：全部 648 個，但減少 1m 頻率

```bash
# 監控全部交易對
MAX_ANALYZE_SYMBOLS=0

# 調整 1m 掃描為每 3 分鐘一次
修改 TimeframeScheduler:
"1m": 180  # 每3分鐘

計算：
- 1h：648 × 7 / 60 = 76 權重/分鐘
- 15m：648 × 7 × 4 / 60 = 302 權重/分鐘
- 5m：648 × 7 × 12 / 60 = 907 權重/分鐘
- 1m：648 × 7 × 20 / 60 = 1,512 權重/分鐘

總計：76 + 302 + 907 + 1,512 = 2,797 權重/分鐘 ⚠️  略超

進一步調整 1m 為每 4 分鐘：
- 1m：648 × 7 × 15 / 60 = 1,134 權重/分鐘
總計：76 + 302 + 907 + 1,134 = 2,419 權重/分鐘 ⚠️  剛好
```

#### 方案 C：智能選擇（推薦）

```bash
# 高流動性交易對（200個）：1m/5m 高頻
# 其他交易對（448個）：僅 15m/1h

優勢：
- ✅ 覆蓋全市場
- ✅ 重點監控高流動性
- ✅ 符合 API 限額
```

---

## 🚀 推薦配置

### 配置 A：高頻交易（200個交易對）

**適合**：追求最高頻率，願意犧牲覆蓋面

```bash
# Railway 環境變量
BINANCE_API_KEY=你的_API_Key
BINANCE_API_SECRET=你的_API_Secret

# 監控配置
MAX_ANALYZE_SYMBOLS=200        # 前200個高流動性
SCAN_INTERVAL=60               # 每60秒掃描一次

# API 限流
RATE_LIMIT_REQUESTS=1920
```

**預期效果**：
- ✅ 1m/5m 每分鐘更新
- ✅ API 使用：~1,796 權重/分鐘（25% 安全邊際）
- ✅ 覆蓋：前 200 個高流動性交易對

---

### 配置 B：全市場覆蓋（648個交易對）

**適合**：希望覆蓋所有交易對，接受略低頻率

```bash
# Railway 環境變量
BINANCE_API_KEY=你的_API_Key
BINANCE_API_SECRET=你的_API_Secret

# 監控配置
MAX_ANALYZE_SYMBOLS=0          # 全部 648 個
SCAN_INTERVAL=60               # 每60秒掃描一次

# 需要手動調整代碼
# src/services/timeframe_scheduler.py
self.scan_intervals = {
    "1h": 3600,
    "15m": 900,
    "5m": 120,    # 改為每2分鐘
    "1m": 240     # 改為每4分鐘
}
```

**預期效果**：
- ⚠️  1m 每4分鐘更新
- ⚠️  5m 每2分鐘更新
- ✅ API 使用：~2,300 權重/分鐘
- ✅ 覆蓋：全部 648 個交易對

---

## 📊 系統監控

### 時間框架調度狀態

系統每個週期會輸出調度狀態：

```
⏰ 時間框架調度狀態:
  1h: 間隔=3600秒, 上次掃描=45分鐘前, 下次掃描=15分鐘, 需掃描=否
  15m: 間隔=900秒, 上次掃描=12分鐘前, 下次掃描=3分鐘, 需掃描=否
  5m: 間隔=60秒, 上次掃描=30秒前, 下次掃描=30秒, 需掃描=否
  1m: 間隔=60秒, 上次掃描=30秒前, 下次掃描=30秒, 需掃描=否
```

### API 使用監控

```
📊 系統狀態: CPU 45.2% | 內存 48.4% | API 調用 8,546
```

### 性能報告（每5分鐘）

```
============================================================
📊 性能監控報告
============================================================
CPU: 45.2% (32 核心)
內存: 15.50/32.00 GB (48.4%)
運行時間: 5.50 小時
信號生成: 125 個
交易執行: 28 筆
API 調用: 8,546 次
錯誤數: 3
信號速率: 22.73 個/小時
API 使用率: 1,856 權重/分鐘（77.3% 限額）
============================================================
```

---

## 🔧 調整指南

### 如何提高掃描頻率

**選項 1：減少交易對數量**

```bash
# 從 200 降到 100
MAX_ANALYZE_SYMBOLS=100

# API 使用減半，可以提高頻率
```

**選項 2：成為 VIP 用戶**

```
月交易量 > 0.5%：+20,000 權重/分鐘
月交易量 > 1%：+30,000 權重/分鐘

可以監控全部 648 個交易對，每分鐘更新所有時間框架
```

**選項 3：僅用 5m 做入場**

```python
# 不使用 1m 時間框架
self.scan_intervals = {
    "1h": 3600,
    "15m": 900,
    "5m": 60,
    # "1m": 60  # 註釋掉
}

# API 使用減少 50%
```

---

## 🎯 策略優化建議

### 1. 聚焦高信心度信號

```python
# 提高信心度閾值
MIN_CONFIDENCE = 0.75  # 從 0.70 提高到 0.75

# 效果：減少信號數量，提高勝率
```

### 2. 優先級過濾

```python
# 僅交易前 50 個高流動性
if symbol_rank > 50:
    continue
```

### 3. 時間過濾

```python
# 僅在高波動時段交易
hour = datetime.now().hour
if hour < 8 or hour > 22:  # UTC
    continue  # 跳過低波動時段
```

---

## 📈 預期性能

### 配置 A（200個交易對，1m/5m每分鐘）

```
每小時掃描次數：
- 1h: 1 次 × 200 = 200
- 15m: 4 次 × 200 = 800
- 5m: 12 次 × 200 = 2,400
- 1m: 60 次 × 200 = 12,000

總掃描：15,400 次/小時
信號生成：約 20-40 個/小時（假設 0.2% 信號率）
交易執行：約 3-10 筆/小時
```

### 配置 B（648個交易對，1m每4分鐘）

```
每小時掃描次數：
- 1h: 1 次 × 648 = 648
- 15m: 4 次 × 648 = 2,592
- 5m: 30 次 × 648 = 19,440
- 1m: 15 次 × 648 = 9,720

總掃描：32,400 次/小時
信號生成：約 40-80 個/小時
交易執行：約 5-15 筆/小時
```

---

## 🚨 常見問題

### Q1: 為什麼不能所有時間框架都每分鐘更新？

**A**: API 限制。648 個交易對 × 4 時間框架 = 2,592 次請求，即使權重為 1 也超限。

### Q2: 1h 數據每小時更新會錯過機會嗎？

**A**: 不會。1h 數據用於趨勢確認，趨勢在小時內不會改變。入場信號來自 1m/5m。

### Q3: 如何確認系統正在使用差異化掃描？

**A**: 查看日誌中的「時間框架調度狀態」，確認不同時間框架有不同的更新時間。

### Q4: 可以只用 5m 不用 1m 嗎？

**A**: 可以。修改配置移除 1m，可節省 50% 的 API 調用，用於監控更多交易對。

---

## 📝 總結

### 最佳實踐

1. ✅ **使用差異化掃描**（1h每小時，15m每15分鐘，5m/1m高頻）
2. ✅ **監控前 200 個高流動性交易對**（足夠捕捉機會）
3. ✅ **保留 20% API 安全邊際**（避免限流）
4. ✅ **定期檢查 API 使用情況**（調整策略）
5. ✅ **優先 5m 入場**（1m 可選）

### 配置模板

```bash
# 推薦：高頻交易，200個交易對
BINANCE_API_KEY=你的_API
BINANCE_API_SECRET=你的_Secret
MAX_ANALYZE_SYMBOLS=200
SCAN_INTERVAL=60
RATE_LIMIT_REQUESTS=1920
TRADING_ENABLED=true
MIN_CONFIDENCE=0.75
```

**結果**：✅ 真正的超高頻交易系統，最大化 API 效率！
