# 全幣種監控與多 API 配置指南

## 📊 監控全部 648 個 U 本位合約幣種

系統現已優化支持監控**所有** Binance USDT 永續合約交易對。

### 環境變量配置

```bash
# 分析所有幣種（默認）
ANALYZE_ALL_SYMBOLS=true

# 或限制分析數量（0 = 全部）
MAX_ANALYZE_SYMBOLS=0     # 分析全部 648 個
# MAX_ANALYZE_SYMBOLS=200  # 僅分析前 200 個
```

---

## 🔑 多 API Key 架構說明

### Binance API 限流機制

```
重要：限流是按 IP 地址計算，不是按 API Key

REQUEST_WEIGHT: 2400/分鐘/IP  ← 所有 API Key 共享此限額
訂單限制: 1200/分鐘/API Key   ← 每個 API Key 獨立
```

### 結論

❌ **多個 API Key 用於數據收集無效**
- 所有請求來自同一個 Railway IP
- 仍然共享 2400 權重/分鐘的限額
- 無法突破 IP 級別的限流

✅ **分離交易 API 有意義**
- 避免訂單限制影響數據收集
- 提高交易執行穩定性
- 更好的錯誤隔離

---

## 🚀 推薦配置方案

### 方案 A：單 API（簡單方案）

適合：小規模交易，訂單量 < 100/分鐘

```bash
# 僅需一個 API Key
BINANCE_API_KEY=你的_主API_Key
BINANCE_API_SECRET=你的_主API_Secret

# 系統自動用於數據和交易
```

**優點**：
- ✅ 配置簡單
- ✅ 管理方便

**缺點**：
- ⚠️  數據收集和交易共享訂單限額

---

### 方案 B：雙 API（推薦方案）

適合：高頻交易，訂單量 > 100/分鐘

```bash
# 主 API（數據收集）
BINANCE_API_KEY=數據_API_Key
BINANCE_API_SECRET=數據_API_Secret

# 交易專用 API（執行訂單）
BINANCE_TRADING_API_KEY=交易_API_Key
BINANCE_TRADING_API_SECRET=交易_API_Secret
```

**優點**：
- ✅ 訂單限額獨立（數據 1200/分鐘 + 交易 1200/分鐘 = 2400/分鐘）
- ✅ 錯誤隔離（交易失敗不影響數據收集）
- ✅ 更好的穩定性

**缺點**：
- ⚠️  需要管理兩個 API Key
- ⚠️  仍然共享 IP 級別的 2400 權重/分鐘限額

**重要提醒**：
- 兩個 API 必須屬於同一個 Binance 帳號
- 權重限額仍然是共享的（2400/分鐘/IP）
- 僅訂單數量限額是獨立的

---

## 📈 全幣種監控 API 調用量分析

### 每週期（5 分鐘）API 調用量

#### 市場掃描
```
獲取 648 個交易對的 24h ticker
權重：40（batch API）
調用次數：1 次
```

#### K 線數據獲取（全部 648 個幣種）
```
每個交易對：4 個時間框架（1h/15m/5m/1m）
每次 K 線請求：權重 5-10（取平均 7）

總權重：648 × 4 × 7 = 18,144 權重
```

#### 賬戶查詢
```
獲取賬戶信息：權重 5
獲取持倉：權重 5
調用次數：每週期 2 次
總權重：10
```

#### 交易執行（假設 10 個信號）
```
下單：權重 1/訂單
止盈止損：權重 1/訂單
總權重：10 × 2 = 20
```

### 總計（每 5 分鐘）
```
總權重：40 + 18,144 + 10 + 20 = 18,214 權重/5分鐘
平均權重：18,214 / 5 = 3,643 權重/分鐘
```

### ⚠️  問題：超過限額！

**官方限額**：2,400 權重/分鐘  
**實際需求**：3,643 權重/分鐘  
**超出**：+52%（**會觸發限流！**）

---

## 🛠️ 優化方案：突破限流

### 方案 1：增加掃描間隔（推薦）

```bash
# 將掃描間隔從 5 分鐘調整為 8 分鐘
SCAN_INTERVAL=480  # 秒

# 計算：
# 18,214 權重 / 8 分鐘 = 2,277 權重/分鐘 ✅ 低於 2,400
```

**優點**：
- ✅ 簡單有效
- ✅ 完全符合限額
- ✅ 仍然高頻監控

---

### 方案 2：減少時間框架

```python
# 修改 src/services/data_service.py
self.timeframes = ["1h", "15m"]  # 僅用 2 個時間框架

# 計算：
# 648 × 2 × 7 = 9,072 權重/5分鐘
# 9,072 / 5 = 1,814 權重/分鐘 ✅ 低於 2,400
```

**優點**：
- ✅ 保持 5 分鐘間隔
- ✅ 符合限額

**缺點**：
- ⚠️  策略準確性可能降低（缺少 5m/1m 確認）

---

### 方案 3：智能緩存（最優方案）

利用緩存減少重複請求：

```bash
# 增加緩存 TTL
CACHE_TTL_KLINES=60  # K 線緩存 60 秒（默認 30 秒）
```

**實際效果**：
- 第一次掃描：完整 API 調用
- 後續掃描（60 秒內）：從緩存讀取
- 減少約 30-40% 的 API 調用

```
實際權重：3,643 × 0.6 = 2,186 權重/分鐘 ✅
```

**優點**：
- ✅ 最優方案
- ✅ 保持高頻和多時間框架
- ✅ 顯著減少 API 調用

---

## 🎯 推薦最終配置

### 標準配置（全幣種監控）

```bash
# === API 配置 ===
# 主 API（數據收集）
BINANCE_API_KEY=數據_API_Key
BINANCE_API_SECRET=數據_API_Secret

# 交易專用 API（可選但推薦）
BINANCE_TRADING_API_KEY=交易_API_Key
BINANCE_TRADING_API_SECRET=交易_API_Secret

# === 監控配置 ===
# 分析所有 648 個幣種
ANALYZE_ALL_SYMBOLS=true
MAX_ANALYZE_SYMBOLS=0

# 掃描間隔：8 分鐘（平衡頻率和限額）
SCAN_INTERVAL=480

# === 限流配置 ===
# 使用 80% 限額（留 20% 安全邊際）
RATE_LIMIT_REQUESTS=1920

# === 緩存優化 ===
# 延長緩存時間減少 API 調用
CACHE_TTL_KLINES=60
CACHE_TTL_TICKER=10
```

### 預期性能

```
✅ 監控交易對：648 個（全部）
✅ 時間框架：4 個（1h/15m/5m/1m）
✅ 掃描頻率：每 8 分鐘
✅ 平均權重：~2,277 權重/分鐘（低於 2,400）
✅ 信號延遲：< 8 分鐘
✅ CPU 利用率：32 核心並行分析
```

---

## 📊 性能監控

### 檢查 API 使用情況

系統每 5 分鐘輸出性能報告：

```
============================================================
📊 性能監控報告
============================================================
CPU: 45.2% (32 核心)
內存: 15.50/32.00 GB (48.4%)
運行時間: 5.50 小時
信號生成: 125 個
交易執行: 28 筆
API 調用: 8,546 次  ← 重點關注
錯誤數: 3
信號速率: 22.73 個/小時
============================================================
```

### 監控 Binance 響應頭

系統自動檢查響應頭：
- `X-MBX-USED-WEIGHT-1M`: 已用權重
- `X-MBX-ORDER-COUNT-1M`: 訂單數量

如果接近限額，系統會：
1. 自動減慢請求速率
2. 觸發熔斷器保護
3. 發送 Discord 警報

---

## 🚨 常見問題

### Q1: 使用多個不同帳號的 API 可以突破限制嗎？

**A**: 不行，限流是按 **IP 地址** 計算。即使使用不同帳號的 API，來自同一 Railway IP 的所有請求仍然共享 2,400 權重/分鐘的限額。

### Q2: 如何真正突破 2,400 權重/分鐘的限制？

**A**: 僅有兩種方法：
1. **成為 VIP 用戶**：月交易量 >0.5% 可獲得 +20,000 權重/分鐘
2. **使用多個 IP**：部署多個 Railway 實例（不同 IP），每個獨立計算限額

### Q3: 當前配置能否監控全部 648 個幣種？

**A**: 可以，但需要調整掃描間隔：
- 8 分鐘間隔 ✅（推薦）
- 或減少時間框架
- 或優化緩存策略

### Q4: 分離數據和交易 API 真的有幫助嗎？

**A**: 有限幫助：
- ✅ 訂單限額獨立（1200 + 1200 = 2400 訂單/分鐘）
- ❌ 權重限額仍共享（2400 權重/分鐘/IP）
- ✅ 錯誤隔離（提高穩定性）

---

## 📝 總結建議

### 監控全部 648 個幣種的最佳實踐：

1. ✅ **使用雙 API 配置**（數據 + 交易）
2. ✅ **掃描間隔設為 8 分鐘**（平衡頻率和限額）
3. ✅ **啟用智能緩存**（減少重複請求）
4. ✅ **限流設為 1920**（留 20% 安全邊際）
5. ✅ **監控 API 使用情況**（定期檢查日誌）

### 配置命令：

```bash
# 在 Railway 環境變量中設置
BINANCE_API_KEY=數據_API
BINANCE_API_SECRET=數據_Secret
BINANCE_TRADING_API_KEY=交易_API
BINANCE_TRADING_API_SECRET=交易_Secret
ANALYZE_ALL_SYMBOLS=true
MAX_ANALYZE_SYMBOLS=0
SCAN_INTERVAL=480
RATE_LIMIT_REQUESTS=1920
CACHE_TTL_KLINES=60
```

**結果**：✅ 完整監控 648 個交易對，符合 API 限額！
