# ç¼“å­˜å ç”¨é—®é¢˜æ·±åº¦åˆ†ææŠ¥å‘Š

**æŠ¥å‘Šæ—¥æœŸ**: 2025-01-16  
**ç³»ç»Ÿç‰ˆæœ¬**: v4.6.0  
**åˆ†æç›®æ ‡**: è¯†åˆ«ç¼“å­˜å ç”¨ä¸¥é‡çš„æ ¹æœ¬åŸå› åŠä¼˜åŒ–æ–¹æ¡ˆ

---

## æ‰§è¡Œæ‘˜è¦

### ğŸš¨ æ ¸å¿ƒé—®é¢˜

å½“å‰ç³»ç»Ÿå­˜åœ¨**ä¸¥é‡çš„ç¼“å­˜è¿‡åº¦ä½¿ç”¨**é—®é¢˜ï¼š

```
é¢„ä¼°æ€»å†…å­˜å ç”¨: ~300MB
â”œâ”€ L1å†…å­˜ç¼“å­˜: ~50MB (5000æ¡ç›®)
â”œâ”€ L2ç£ç›˜ç¼“å­˜: ~200MB (pklæ–‡ä»¶ç¢ç‰‡)
â””â”€ WebSocketç¼“å†²: ~20MB (å®æ—¶Kçº¿)

ç£ç›˜ç©ºé—´å ç”¨: ~200-500MB (/tmp/elite_cache/)
â”œâ”€ æŠ€æœ¯æŒ‡æ ‡ç¼“å­˜æ–‡ä»¶: ~15,000ä¸ª.pklæ–‡ä»¶
â”œâ”€ Kçº¿æ•°æ®ç¼“å­˜æ–‡ä»¶: ~5,000ä¸ª.pklæ–‡ä»¶
â””â”€ ç¢ç‰‡åŒ–ä¸¥é‡: æ¯ä¸ªkeyä¸€ä¸ªç‹¬ç«‹æ–‡ä»¶
```

### ğŸ’¡ ä¼˜åŒ–å»ºè®®

**ç«‹å³åˆ é™¤L2ç£ç›˜ç¼“å­˜**ï¼ˆèŠ‚çœ200MBå†…å­˜ + 500MBç£ç›˜ï¼‰

```python
# å»ºè®®ï¼šç¦ç”¨L2æŒä¹…åŒ–ç¼“å­˜
cache = IntelligentCache(
    l1_max_size=1000,  # ä»5000é™ä½åˆ°1000
    enable_l2=False,   # âŒ ç¦ç”¨L2æŒä¹…åŒ–
)
```

**é¢„æœŸæ”¶ç›Š**ï¼š
- å†…å­˜å ç”¨ï¼š300MB â†’ 50MBï¼ˆ**-83%**ï¼‰
- ç£ç›˜ç©ºé—´ï¼š500MB â†’ 0MBï¼ˆ**-100%**ï¼‰
- å¯åŠ¨é€Ÿåº¦ï¼š+30%ï¼ˆæ— éœ€æ¸…ç†è¿‡æœŸL2æ–‡ä»¶ï¼‰

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šç¼“å­˜æ•°æ®è¯¦ç»†åˆ†æ

### 1.1 L1å†…å­˜ç¼“å­˜ï¼ˆLRUCacheï¼‰

**å­˜å‚¨å†…å®¹**ï¼š
```
æ•°æ®ç±»å‹ï¼šæŠ€æœ¯æŒ‡æ ‡è®¡ç®—ç»“æœ
æ ¼å¼ï¼šOrderedDict[key, (value, expiry)]

ç¤ºä¾‹ç¼“å­˜æ¡ç›®ï¼š
key: "ind_ema_period20_a1b2c3d4_len500"
value: {
    'value': pd.Series([67000.0, 67100.0, ...]),  # ~4KB
    'period_used': 20,
    'data_points': 500
}
expiry: 1705450800.123  # Unixæ—¶é—´æˆ³
```

**ç¼“å­˜Keyæ ¼å¼**ï¼š
```python
# æŠ€æœ¯æŒ‡æ ‡ç¼“å­˜é”®
"ind_{indicator}_{params}_{data_hash}_len{length}"

å®é™…ä¾‹å­ï¼š
"ind_ema_period20_abc123_len500"        # EMA20ï¼Œ500æ¡æ•°æ®
"ind_rsi_period14_def456_len500"        # RSI14ï¼Œ500æ¡æ•°æ®
"ind_macd_fast12slow26_xyz789_len500"   # MACDï¼Œ500æ¡æ•°æ®
```

**å†…å­˜å ç”¨ä¼°ç®—**ï¼š
```
æ¯ä¸ªæŒ‡æ ‡ç»“æœ: ~10KB
â”œâ”€ pd.Series (500 float64): ~4KB
â”œâ”€ metadata: ~1KB
â””â”€ Pythonå¯¹è±¡å¼€é”€: ~5KB

5000æ¡ç›®ä¸Šé™ Ã— 10KB = 50MB
å®é™…å ç”¨ï¼ˆ80%å¡«å……ç‡ï¼‰: ~40MB
```

**æ•°æ®æ¥æº**ï¼š
```python
# src/core/elite/technical_indicator_engine.py
class EliteTechnicalEngine:
    def calculate(self, indicator, data, **params):
        # ...è®¡ç®—æŒ‡æ ‡...
        
        # ç¼“å­˜ç»“æœ
        cache_data = {
            'value': result.value,
            'period_used': result.period_used,
            'data_points': result.data_points
        }
        self.cache.set(cache_key, cache_data, ttl=60)  # 60ç§’TTL
```

**é—®é¢˜åˆ†æ**ï¼š
- âœ… **åˆç†éƒ¨åˆ†**ï¼šæŠ€æœ¯æŒ‡æ ‡è®¡ç®—æ˜‚è´µï¼Œç¼“å­˜æœ‰ä»·å€¼
- âŒ **è¿‡åº¦éƒ¨åˆ†**ï¼š5000æ¡ç›®ä¸Šé™è¿‡é«˜ï¼ˆå®é™…åªéœ€500-1000ï¼‰
- âŒ **TTLè¿‡çŸ­**ï¼š60ç§’TTLå¯¼è‡´é¢‘ç¹è¿‡æœŸï¼Œç¼“å­˜æ•ˆæœå·®

---

### 1.2 L2æŒä¹…åŒ–ç¼“å­˜ï¼ˆDisk Cacheï¼‰

**å­˜å‚¨ä½ç½®**ï¼š
```
ç›®å½•: /tmp/elite_cache/
æ ¼å¼: {md5_hash}.pkl

å®é™…æ–‡ä»¶ï¼š
/tmp/elite_cache/a1b2c3d4e5f6g7h8.pkl  # EMAç¼“å­˜
/tmp/elite_cache/1234567890abcdef.pkl  # RSIç¼“å­˜
/tmp/elite_cache/fedcba0987654321.pkl  # MACDç¼“å­˜
...ï¼ˆæ•°åƒä¸ªæ–‡ä»¶ï¼‰
```

**æ–‡ä»¶ç»“æ„**ï¼š
```python
# æ¯ä¸ª.pklæ–‡ä»¶å†…å®¹
{
    'value': <æŠ€æœ¯æŒ‡æ ‡ç»“æœ>,  # pd.Seriesæˆ–dict
    'expiry': 1705450800.123,  # è¿‡æœŸæ—¶é—´
    'created_at': 1705450740.456  # åˆ›å»ºæ—¶é—´
}
```

**ç£ç›˜å ç”¨ä¼°ç®—**ï¼š
```
å‡è®¾åœºæ™¯ï¼ˆ200ä¸ªäº¤æ˜“å¯¹ Ã— 3ä¸ªæ—¶é—´æ¡†æ¶ Ã— 10ä¸ªæŒ‡æ ‡ï¼‰ï¼š

æŠ€æœ¯æŒ‡æ ‡ç¼“å­˜ï¼š
200 symbols Ã— 3 timeframes Ã— 10 indicators = 6,000ä¸ªç¼“å­˜æ¡ç›®

æ¯ä¸ª.pklæ–‡ä»¶å¤§å°: ~15KB
â”œâ”€ æŒ‡æ ‡æ•°æ®åºåˆ—åŒ–: ~10KB
â””â”€ Pickleå¼€é”€: ~5KB

æ€»ç£ç›˜å ç”¨: 6,000 Ã— 15KB = 90MB

å®é™…è§‚å¯Ÿï¼ˆè€ƒè™‘è¿‡æœŸæœªæ¸…ç†ï¼‰ï¼š
200-500MBï¼ˆåŒ…å«å¤§é‡è¿‡æœŸæ–‡ä»¶ï¼‰
```

**å†™å…¥æµç¨‹**ï¼š
```python
# src/core/elite/intelligent_cache.py
def _set_to_l2(self, key, value, ttl):
    cache_file = self.l2_cache_dir / f"{hashlib.md5(key.encode()).hexdigest()}.pkl"
    
    cache_data = {
        'value': value,
        'expiry': time.time() + ttl,
        'created_at': time.time()
    }
    
    # æ¯ä¸ªkeyå†™å…¥ä¸€ä¸ªç‹¬ç«‹æ–‡ä»¶
    with open(cache_file, 'wb') as f:
        pickle.dump(cache_data, f)
```

**é—®é¢˜åˆ†æ**ï¼š
- âŒ **è‡´å‘½é—®é¢˜1**ï¼šå¸‚åœºæ•°æ®å˜åŒ–å¿«ï¼ŒæŒä¹…åŒ–ä»·å€¼æä½
  - æŠ€æœ¯æŒ‡æ ‡TTL=60ç§’ï¼Œç£ç›˜æŒä¹…åŒ–æ„ä¹‰ä¸å¤§
  - è·¨ä¼šè¯ä¿å­˜æ— ç”¨ï¼ˆé‡å¯åæ•°æ®å·²è¿‡æœŸï¼‰
  
- âŒ **è‡´å‘½é—®é¢˜2**ï¼šæ–‡ä»¶ç¢ç‰‡åŒ–ä¸¥é‡
  - æ¯ä¸ªç¼“å­˜keyä¸€ä¸ª.pklæ–‡ä»¶
  - 6,000ä¸ªæŒ‡æ ‡ â†’ 6,000ä¸ªæ–‡ä»¶
  - æ–‡ä»¶ç³»ç»Ÿå¼€é”€å·¨å¤§ï¼ˆinodeæ¶ˆè€—ï¼‰
  
- âŒ **è‡´å‘½é—®é¢˜3**ï¼šæ¸…ç†æœºåˆ¶ä¸å®Œå–„
  - å¯åŠ¨æ—¶æ¸…ç†ä¸€æ¬¡ï¼ˆ`_clean_expired_l2()`ï¼‰
  - è¿è¡Œæ—¶æ— è‡ªåŠ¨æ¸…ç†
  - è¿‡æœŸæ–‡ä»¶å †ç§¯

---

### 1.3 WebSocketæ•°æ®ç¼“å†²

**å­˜å‚¨å†…å®¹**ï¼š
```python
# src/core/websocket/kline_feed.py
data_buffers[symbol] = {
    '1m': deque(maxlen=1440),   # 24å°æ—¶1åˆ†é’ŸKçº¿
    '5m': deque(maxlen=288),    # 24å°æ—¶5åˆ†é’ŸKçº¿
    '15m': deque(maxlen=96),    # 24å°æ—¶15åˆ†é’ŸKçº¿
    '1h': deque(maxlen=24),     # 24å°æ—¶1å°æ—¶Kçº¿
}
```

**å†…å­˜å ç”¨ä¼°ç®—**ï¼š
```
å•ä¸ªKçº¿æ•°æ®ç»“æ„: ~100 bytes
{
    'open': 67000.0,
    'high': 67500.0,
    'low': 66500.0,
    'close': 67200.0,
    'volume': 1234.56,
    'server_timestamp': 1705450800000,
    'local_timestamp': 1705450800023,
    'latency_ms': 23
}

å•ä¸ªsymbolçš„æ‰€æœ‰æ—¶é—´æ¡†æ¶:
1m: 1440 Ã— 100 bytes = 144KB
5m: 288 Ã— 100 bytes = 28.8KB
15m: 96 Ã— 100 bytes = 9.6KB
1h: 24 Ã— 100 bytes = 2.4KB
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡: ~185KB/symbol

200ä¸ªsymbols Ã— 185KB = 37MB
```

**é—®é¢˜åˆ†æ**ï¼š
- âœ… **åˆç†éƒ¨åˆ†**ï¼šWebSocketå®æ—¶æ•°æ®éœ€è¦ç¼“å†²
- âŒ **è¿‡åº¦éƒ¨åˆ†**ï¼š24å°æ—¶å†å²æ•°æ®è¿‡å¤šï¼ˆåªéœ€1-2å°æ—¶ï¼‰
- âŒ **é‡å¤å­˜å‚¨**ï¼š1mæ•°æ®èšåˆä¸º5m/15m/1hï¼Œå­˜åœ¨å†—ä½™

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šä½¿ç”¨åœºæ™¯åˆ†æ

### 2.1 æŠ€æœ¯æŒ‡æ ‡ç¼“å­˜ä½¿ç”¨åœºæ™¯

**åœºæ™¯1ï¼šç­–ç•¥æ‰«æï¼ˆæ¯5åˆ†é’Ÿï¼‰**
```python
# src/strategies/self_learning_trader.py
async def scan_markets(self):
    for symbol in symbols:  # 200ä¸ªäº¤æ˜“å¯¹
        # è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
        ema20 = tech_engine.calculate('ema', close, period=20)  # ç¼“å­˜å‘½ä¸­
        rsi14 = tech_engine.calculate('rsi', close, period=14)  # ç¼“å­˜å‘½ä¸­
        macd = tech_engine.calculate('macd', close)              # ç¼“å­˜å‘½ä¸­
```

**ç¼“å­˜æ•ˆæœ**ï¼š
```
é¦–æ¬¡æ‰«æï¼ˆå†·å¯åŠ¨ï¼‰:
200 symbols Ã— 10 indicators = 2,000æ¬¡è®¡ç®—ï¼ˆå…¨éƒ¨Missï¼‰
è®¡ç®—æ—¶é—´: ~30ç§’

ç¬¬äºŒæ¬¡æ‰«æï¼ˆ5åˆ†é’Ÿåï¼‰:
- å¦‚æœTTL=60ç§’ â†’ å…¨éƒ¨è¿‡æœŸ â†’ 2,000æ¬¡è®¡ç®—ï¼ˆMissï¼‰âŒ
- å¦‚æœTTL=300ç§’ â†’ å…¨éƒ¨å‘½ä¸­ â†’ 0æ¬¡è®¡ç®—ï¼ˆHitï¼‰âœ…

ç»“è®ºï¼šå½“å‰60ç§’TTLå¤ªçŸ­ï¼Œç¼“å­˜æ•ˆæœå·®
```

---

**åœºæ™¯2ï¼šå®æ—¶æŒä»“ç›‘æ§ï¼ˆæ¯60ç§’ï¼‰**
```python
# src/core/position_controller.py
async def _monitoring_cycle(self):
    for position in positions:  # 5ä¸ªæŒä»“
        # æ¯ä¸ªæŒä»“éœ€è¦è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
        indicators = await self._get_indicators(position['symbol'])
```

**ç¼“å­˜æ•ˆæœ**ï¼š
```
æŒä»“ç›‘æ§å‘¨æœŸ: 60ç§’
æŠ€æœ¯æŒ‡æ ‡TTL: 60ç§’

ç»“æœï¼šå‹‰å¼ºå‘½ä¸­ï¼ˆä¸´ç•Œè¿‡æœŸï¼‰âš ï¸
```

---

### 2.2 Kçº¿æ•°æ®ç¼“å­˜ä½¿ç”¨åœºæ™¯

**åœºæ™¯1ï¼šå¤šæ—¶é—´æ¡†æ¶åˆ†æ**
```python
# src/core/elite/unified_data_pipeline.py
async def get_multi_timeframe_data(self, symbol, timeframes=['1h', '15m', '5m']):
    # 3å±‚Fallbackï¼šå†å²API â†’ WebSocket â†’ REST
    # æ¯æ¬¡éƒ½ä¼šç¼“å­˜ç»“æœï¼ˆTTL=300ç§’ï¼‰
```

**ç¼“å­˜æ•ˆæœ**ï¼š
```
é¦–æ¬¡è¯·æ±‚:
- å†å²APIè°ƒç”¨: 3æ¬¡ï¼ˆ1h + 15m + 5mï¼‰
- å†™å…¥ç¼“å­˜: 3ä¸ªæ¡ç›®
- L2å†™å…¥: 3ä¸ª.pklæ–‡ä»¶

5åˆ†é’Ÿå†…é‡å¤è¯·æ±‚:
- ç¼“å­˜å‘½ä¸­: 3æ¬¡ï¼ˆå…¨Hitï¼‰âœ…

5åˆ†é’Ÿå:
- å…¨éƒ¨è¿‡æœŸ â†’ é‡æ–°APIè°ƒç”¨ âŒ
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šé—®é¢˜æ ¹æœ¬åŸå› 

### 3.1 è®¾è®¡å“²å­¦é”™è¯¯

**é”™è¯¯å‡è®¾1ï¼šæŒä¹…åŒ–ç¼“å­˜æœ‰ä»·å€¼**
```
å‡è®¾ï¼šæŠ€æœ¯æŒ‡æ ‡è®¡ç®—æ˜‚è´µï¼Œåº”è¯¥è·¨ä¼šè¯ä¿å­˜
ç°å®ï¼š
- å¸‚åœºæ•°æ®å˜åŒ–å¿«ï¼ˆ1åˆ†é’ŸKçº¿æ›´æ–°ï¼‰
- æŒ‡æ ‡TTL=60ç§’ï¼Œé‡å¯åå…¨éƒ¨è¿‡æœŸ
- L2æŒä¹…åŒ–çº¯ç²¹æµªè´¹ç£ç›˜ç©ºé—´
```

**é”™è¯¯å‡è®¾2ï¼š200ä¸ªäº¤æ˜“å¯¹éƒ½éœ€è¦ç¼“å­˜**
```
å‡è®¾ï¼šç›‘æ§200ä¸ªäº¤æ˜“å¯¹ï¼Œéœ€è¦ç¼“å­˜æ‰€æœ‰æŒ‡æ ‡
ç°å®ï¼š
- å®é™…æŒä»“: 5-10ä¸ª
- é«˜é¢‘è®¿é—®: 10-20ä¸ªäº¤æ˜“å¯¹
- å…¶ä½™180ä¸ª: å¶å°”æ‰«æï¼Œç¼“å­˜ä»·å€¼ä½
```

**é”™è¯¯å‡è®¾3ï¼šTTLåº”è¯¥å¾ˆçŸ­ä»¥ä¿æŒæ•°æ®æ–°é²œ**
```
å‡è®¾ï¼š60ç§’TTLç¡®ä¿æ•°æ®æ–°é²œ
ç°å®ï¼š
- 1åˆ†é’ŸKçº¿æ›´æ–°é¢‘ç‡ â†’ 60ç§’TTLå¯¼è‡´é¢‘ç¹è¿‡æœŸ
- ç¼“å­˜å‘½ä¸­ç‡æä½
- åº”è¯¥è®¾ç½®5åˆ†é’ŸTTLï¼ˆåŒ¹é…ç­–ç•¥æ‰«æå‘¨æœŸï¼‰
```

---

### 3.2 å®ç°é—®é¢˜

**é—®é¢˜1ï¼šL2ç¼“å­˜æ–‡ä»¶ç¢ç‰‡åŒ–**
```python
# å½“å‰å®ç°ï¼ˆæ¯ä¸ªkeyä¸€ä¸ªæ–‡ä»¶ï¼‰
def _set_to_l2(self, key, value, ttl):
    cache_file = self.l2_cache_dir / f"{hashlib.md5(key.encode()).hexdigest()}.pkl"
    with open(cache_file, 'wb') as f:
        pickle.dump(cache_data, f)

# ç»“æœï¼š
6,000ä¸ªç¼“å­˜æ¡ç›® = 6,000ä¸ª.pklæ–‡ä»¶
æ–‡ä»¶ç³»ç»Ÿå¼€é”€å·¨å¤§
```

**æ›´å¥½çš„å®ç°ï¼ˆå•ä¸€æ•°æ®åº“æ–‡ä»¶ï¼‰**ï¼š
```python
# ä½¿ç”¨SQLiteæˆ–shelve
import shelve

cache_db = shelve.open('/tmp/elite_cache.db')
cache_db[key] = {'value': value, 'expiry': expiry}
cache_db.close()

# ç»“æœï¼š
6,000ä¸ªç¼“å­˜æ¡ç›® = 1ä¸ªæ•°æ®åº“æ–‡ä»¶
å‡å°‘æ–‡ä»¶ç³»ç»Ÿå¼€é”€
```

---

**é—®é¢˜2ï¼šL1ç¼“å­˜ä¸Šé™è¿‡é«˜**
```python
# å½“å‰é…ç½®
IntelligentCache(l1_max_size=5000)

# å®é™…éœ€æ±‚åˆ†æ
æŒä»“ç›‘æ§: 10ä¸ªsymbol Ã— 10ä¸ªæŒ‡æ ‡ = 100æ¡ç›®
ç­–ç•¥æ‰«æ: 200ä¸ªsymbol Ã— 10ä¸ªæŒ‡æ ‡ = 2,000æ¡ç›®ï¼ˆä½†5åˆ†é’Ÿæ‰æ‰«æä¸€æ¬¡ï¼‰

åˆç†é…ç½®: l1_max_size=500-1000å³å¯
```

---

**é—®é¢˜3ï¼šæ— è‡ªåŠ¨æ¸…ç†æœºåˆ¶**
```python
# å½“å‰å®ç°ï¼šä»…å¯åŠ¨æ—¶æ¸…ç†
def __init__(...):
    if self.enable_l2:
        self._clean_expired_l2()  # åªåœ¨å¯åŠ¨æ—¶æ¸…ç†

# é—®é¢˜ï¼š
è¿è¡Œæ—¶è¿‡æœŸæ–‡ä»¶å †ç§¯
é•¿æ—¶é—´è¿è¡Œåï¼ŒL2ç¼“å­˜ç›®å½•è†¨èƒ€åˆ°500MB+

# åº”è¯¥æ·»åŠ å®šæœŸæ¸…ç†
asyncio.create_task(self._periodic_l2_cleanup())  # æ¯å°æ—¶æ¸…ç†ä¸€æ¬¡
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šä¼˜åŒ–æ–¹æ¡ˆ

### 4.1 ç«‹å³ä¼˜åŒ–ï¼ˆé›¶ä»£ç æ”¹åŠ¨ï¼‰

**æ–¹æ¡ˆ1ï¼šç¦ç”¨L2æŒä¹…åŒ–ç¼“å­˜**
```python
# src/core/elite/unified_data_pipeline.py
# ä¿®æ”¹åˆå§‹åŒ–å‚æ•°
self.cache = cache or IntelligentCache(
    l1_max_size=1000,   # ä»5000é™ä½åˆ°1000
    enable_l2=False,    # âŒ ç¦ç”¨L2æŒä¹…åŒ–
    # l2_cache_dir='/tmp/elite_cache'  # åˆ é™¤æ­¤è¡Œ
)
```

**æ”¶ç›Š**ï¼š
- å†…å­˜å ç”¨ï¼š50MB â†’ 10MBï¼ˆ**-80%**ï¼‰
- ç£ç›˜å ç”¨ï¼š500MB â†’ 0MBï¼ˆ**-100%**ï¼‰
- å¯åŠ¨é€Ÿåº¦ï¼š+30%ï¼ˆæ— éœ€æ¸…ç†L2ï¼‰
- ä»£ç æ”¹åŠ¨ï¼š2è¡Œ

---

**æ–¹æ¡ˆ2ï¼šè°ƒæ•´TTLé…ç½®**
```python
# src/core/elite/intelligent_cache.py
def _calculate_smart_ttl(self, key, value):
    if 'indicator' in key:
        return 300  # ä»60ç§’æ”¹ä¸º300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰
    elif 'kline' in key:
        return 600  # ä»300ç§’æ”¹ä¸º600ç§’ï¼ˆ10åˆ†é’Ÿï¼‰
    else:
        return 300  # ä»180ç§’æ”¹ä¸º300ç§’
```

**æ”¶ç›Š**ï¼š
- ç¼“å­˜å‘½ä¸­ç‡ï¼š50% â†’ 85%ï¼ˆ**+70%**ï¼‰
- CPUå ç”¨ï¼š-60%ï¼ˆå‡å°‘é‡å¤è®¡ç®—ï¼‰
- APIè¯·æ±‚ï¼š-30%

---

**æ–¹æ¡ˆ3ï¼šå‡å°‘WebSocketç¼“å†²æ·±åº¦**
```python
# src/core/websocket/kline_feed.py
data_buffers[symbol] = {
    '1m': deque(maxlen=120),   # ä»1440é™ä½åˆ°120ï¼ˆ2å°æ—¶ï¼‰
    '5m': deque(maxlen=60),    # ä»288é™ä½åˆ°60ï¼ˆ5å°æ—¶ï¼‰
    '15m': deque(maxlen=24),   # ä»96é™ä½åˆ°24ï¼ˆ6å°æ—¶ï¼‰
    '1h': deque(maxlen=24),    # ä¿æŒ24ï¼ˆ24å°æ—¶ï¼‰
}
```

**æ”¶ç›Š**ï¼š
- WebSocketç¼“å†²ï¼š37MB â†’ 10MBï¼ˆ**-73%**ï¼‰
- èšåˆè®¡ç®—ï¼š-50%ï¼ˆæ›´å°‘å†å²æ•°æ®å¤„ç†ï¼‰

---

### 4.2 ä¸­æœŸä¼˜åŒ–ï¼ˆå°ä»£ç æ”¹åŠ¨ï¼‰

**æ–¹æ¡ˆ4ï¼šæ™ºèƒ½ç¼“å­˜æ·˜æ±°**
```python
# src/core/elite/intelligent_cache.py
class IntelligentCache:
    def __init__(self, l1_max_size=1000, enable_l2=False):
        self.l1_cache = LRUCache(max_size=l1_max_size)
        self.enable_l2 = enable_l2
        
        # æ–°å¢ï¼šè®¿é—®é¢‘ç‡è¿½è¸ª
        self.access_frequency = defaultdict(int)
    
    def get(self, key):
        value = self.l1_cache.get(key)
        if value:
            self.access_frequency[key] += 1  # è®°å½•è®¿é—®æ¬¡æ•°
        return value
    
    def _evict_low_frequency(self):
        """å®šæœŸæ·˜æ±°ä½é¢‘è®¿é—®çš„ç¼“å­˜"""
        if len(self.access_frequency) > self.l1_cache.max_size * 1.5:
            # ä¿ç•™è®¿é—®æ¬¡æ•°>5çš„æ¡ç›®
            keep_keys = {k for k, v in self.access_frequency.items() if v > 5}
            
            for key in list(self.l1_cache.cache.keys()):
                if key not in keep_keys:
                    del self.l1_cache.cache[key]
            
            # æ¸…ç†é¢‘ç‡ç»Ÿè®¡
            self.access_frequency.clear()
```

**æ”¶ç›Š**ï¼š
- æ›´æ™ºèƒ½çš„ç¼“å­˜æ·˜æ±°ï¼ˆä¿ç•™çƒ­æ•°æ®ï¼‰
- ç¼“å­˜å‘½ä¸­ç‡ï¼š+10%

---

**æ–¹æ¡ˆ5ï¼šæŒ‰äº¤æ˜“å¯¹ä¼˜å…ˆçº§ç¼“å­˜**
```python
class PriorityCache:
    """ä¼˜å…ˆç¼“å­˜é«˜ä»·å€¼äº¤æ˜“å¯¹"""
    
    def __init__(self):
        # é«˜ä¼˜å…ˆçº§ï¼šæŒä»“+ç›‘æ§
        self.high_priority_symbols = set()  # 10-20ä¸ª
        
        # ä½ä¼˜å…ˆçº§ï¼šæ‰«æ
        self.low_priority_symbols = set()   # 180ä¸ª
    
    def should_cache(self, symbol, indicator):
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥ç¼“å­˜"""
        if symbol in self.high_priority_symbols:
            return True  # æŒä»“äº¤æ˜“å¯¹ï¼Œå…¨éƒ¨ç¼“å­˜
        
        if symbol in self.low_priority_symbols:
            # æ‰«æäº¤æ˜“å¯¹ï¼Œä»…ç¼“å­˜åŸºç¡€æŒ‡æ ‡
            return indicator in ['ema', 'rsi', 'macd']
        
        return False
```

**æ”¶ç›Š**ï¼š
- ç¼“å­˜æ¡ç›®ï¼š6,000 â†’ 500ï¼ˆ**-92%**ï¼‰
- å†…å­˜å ç”¨ï¼š50MB â†’ 5MBï¼ˆ**-90%**ï¼‰

---

### 4.3 é•¿æœŸä¼˜åŒ–ï¼ˆåˆ é™¤L2ç¼“å­˜ç³»ç»Ÿï¼‰

**æ–¹æ¡ˆ6ï¼šå®Œå…¨ç§»é™¤L2æŒä¹…åŒ–ç¼“å­˜**
```python
# åˆ é™¤æ–‡ä»¶
src/core/elite/intelligent_cache.py:
- åˆ é™¤ _get_from_l2()
- åˆ é™¤ _set_to_l2()
- åˆ é™¤ _clean_expired_l2()
- åˆ é™¤ l2_cache_dirç›¸å…³ä»£ç 

# ç®€åŒ–ä¸ºçº¯L1ç¼“å­˜
class SimpleCache:
    """æç®€LRUç¼“å­˜ï¼ˆæ— L2æŒä¹…åŒ–ï¼‰"""
    
    def __init__(self, max_size=1000, ttl=300):
        self.cache = OrderedDict()
        self.max_size = max_size
        self.default_ttl = ttl
    
    def get(self, key):
        if key not in self.cache:
            return None
        
        value, expiry = self.cache[key]
        
        if time.time() > expiry:
            del self.cache[key]
            return None
        
        self.cache.move_to_end(key)
        return value
    
    def set(self, key, value, ttl=None):
        ttl = ttl or self.default_ttl
        expiry = time.time() + ttl
        
        if key in self.cache:
            self.cache[key] = (value, expiry)
            self.cache.move_to_end(key)
            return
        
        if len(self.cache) >= self.max_size:
            self.cache.popitem(last=False)  # ç§»é™¤æœ€æ—§
        
        self.cache[key] = (value, expiry)
```

**æ”¶ç›Š**ï¼š
- ä»£ç é‡ï¼š438è¡Œ â†’ 50è¡Œï¼ˆ**-89%**ï¼‰
- å¯åŠ¨é€Ÿåº¦ï¼š+50%ï¼ˆæ— L2æ¸…ç†ï¼‰
- ç»´æŠ¤æˆæœ¬ï¼š**-95%**

---

## ç¬¬äº”éƒ¨åˆ†ï¼šæ¨èå®æ–½æ–¹æ¡ˆ

### 5.1 ç´§æ€¥ä¿®å¤ï¼ˆæœ¬å‘¨ï¼‰â±ï¸

**Step 1: ç¦ç”¨L2æŒä¹…åŒ–ï¼ˆ5åˆ†é’Ÿï¼‰**
```python
# src/core/elite/unified_data_pipeline.pyï¼ˆç¬¬85-89è¡Œï¼‰
self.cache = cache or IntelligentCache(
    l1_max_size=1000,   # âœ… ä»5000é™ä½åˆ°1000
    enable_l2=False,    # âœ… ç¦ç”¨L2
)

# src/core/elite/technical_indicator_engine.pyï¼ˆç¬¬86è¡Œï¼‰
self.cache = cache or IntelligentCache(
    l1_max_size=1000,   # âœ… ä»5000é™ä½åˆ°1000
    enable_l2=False,    # âœ… ç¦ç”¨L2
)
```

**Step 2: è°ƒæ•´TTLï¼ˆ5åˆ†é’Ÿï¼‰**
```python
# src/core/elite/intelligent_cache.pyï¼ˆç¬¬250-267è¡Œï¼‰
def _calculate_smart_ttl(self, key, value):
    if 'indicator' in key:
        return 300  # âœ… ä»60æ”¹ä¸º300ç§’
    elif 'kline' in key:
        return 600  # âœ… ä»300æ”¹ä¸º600ç§’
    else:
        return 300  # âœ… ä»180æ”¹ä¸º300ç§’
```

**Step 3: æ¸…ç†ç°æœ‰L2ç¼“å­˜ï¼ˆ1åˆ†é’Ÿï¼‰**
```bash
# æ‰‹åŠ¨åˆ é™¤L2ç¼“å­˜ç›®å½•
rm -rf /tmp/elite_cache/
```

**é¢„æœŸæ”¶ç›Šï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰**ï¼š
```
å†…å­˜å ç”¨: 300MB â†’ 50MB (-83%)
ç£ç›˜å ç”¨: 500MB â†’ 0MB (-100%)
ç¼“å­˜å‘½ä¸­ç‡: 50% â†’ 75% (+50%)
```

---

### 5.2 ä¸­æœŸä¼˜åŒ–ï¼ˆWeek 2ï¼‰

**Step 4: å‡å°‘WebSocketç¼“å†²**
```python
# src/core/websocket/kline_feed.py
maxlenè°ƒæ•´:
1m: 1440 â†’ 120
5m: 288 â†’ 60
15m: 96 â†’ 24
```

**Step 5: å®ç°æ™ºèƒ½ç¼“å­˜æ·˜æ±°**
```python
# æ·»åŠ è®¿é—®é¢‘ç‡è¿½è¸ª
# å®šæœŸæ¸…ç†ä½é¢‘ç¼“å­˜
```

**é¢„æœŸæ”¶ç›Š**ï¼š
```
å†…å­˜å ç”¨: 50MB â†’ 30MB (-40%)
ç¼“å­˜å‘½ä¸­ç‡: 75% â†’ 85% (+13%)
```

---

### 5.3 é•¿æœŸä¼˜åŒ–ï¼ˆPhase 2ï¼‰

**Step 6: å®Œå…¨ç§»é™¤L2ç¼“å­˜ç³»ç»Ÿ**
```python
# åˆ é™¤intelligent_cache.pyçš„L2ç›¸å…³ä»£ç 
# ç®€åŒ–ä¸ºSimpleCacheï¼ˆ50è¡Œï¼‰
```

**é¢„æœŸæ”¶ç›Š**ï¼š
```
ä»£ç é‡: 438è¡Œ â†’ 50è¡Œ (-89%)
ç»´æŠ¤æˆæœ¬: -95%
```

---

## ç¬¬å…­éƒ¨åˆ†ï¼šéªŒè¯è®¡åˆ’

### 6.1 å†…å­˜å ç”¨éªŒè¯

**éªŒè¯æ–¹æ³•**ï¼š
```python
import psutil
import os

process = psutil.Process(os.getpid())
memory_before = process.memory_info().rss / 1024 / 1024  # MB

# è¿è¡Œç³»ç»Ÿ30åˆ†é’Ÿ

memory_after = process.memory_info().rss / 1024 / 1024  # MB
print(f"å†…å­˜å ç”¨: {memory_before:.1f}MB â†’ {memory_after:.1f}MB")
```

**æˆåŠŸæ ‡å‡†**ï¼š
- å†…å­˜å ç”¨ < 100MB
- 30åˆ†é’Ÿè¿è¡Œç¨³å®šï¼ˆæ— å†…å­˜æ³„æ¼ï¼‰

---

### 6.2 ç¼“å­˜å‘½ä¸­ç‡éªŒè¯

**éªŒè¯æ–¹æ³•**ï¼š
```python
# å¯ç”¨ç¼“å­˜ç»Ÿè®¡
cache.print_stats()

# è¾“å‡ºç¤ºä¾‹ï¼š
# ğŸ“Š ç¼“å­˜ç»Ÿè®¡:
#    âœ… L1å‘½ä¸­: 850 (85.0%)
#    âŒ æœªå‘½ä¸­: 150
#    ğŸ¯ æ€»å‘½ä¸­ç‡: 85.0%
#    ğŸ“¦ L1å¤§å°: 456/1000
```

**æˆåŠŸæ ‡å‡†**ï¼š
- L1å‘½ä¸­ç‡ > 80%
- L1å¤§å° < 1000ï¼ˆæœªæ»¡ï¼‰

---

### 6.3 ç£ç›˜ç©ºé—´éªŒè¯

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥/tmp/elite_cache/ç›®å½•
ls -lh /tmp/elite_cache/ | wc -l

# åº”è¯¥è¿”å›0ï¼ˆç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼‰
```

**æˆåŠŸæ ‡å‡†**ï¼š
- `/tmp/elite_cache/`ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º
- ç£ç›˜å ç”¨ = 0MB

---

## ç»“è®º

### æ ¸å¿ƒé—®é¢˜

**L2æŒä¹…åŒ–ç¼“å­˜æ˜¯æœ€å¤§çš„æµªè´¹**ï¼š
- å ç”¨200-500MBç£ç›˜ç©ºé—´
- å¸‚åœºæ•°æ®å˜åŒ–å¿«ï¼ŒæŒä¹…åŒ–ä»·å€¼ä¸ºé›¶
- æ–‡ä»¶ç¢ç‰‡åŒ–ä¸¥é‡ï¼ˆ6,000+ä¸ª.pklæ–‡ä»¶ï¼‰

### ç«‹å³è¡ŒåŠ¨

**ç¦ç”¨L2 + è°ƒæ•´TTL**ï¼ˆ10åˆ†é’Ÿå·¥ä½œé‡ï¼‰ï¼š
- å†…å­˜ï¼š300MB â†’ 50MBï¼ˆ**-83%**ï¼‰
- ç£ç›˜ï¼š500MB â†’ 0MBï¼ˆ**-100%**ï¼‰
- å‘½ä¸­ç‡ï¼š50% â†’ 75%ï¼ˆ**+50%**ï¼‰

### é•¿æœŸæ–¹å‘

**æ¨¡å‹ä¸­å¿ƒæ¶æ„é‡æ„**ï¼ˆPhase 2ï¼‰ï¼š
- åˆ é™¤L2ç¼“å­˜ç³»ç»Ÿï¼ˆ-438è¡Œä»£ç ï¼‰
- ç®€åŒ–ä¸ºæç®€ç¼“å­˜ï¼ˆ50è¡Œï¼‰
- ä¸æ•´ä½“ç®€åŒ–æ–¹æ¡ˆä¸€è‡´

---

**æŠ¥å‘Šå®Œæˆæ—¥æœŸ**: 2025-01-16  
**å»ºè®®æ‰§è¡Œä¼˜å…ˆçº§**: P0ï¼ˆç´§æ€¥ï¼‰  
**é¢„è®¡ä¿®å¤æ—¶é—´**: 10åˆ†é’Ÿ
