# ğŸ’° v3.2.0: è‡ªå‹•è®€å–Uæœ¬ä½åˆç´„é¤˜é¡

**æ—¥æœŸ**: 2025-10-26  
**ç‹€æ…‹**: âœ… å°±ç·’  
**åŠŸèƒ½**: æ©Ÿå™¨äººè‡ªå‹•å¾Binance APIè®€å–Uæœ¬ä½åˆç´„é¤˜é¡ï¼Œå‹•æ…‹è¨ˆç®—å€‰ä½å¤§å°

---

## ğŸ¯ åŠŸèƒ½èªªæ˜

### èˆŠç‰ˆæœ¬ï¼ˆv3.1.xï¼‰

```python
# ç¡¬ç·¨ç¢¼å›ºå®šé¤˜é¡
account_balance = 10000.0  # âŒ å›ºå®šå€¼ï¼Œç„¡æ³•åæ˜ çœŸå¯¦è³¬æˆ¶æƒ…æ³
```

**å•é¡Œ**ï¼š
- ç„¡æ³•æ ¹æ“šå¯¦éš›è³¬æˆ¶é¤˜é¡èª¿æ•´å€‰ä½
- ç›ˆè™§å¾Œé¤˜é¡è®ŠåŒ–ç„¡æ³•åæ˜ 
- éœ€è¦æ‰‹å‹•ä¿®æ”¹ä»£ç¢¼æ›´æ–°é¤˜é¡

### æ–°ç‰ˆæœ¬ï¼ˆv3.2.0ï¼‰

```python
# è‡ªå‹•å¾Binanceç²å–å¯¦æ™‚é¤˜é¡
balance_info = await self.binance_client.get_account_balance()
account_balance = balance_info['total_balance']  # âœ… å¯¦æ™‚USDTé¤˜é¡

logger.info(
    f"ğŸ’° ä½¿ç”¨å¯¦æ™‚é¤˜é¡: {account_balance:.2f} USDT "
    f"(å¯ç”¨: {balance_info['available_balance']:.2f} USDT)"
)
```

**å„ªå‹¢**ï¼š
- âœ… è‡ªå‹•è®€å–å¯¦éš›è³¬æˆ¶é¤˜é¡
- âœ… æ ¹æ“šç›ˆè™§å‹•æ…‹èª¿æ•´å€‰ä½å¤§å°
- âœ… ç„¡éœ€æ‰‹å‹•ç¶­è­·é¤˜é¡é…ç½®
- âœ… éŒ¯èª¤è™•ç†ï¼šAPIå¤±æ•—æ™‚é™ç´šç‚ºé»˜èªå€¼

---

## ğŸ”§ æŠ€è¡“å¯¦ç¾

### 1. æ–°å¢ `get_account_balance` æ–¹æ³•

**ä½ç½®**: `src/clients/binance_client.py`

```python
async def get_account_balance(self) -> dict:
    """
    ç²å– U æœ¬ä½åˆç´„è³¬æˆ¶é¤˜é¡
    
    Returns:
        dict: {
            'total_balance': float,  # ç¸½é¤˜é¡ï¼ˆUSDTï¼‰
            'available_balance': float,  # å¯ç”¨é¤˜é¡ï¼ˆUSDTï¼‰
            'total_margin': float,  # ç¸½ä¿è­‰é‡‘
            'unrealized_pnl': float,  # æœªå¯¦ç¾ç›ˆè™§
            'total_wallet_balance': float  # ç¸½éŒ¢åŒ…é¤˜é¡ï¼ˆå«æœªå¯¦ç¾ç›ˆè™§ï¼‰
        }
    """
    account_info = await self.get_account_info()
    
    # æå– USDT è³‡ç”¢ä¿¡æ¯
    total_balance = 0.0
    available_balance = 0.0
    
    for asset in account_info.get('assets', []):
        if asset.get('asset') == 'USDT':
            total_balance = float(asset.get('walletBalance', 0))
            available_balance = float(asset.get('availableBalance', 0))
            break
    
    total_margin = total_balance - available_balance
    unrealized_pnl = float(account_info.get('totalUnrealizedProfit', 0))
    
    return {
        'total_balance': total_balance,
        'available_balance': available_balance,
        'total_margin': total_margin,
        'unrealized_pnl': unrealized_pnl,
        'total_wallet_balance': total_balance + unrealized_pnl
    }
```

**è¿”å›å€¼èªªæ˜**ï¼š

| å­—æ®µ | èªªæ˜ | ç”¨é€” |
|------|------|------|
| `total_balance` | USDTç¸½é¤˜é¡ï¼ˆéŒ¢åŒ…é¤˜é¡ï¼‰ | ç”¨æ–¼è¨ˆç®—å€‰ä½å¤§å° |
| `available_balance` | å¯ç”¨é¤˜é¡ï¼ˆæœªç”¨æ–¼ä¿è­‰é‡‘ï¼‰ | å¯é–‹æ–°å€‰çš„æœ€å¤§é‡‘é¡ |
| `total_margin` | ç•¶å‰ä¿è­‰é‡‘ï¼ˆå·²é–å®šï¼‰ | å·²æœ‰å€‰ä½ä½”ç”¨çš„è³‡é‡‘ |
| `unrealized_pnl` | æœªå¯¦ç¾ç›ˆè™§ | ç•¶å‰æŒå€‰æµ®å‹•ç›ˆè™§ |
| `total_wallet_balance` | ç¸½éŒ¢åŒ…é¤˜é¡ | å«æœªå¯¦ç¾ç›ˆè™§çš„ç¸½è³‡ç”¢ |

### 2. æ›´æ–°ä¸»ç¨‹åºè‡ªå‹•ç²å–é¤˜é¡

**ä½ç½®**: `src/main.py` (ç¬¬308-318è¡Œ)

```python
if rank <= Config.IMMEDIATE_EXECUTION_RANK:
    # è‡ªå‹•å¾ Binance ç²å– U æœ¬ä½åˆç´„é¤˜é¡
    try:
        balance_info = await self.binance_client.get_account_balance()
        account_balance = balance_info['total_balance']
        logger.info(
            f"ğŸ’° ä½¿ç”¨å¯¦æ™‚é¤˜é¡: {account_balance:.2f} USDT "
            f"(å¯ç”¨: {balance_info['available_balance']:.2f} USDT)"
        )
    except Exception as e:
        logger.error(f"ç²å–è³¬æˆ¶é¤˜é¡å¤±æ•—: {e}ï¼Œä½¿ç”¨é»˜èªå€¼")
        account_balance = 10000.0  # é™ç´šç‚ºé»˜èªå€¼
```

**å®¹éŒ¯æ©Ÿåˆ¶**ï¼š
- âœ… APIèª¿ç”¨æˆåŠŸ â†’ ä½¿ç”¨å¯¦æ™‚é¤˜é¡
- âŒ APIèª¿ç”¨å¤±æ•— â†’ é™ç´šç‚ºé»˜èªå€¼ï¼ˆ10000 USDTï¼‰
- âœ… ä¸æœƒå› ç‚ºé¤˜é¡ç²å–å¤±æ•—è€Œåœæ­¢äº¤æ˜“

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: è³¬æˆ¶æœ‰ 5000 USDT

```
ğŸ’° è³¬æˆ¶é¤˜é¡: ç¸½é¡ 5000.00 USDT, å¯ç”¨ 4500.00 USDT, 
   ä¿è­‰é‡‘ 500.00 USDT, æœªå¯¦ç¾ç›ˆè™§ +50.00 USDT

ğŸ’° ä½¿ç”¨å¯¦æ™‚é¤˜é¡: 5000.00 USDT (å¯ç”¨: 4500.00 USDT)

æº–å‚™é–‹å€‰: BTCUSDT LONG
  - è³¬æˆ¶é¤˜é¡: 5000 USDT
  - ä¿¡å¿ƒåº¦: 70%
  - æ§“æ¡¿: 12x
  - åŸºç¤ä¿è­‰é‡‘: 500 USDT (10% Ã— 5000)
  - ä¿¡å¿ƒåº¦èª¿æ•´: 350 USDT (70% Ã— 500)
  - å€‰ä½åƒ¹å€¼: 4200 USDT (350 Ã— 12)
  - é¢¨éšª: 1% (50 USDT)
```

### ç¤ºä¾‹ 2: è³¬æˆ¶æœ‰ 50000 USDTï¼ˆæ›´å¤§è³‡é‡‘ï¼‰

```
ğŸ’° è³¬æˆ¶é¤˜é¡: ç¸½é¡ 50000.00 USDT, å¯ç”¨ 48000.00 USDT,
   ä¿è­‰é‡‘ 2000.00 USDT, æœªå¯¦ç¾ç›ˆè™§ +200.00 USDT

ğŸ’° ä½¿ç”¨å¯¦æ™‚é¤˜é¡: 50000.00 USDT (å¯ç”¨: 48000.00 USDT)

æº–å‚™é–‹å€‰: ETHUSDT LONG
  - è³¬æˆ¶é¤˜é¡: 50000 USDT
  - ä¿¡å¿ƒåº¦: 70%
  - æ§“æ¡¿: 12x
  - åŸºç¤ä¿è­‰é‡‘: 5000 USDT (10% Ã— 50000)
  - ä¿¡å¿ƒåº¦èª¿æ•´: 3500 USDT (70% Ã— 5000)
  - å€‰ä½åƒ¹å€¼: 42000 USDT (3500 Ã— 12)
  - é¢¨éšª: 1% (500 USDT)
```

**å€‰ä½å¤§å°æœƒæ ¹æ“šè³¬æˆ¶é¤˜é¡è‡ªå‹•ç¸®æ”¾ï¼**

### ç¤ºä¾‹ 3: ç›ˆåˆ©å¾Œè‡ªå‹•å¢å¤§å€‰ä½

**åˆå§‹**ï¼š
```
è³¬æˆ¶é¤˜é¡: 10000 USDT
å€‰ä½åƒ¹å€¼: 8400 USDT (70% Ã— 10% Ã— 10000 Ã— 12)
```

**ç›ˆåˆ©1000 USDTå¾Œ**ï¼š
```
è³¬æˆ¶é¤˜é¡: 11000 USDT  # è‡ªå‹•æ›´æ–°
å€‰ä½åƒ¹å€¼: 9240 USDT (70% Ã— 10% Ã— 11000 Ã— 12)  # è‡ªå‹•å¢å¤§
```

**è™§æ1000 USDTå¾Œ**ï¼š
```
è³¬æˆ¶é¤˜é¡: 9000 USDT  # è‡ªå‹•æ›´æ–°
å€‰ä½åƒ¹å€¼: 7560 USDT (70% Ã— 10% Ã— 9000 Ã— 12)  # è‡ªå‹•æ¸›å°
```

---

## ğŸ”„ å€‰ä½å¤§å°è¨ˆç®—å…¬å¼

```
åŸºç¤ä¿è­‰é‡‘ = è³¬æˆ¶é¤˜é¡ Ã— 10%
ä¿¡å¿ƒåº¦èª¿æ•´ä¿è­‰é‡‘ = åŸºç¤ä¿è­‰é‡‘ Ã— ä¿¡å¿ƒåº¦
æœ€çµ‚ä¿è­‰é‡‘ = min(ä¿¡å¿ƒåº¦èª¿æ•´ä¿è­‰é‡‘, è³¬æˆ¶é¤˜é¡ Ã— 13%)
æœ€çµ‚ä¿è­‰é‡‘ = max(æœ€çµ‚ä¿è­‰é‡‘, è³¬æˆ¶é¤˜é¡ Ã— 3%)

# 1%é¢¨éšªé™åˆ¶
if æœ€çµ‚ä¿è­‰é‡‘ > è³¬æˆ¶é¤˜é¡ Ã— 2%:
    æœ€çµ‚ä¿è­‰é‡‘ = è³¬æˆ¶é¤˜é¡ Ã— 2%

å€‰ä½åƒ¹å€¼ = æœ€çµ‚ä¿è­‰é‡‘ Ã— æ§“æ¡¿
æ•¸é‡ = å€‰ä½åƒ¹å€¼ / å…¥å ´åƒ¹æ ¼
```

**é—œéµåƒæ•¸**ï¼š
- `BASE_MARGIN_PCT = 10%` - åŸºç¤ä¿è­‰é‡‘æ¯”ä¾‹
- `MIN_MARGIN_PCT = 3%` - æœ€å°ä¿è­‰é‡‘æ¯”ä¾‹
- `MAX_MARGIN_PCT = 13%` - æœ€å¤§ä¿è­‰é‡‘æ¯”ä¾‹
- `MAX_RISK = 2%` - å–®ç­†æœ€å¤§é¢¨éšªï¼ˆç¡¬è¦å‰‡ï¼‰

---

## ğŸ“Š é æœŸæ—¥èªŒè¼¸å‡º

### æˆåŠŸç²å–é¤˜é¡

```
[INFO] ğŸ’° è³¬æˆ¶é¤˜é¡: ç¸½é¡ 12345.67 USDT, å¯ç”¨ 11500.00 USDT, 
       ä¿è­‰é‡‘ 845.67 USDT, æœªå¯¦ç¾ç›ˆè™§ +123.45 USDT

[INFO] ğŸ’° ä½¿ç”¨å¯¦æ™‚é¤˜é¡: 12345.67 USDT (å¯ç”¨: 11500.00 USDT)

[INFO] æº–å‚™é–‹å€‰: BTCUSDT LONG æ•¸é‡: 0.045 æ§“æ¡¿: 12x
       å€‰ä½åƒ¹å€¼: 10281.58 USDTï¼Œä¿è­‰é‡‘: 856.80 USDT
```

### APIå¤±æ•—é™ç´š

```
[ERROR] ç²å–è³¬æˆ¶é¤˜é¡å¤±æ•—: API rate limit exceeded, ä½¿ç”¨é»˜èªå€¼

[INFO] ğŸ’° ä½¿ç”¨å¯¦æ™‚é¤˜é¡: 10000.00 USDT (é™ç´šæ¨¡å¼)

[INFO] æº–å‚™é–‹å€‰: ETHUSDT LONG æ•¸é‡: 3.2 æ§“æ¡¿: 10x
```

---

## âš™ï¸ é…ç½®é¸é …

### å¯é¸ï¼šè¨­ç½®é»˜èªé¤˜é¡ï¼ˆé™ç´šå€¼ï¼‰

å¯ä»¥åœ¨ `src/config.py` æ·»åŠ ï¼š

```python
# é»˜èªè³¬æˆ¶é¤˜é¡ï¼ˆAPIå¤±æ•—æ™‚ä½¿ç”¨ï¼‰
DEFAULT_ACCOUNT_BALANCE: float = float(os.getenv("DEFAULT_ACCOUNT_BALANCE", "10000"))
```

ç„¶å¾Œåœ¨ `main.py` ä¸­ä½¿ç”¨ï¼š

```python
except Exception as e:
    logger.error(f"ç²å–è³¬æˆ¶é¤˜é¡å¤±æ•—: {e}ï¼Œä½¿ç”¨é»˜èªå€¼")
    account_balance = Config.DEFAULT_ACCOUNT_BALANCE
```

---

## ğŸ¯ èˆ‡é¢¨éšªç®¡ç†çš„æ•´åˆ

**é¢¨éšªç®¡ç†è¦å‰‡**ï¼ˆä»ç„¶ç”Ÿæ•ˆï¼‰ï¼š

1. **å–®ç­†é¢¨éšªâ‰¤1%**
   ```python
   if risk_per_trade > account_balance * 0.02:
       position_margin = account_balance * 0.02
   ```

2. **3%æ—¥è™§æä¸Šé™**
   ```python
   if daily_loss_pct > 0.03:
       return False, "æ—¥è™§æè¶…é3%ï¼Œæš«åœäº¤æ˜“"
   ```

3. **æœ€å¤§3å€‹å€‰ä½**
   ```python
   if current_positions >= 3:
       return False, "å·²é”åˆ°æœ€å¤§æŒå€‰æ•¸3"
   ```

4. **é€£çºŒ5æ¬¡è™§ææš«åœ**
   ```python
   if consecutive_losses >= 5:
       return False, "é€£çºŒè™§æ5æ¬¡ï¼Œæš«åœäº¤æ˜“"
   ```

---

## ğŸ“ˆ å„ªå‹¢ç¸½çµ

### è‡ªå‹•åŒ–

| åŠŸèƒ½ | èˆŠç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ |
|------|--------|--------|
| é¤˜é¡æ›´æ–° | âŒ æ‰‹å‹•ä¿®æ”¹ä»£ç¢¼ | âœ… è‡ªå‹•å¾APIç²å– |
| å€‰ä½èª¿æ•´ | âŒ å›ºå®šé‡‘é¡ | âœ… æ ¹æ“šé¤˜é¡å‹•æ…‹ç¸®æ”¾ |
| ç›ˆè™§åæ˜  | âŒ ä¸åæ˜  | âœ… å¯¦æ™‚åæ˜  |
| å®¹éŒ¯è™•ç† | âŒ ç„¡ | âœ… é™ç´šç‚ºé»˜èªå€¼ |

### é¢¨éšªæ§åˆ¶

- âœ… è³¬æˆ¶é¤˜é¡æ¸›å°‘ â†’ å€‰ä½è‡ªå‹•æ¸›å°ï¼ˆä¿è­·è³‡é‡‘ï¼‰
- âœ… è³¬æˆ¶é¤˜é¡å¢åŠ  â†’ å€‰ä½è‡ªå‹•å¢å¤§ï¼ˆè¤‡åˆ©æ•ˆæ‡‰ï¼‰
- âœ… 1%é¢¨éšªè¦å‰‡å§‹çµ‚åŸºæ–¼æœ€æ–°é¤˜é¡
- âœ… APIç·©å­˜10ç§’ï¼Œé¿å…éåº¦èª¿ç”¨

---

## ğŸš€ éƒ¨ç½²

### Railwayç’°å¢ƒè®Šé‡

ç¢ºèªå·²è¨­ç½®ï¼š
```bash
BINANCE_API_KEY=<æ‚¨çš„å¯†é‘°>
BINANCE_API_SECRET=<æ‚¨çš„å¯†é‘°å¯†ç¢¼>
BINANCE_TESTNET=false  # ä¸»ç¶²
TRADING_ENABLED=true
LOG_LEVEL=INFO
```

### æ¨é€ä»£ç¢¼

```bash
git add .
git commit -m "ğŸ’° v3.2.0: è‡ªå‹•è®€å–Uæœ¬ä½åˆç´„é¤˜é¡"
git push railway main
```

### é©—è­‰æ—¥èªŒ

```bash
railway logs --follow | grep "è³¬æˆ¶é¤˜é¡\|ä½¿ç”¨å¯¦æ™‚é¤˜é¡"
```

**é æœŸè¼¸å‡º**ï¼š
```
ğŸ’° è³¬æˆ¶é¤˜é¡: ç¸½é¡ 12345.67 USDT, å¯ç”¨ 11500.00 USDT
ğŸ’° ä½¿ç”¨å¯¦æ™‚é¤˜é¡: 12345.67 USDT (å¯ç”¨: 11500.00 USDT)
```

---

## ğŸ‰ ç¸½çµ

**v3.2.0æ–°åŠŸèƒ½**ï¼š
- âœ… è‡ªå‹•è®€å–Uæœ¬ä½åˆç´„çœŸå¯¦é¤˜é¡
- âœ… å€‰ä½å¤§å°æ ¹æ“šé¤˜é¡å‹•æ…‹èª¿æ•´
- âœ… ç›ˆè™§å¾Œè‡ªå‹•ç¸®æ”¾å€‰ä½
- âœ… å®¹éŒ¯è™•ç†ï¼ˆAPIå¤±æ•—é™ç´šï¼‰
- âœ… èˆ‡ç¾æœ‰é¢¨éšªç®¡ç†å®Œç¾æ•´åˆ

**ç¾åœ¨æ©Ÿå™¨äººæœƒæ ¹æ“šæ‚¨çš„å¯¦éš›è³¬æˆ¶é¤˜é¡è‡ªå‹•è¨ˆç®—å€‰ä½å¤§å°ï¼Œç„¡éœ€æ‰‹å‹•ç¶­è­·ï¼** ğŸ’°âœ¨
