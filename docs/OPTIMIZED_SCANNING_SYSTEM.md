# 優化掃描系統配置指南

## 🎯 系統配置總結

基於您的要求，系統已優化為以下配置：

### ✅ 已實現的優化

1. **取消 1m K線監控** - 僅使用 1h/15m/5m
2. **波動率優先排序** - 從648個交易對中選擇波動率最高的前200個
3. **差異化時間框架更新**：
   - **1h**：每小時更新一次（趨勢確認）
   - **15m**：每15分鐘更新一次（趨勢確認）
   - **5m**：每分鐘更新（趨勢符合確認 + 入場信號）
4. **智能倉位管理**：
   - **實倉**：前3個（信心最高/勝率最高）
   - **虛擬倉**：其他所有符合條件的（包含真實止盈止損）
5. **完整 ML 數據收集** - 所有交易入場特徵精確存儲

---

## 📊 系統架構

### 時間框架策略

```
1h  → 每小時更新 → 趨勢確認（緩存）
15m → 每15分鐘更新 → 趨勢確認（緩存）
5m  → 每分鐘更新 → 趨勢符合確認 + 入場信號
```

### 波動率排序邏輯

```python
# 從 648 個交易對中選擇波動率最高的前 200 個
market_data.sort(key=lambda x: abs(x['change_24h']), reverse=True)
top_200 = market_data[:200]
```

**波動率指標**：24h 價格變化百分比（絕對值）

### 倉位管理策略

```
信號排序：按信心度從高到低

Rank 1-3  → 實倉（最多3個同時持倉）
Rank 4+   → 虛擬倉（無限制，全部追蹤）
```

---

## 🚀 API 調用量計算

### 每個週期（60秒）

#### 市場掃描
```
獲取 24h ticker（包含價格變化）: 1次調用
權重：40
```

#### K 線數據（200個交易對）

**第一分鐘（所有時間框架）**：
```
1h:  200 × 7 = 1,400 權重
15m: 200 × 7 = 1,400 權重
5m:  200 × 7 = 1,400 權重
總計：4,200 權重（峰值）
```

**普通分鐘（僅5m更新）**：
```
5m: 200 × 7 = 1,400 權重
總計：1,400 權重
```

**每15分鐘（1h緩存，15m+5m更新）**：
```
15m: 200 × 7 = 1,400 權重
5m:  200 × 7 = 1,400 權重
總計：2,800 權重
```

**每60分鐘（所有更新）**：
```
1h:  200 × 7 = 1,400 權重
15m: 200 × 7 = 1,400 權重
5m:  200 × 7 = 1,400 權重
總計：4,200 權重
```

### 平均每分鐘

```
每小時總權重：
- 1h 更新：1 次 × 1,400 = 1,400
- 15m 更新：4 次 × 1,400 = 5,600
- 5m 更新：60 次 × 1,400 = 84,000
- 市場掃描：60 次 × 40 = 2,400

總計：93,400 權重/小時
平均：1,557 權重/分鐘 ✅

安全邊際：(2,400 - 1,557) / 2,400 = 35%
```

---

## 🎯 配置參數

### Railway 環境變量

```bash
# === API 配置 ===
BINANCE_API_KEY=你的_數據_API
BINANCE_API_SECRET=你的_數據_Secret

# 交易專用 API（可選但推薦）
BINANCE_TRADING_API_KEY=你的_交易_API
BINANCE_TRADING_API_SECRET=你的_交易_Secret

# === 掃描配置 ===
TOP_VOLATILITY_SYMBOLS=200      # 監控波動率最高的前200個
SCAN_INTERVAL=60                # 每60秒掃描一次

# === 交易配置 ===
TRADING_ENABLED=true
MAX_POSITIONS=3                 # 最多3個實倉
MIN_CONFIDENCE=0.70             # 最低信心度70%

# === API 限流 ===
RATE_LIMIT_REQUESTS=1920        # 使用80%限額

# === Discord ===
DISCORD_TOKEN=你的_Discord_Token
```

---

## 📈 性能預期

### 監控覆蓋

```
交易對總數：648 個
實際監控：波動率最高的前 200 個
覆蓋率：31%（但包含最活躍的標的）
```

### 掃描頻率

```
5m K線：每分鐘更新（200個交易對）
15m K線：每15分鐘更新
1h K線：每小時更新

每小時掃描次數：
- 5m: 60 次 × 200 = 12,000 次
- 15m: 4 次 × 200 = 800 次
- 1h: 1 次 × 200 = 200 次
總計：13,000 次/小時
```

### 信號生成

```
預期信號：20-40 個/小時
實倉執行：前3個（信心最高）
虛擬追蹤：其餘所有符合條件的
```

### 交易執行

```
最大同時持倉：3 個
平均持倉時間：2-8 小時
預期交易：5-15 筆/天
```

---

## 🧠 XGBoost ML 訓練數據

### 數據收集策略

**實倉交易**：
- ✅ 完整入場特徵（39個）
- ✅ 真實平倉結果
- ✅ 實際 PnL

**虛擬倉位**：
- ✅ 完整入場特徵（39個）
- ✅ 真實止盈止損價格
- ✅ 虛擬 PnL 計算
- ✅ 所有市場條件相同

### 特徵列表（39個）

#### 基礎特徵 (8個)
```python
'confidence_score',       # 信心度評分
'leverage',               # 槓桿倍數
'position_value',         # 倉位價值
'hold_duration_hours',    # 持倉時長
'risk_reward_ratio',      # 風險回報比
'order_blocks_count',     # Order Blocks 數量
'liquidity_zones_count',  # Liquidity Zones 數量
'entry_price'            # 入場價格
```

#### 技術指標 (10個)
```python
'rsi_entry',             # RSI 入場值
'macd_entry',            # MACD 入場值
'macd_signal_entry',     # MACD 信號線
'macd_histogram_entry',  # MACD 柱狀圖
'atr_entry',             # ATR 入場值
'bb_width_pct',          # 布林帶寬度
'volume_sma_ratio',      # 成交量/均量比
'price_vs_ema50',        # 價格vs EMA50
'price_vs_ema200',       # 價格vs EMA200
'volatility_24h'         # 24h波動率
```

#### 趨勢特徵 (6個)
```python
'trend_1h_encoded',      # 1h趨勢 (1=看漲/-1=看跌/0=中性)
'trend_15m_encoded',     # 15m趨勢
'trend_5m_encoded',      # 5m趨勢
'market_structure_encoded', # 市場結構
'direction_encoded',     # 交易方向
'trend_alignment'        # 趨勢對齊度
```

#### 其他特徵 (15個)
```python
'ema50_slope',           # EMA50 斜率
'ema200_slope',          # EMA200 斜率
'higher_highs',          # 更高高點
'lower_lows',            # 更低低點
'support_strength',      # 支撐強度
'resistance_strength',   # 阻力強度
'fvg_count',             # Fair Value Gaps 數量
'swing_high_distance',   # 距離擺動高點
'swing_low_distance',    # 距離擺動低點
'volume_profile',        # 成交量分佈
'price_momentum',        # 價格動量
'order_flow',            # 訂單流
'liquidity_grab',        # 流動性掃取
'institutional_candle',  # 機構蠟燭
'smart_money_concept'    # 智能資金概念
```

### 數據存儲

```json
{
  "symbol": "BTCUSDT",
  "direction": "LONG",
  "entry_price": 43250.50,
  "exit_price": 44100.20,
  "stop_loss": 42800.00,
  "take_profit": 44500.00,
  "confidence_score": 0.85,
  "leverage": 10,
  "pnl": 0.0197,
  "is_winner": true,
  ... (所有39個特徵)
}
```

文件位置：`data/trades.json`

---

## 🔧 調整指南

### 如何增加監控數量

**選項 1：監控更多交易對**

```bash
# 從 200 增加到 300
TOP_VOLATILITY_SYMBOLS=300

# API 使用：1,557 × (300/200) = 2,336 權重/分鐘
# 仍在限額內 ✅
```

**選項 2：監控全部 648 個**

```bash
# 監控全部
TOP_VOLATILITY_SYMBOLS=648

# API 使用：1,557 × (648/200) = 5,045 權重/分鐘
# ❌ 超出限額！

# 需要調整掃描間隔：
SCAN_INTERVAL=120  # 改為每2分鐘

# 平均權重：5,045 / 2 = 2,523 權重/分鐘
# ⚠️  略超，需進一步優化
```

### 如何提高掃描頻率

如果 API 使用率 < 60%，可以：

**選項 1：縮短掃描間隔**

```bash
# 從 60 秒改為 30 秒
SCAN_INTERVAL=30

# API 使用：1,557 × 2 = 3,114 權重/分鐘
# ⚠️  超出限額
```

**選項 2：減少監控數量**

```bash
# 從 200 減少到 100
TOP_VOLATILITY_SYMBOLS=100

# API 使用：1,557 × (100/200) = 779 權重/分鐘
# ✅ 可以縮短到 30 秒間隔
```

---

## 📊 系統監控

### 日誌輸出

每個週期系統會輸出：

```
============================================================
🔄 交易週期開始: 2025-10-25 09:30:00
============================================================
⏰ 時間框架調度狀態:
  1h: 間隔=3600秒, 上次掃描=55分鐘前, 下次掃描=5分鐘, 需掃描=否
  15m: 間隔=900秒, 上次掃描=14分鐘前, 下次掃描=1分鐘, 需掃描=否
  5m: 間隔=60秒, 上次掃描=30秒前, 下次掃描=30秒, 需掃描=否

開始掃描 648 個交易對（波動率排序）...
✅ 市場掃描完成: 從 648 個交易對中選擇波動率最高的前 200 個
   (平均波動率: 4.25%)

🔍 使用 32 核心並行分析 200 個高波動率交易對 (已按波動率排序)...
處理批次 1/2 (128 個交易對)
批次 1 完成: 生成 12 個信號, 累計 12 個
處理批次 2/2 (72 個交易對)
批次 2 完成: 生成 5 個信號, 累計 17 個
✅ 批量分析完成: 分析 200 個交易對, 生成 17 個信號

🎯 生成 17 個交易信號
  #1 BTCUSDT LONG 信心度 87.50%
  #2 ETHUSDT LONG 信心度 85.20%
  #3 BNBUSDT SHORT 信心度 82.40%
  #4 SOLUSDT LONG 信心度 79.10%
  ...

📊 倉位管理:
  實倉: 3/3 (BTCUSDT, ETHUSDT, BNBUSDT)
  虛擬倉: 14 個
============================================================
```

### 性能報告（每5分鐘）

```
============================================================
📊 性能監控報告
============================================================
CPU: 45.2% (32 核心)
內存: 15.50/32.00 GB (48.4%)
運行時間: 2.50 小時
信號生成: 85 個
交易執行: 12 筆 (實倉)
虛擬倉位: 73 個
API 調用: 7,850 次
平均權重: 1,567 權重/分鐘 (65.3% 限額)
錯誤數: 2
信號速率: 34.00 個/小時
虛擬倉勝率: 68.5%
實倉勝率: 75.0%
============================================================
```

---

## ✅ 最佳實踐

### 1. 監控波動率最高的200個

✅ **優勢**：
- 覆蓋最活躍的交易對
- API 使用率安全（65%）
- 充分利用 32 核心

### 2. 使用雙 API 配置

✅ **優勢**：
- 數據 API：專門用於市場掃描
- 交易 API：專門用於下單
- 訂單限額獨立

### 3. 實倉僅前3個

✅ **優勢**：
- 專注最高質量信號
- 風險分散
- 資金管理

### 4. 虛擬倉位全部追蹤

✅ **優勢**：
- 收集大量 ML 訓練數據
- 驗證策略有效性
- 無風險學習

### 5. 完整 ML 數據記錄

✅ **優勢**：
- 39個特徵完整存儲
- 真實止盈止損
- 精確 PnL 計算

---

## 🚀 部署步驟

### 1. 配置環境變量

在 Railway 中設置所有必需的環境變量（見上方配置參數）

### 2. 部署系統

```bash
git push origin main
# Railway 自動部署
```

### 3. 監控運行

查看日誌確認：
- ✅ 波動率排序正常
- ✅ 時間框架調度正確
- ✅ API 使用率 < 80%
- ✅ 信號生成穩定

### 4. 驗證數據收集

檢查 `data/trades.json`：
- ✅ 所有39個特徵存在
- ✅ PnL 計算正確
- ✅ 虛擬倉位記錄完整

---

## 📝 總結

### 核心優化

1. ✅ **僅 3 個時間框架**（1h/15m/5m）
2. ✅ **波動率優先**（前200個）
3. ✅ **智能倉位管理**（3實倉 + 無限虛擬倉）
4. ✅ **完整 ML 數據**（39特徵精確存儲）
5. ✅ **API 效率優化**（65% 使用率）

### 預期效果

- 📊 **覆蓋**：200個最活躍交易對
- ⚡ **頻率**：5m 每分鐘更新
- 🎯 **信號**：20-40個/小時
- 💼 **交易**：3個實倉 + 虛擬追蹤
- 🧠 **學習**：大量高質量 ML 數據

**結果**：✅ 24/7 超高頻自動化交易系統，專注 1:1-1:2 盈虧比！
