# 📊 交易绩效评分系统 (Trading Performance Scoring System)

**版本**: v3.9.2  
**更新日期**: 2025-10-27

---

## 🎯 系统概述

本系统采用**五维评分体系 + 期望值驱动**的双层评分机制，动态调整交易参数。

---

## 📈 评分体系架构

```
┌─────────────────────────────────────────────────────┐
│           交易绩效评分系统 (双层架构)                │
└─────────────────────────────────────────────────────┘
                       │
          ┌────────────┴────────────┐
          │                         │
    ┌─────▼─────┐           ┌──────▼──────┐
    │ Layer 1:  │           │ Layer 2:    │
    │ ICT信号   │           │ 历史绩效    │
    │ 评分系统  │           │ 评分系统    │
    └─────┬─────┘           └──────┬──────┘
          │                        │
          │                        │
    ┌─────▼──────────────────┬────▼────────────┐
    │                        │                  │
┌───▼────┐            ┌──────▼──────┐  ┌───────▼────────┐
│信心度   │            │期望值计算器  │  │风险管理器      │
│Score    │            │Expectancy   │  │Risk Manager    │
│(0-1)    │            │Calculator   │  │                │
└────┬────┘            └──────┬──────┘  └───────┬────────┘
     │                        │                  │
     └────────────┬───────────┴──────────────────┘
                  │
         ┌────────▼─────────┐
         │  动态参数调整     │
         │  • 杠杆倍数      │
         │  • 保证金比例    │
         │  • 仓位大小      │
         └──────────────────┘
```

---

## 🔷 Layer 1: ICT信号评分系统

### 五维评分指标

**文件**: `src/strategies/ict_strategy.py`

| 维度 | 权重 | 说明 | 评分范围 |
|------|------|------|----------|
| **趋势对齐** (Trend Alignment) | 20% | 1h、15m、5m趋势一致性 | 0.0 - 1.0 |
| **市场结构** (Market Structure) | 20% | 市场结构与趋势匹配度 | 0.0 - 1.0 |
| **价格位置** (Price Position) | 20% | 距离Order Block的距离 | 0.0 - 1.0 |
| **动量指标** (Momentum) | 20% | RSI、MACD、成交量 | 0.0 - 1.0 |
| **波动率** (Volatility) | 20% | ATR、布林带宽度 | 0.0 - 1.0 |

### 综合信心度计算

```python
confidence_score = (
    trend_alignment * 0.20 +
    market_structure * 0.20 +
    price_position * 0.20 +
    momentum * 0.20 +
    volatility * 0.20
)
```

**输出范围**: 0.0 - 1.0（通常45% - 95%）

### 信心度等级划分

| 等级 | 范围 | 保证金上限 | 说明 |
|------|------|------------|------|
| 🟢 极高 | ≥90% | 50% | 五维指标全部优秀 |
| 🟢 很高 | 80-89% | 35% | 四维指标优秀 |
| 🟡 高 | 70-79% | 25% | 三维指标优秀 |
| 🟡 中高 | 60-69% | 15% | 两维指标优秀 |
| 🟠 普通 | 45-59% | 8% | 基本符合条件 |
| 🔴 低 | <45% | - | 不开仓 |

---

## 🔷 Layer 2: 历史绩效评分系统

### 期望值计算器 (Expectancy Calculator)

**文件**: `src/managers/expectancy_calculator.py`

#### 核心指标

**1. 期望值 (Expectancy)**
```
期望值 (%) = (胜率 × 平均盈利) - ((1 - 胜率) × 平均亏损)
```

**2. 盈亏比 (Profit Factor)**
```
盈亏比 = 总盈利 / 总亏损
```

**3. 胜率 (Win Rate)**
```
胜率 = 盈利交易数 / 总交易数
```

**4. 连续亏损 (Consecutive Losses)**
```
连续亏损 = 最近连续亏损的交易数量
```

#### 评分等级

##### 期望值评级

| 等级 | 期望值 | 盈亏比 | 基础杠杆 |
|------|--------|--------|----------|
| 🟢 优秀 | >1.5% | >1.5 | 17x |
| 🟢 良好 | >0.8% | >1.0 | 12x |
| 🟡 一般 | >0.3% | >0.8 | 7x |
| 🟠 偏低 | 0-0.3% | 0.5-0.8 | 4x |
| 🔴 负值 | <0% | - | 0x (拒绝交易) |

##### 胜率评级

| 等级 | 胜率 | 杠杆加成 |
|------|------|----------|
| 🟢 优秀 | >80% | +6x |
| 🟢 良好 | >70% | +4x |
| 🟡 一般 | >60% | +2x |
| 🟠 普通 | 45-60% | 0x |
| 🔴 低 | <45% | - |

---

## ⚙️ 动态参数调整系统

### 1. 杠杆倍数 (Leverage)

**计算逻辑**:
```python
def calculate_leverage(expectancy, profit_factor, win_rate, consecutive_losses, current_drawdown):
    # 步骤1: 基于期望值和盈亏比确定基础杠杆
    if expectancy < 0:
        return 0  # 🛡️ 负期望值拒绝交易
    
    if expectancy > 1.5 and profit_factor > 1.5:
        base_leverage = 17x  # 优秀
    elif expectancy > 0.8 and profit_factor > 1.0:
        base_leverage = 12x  # 良好
    elif expectancy > 0.3 and profit_factor > 0.8:
        base_leverage = 7x   # 一般
    else:
        base_leverage = 4x   # 偏低
    
    # 步骤2: 应用连续亏损惩罚
    if consecutive_losses >= 6:
        base_leverage -= 5x  # 🛡️ 6单：降低5x
    elif consecutive_losses >= 4:
        base_leverage -= 3x  # 🛡️ 4单：降低3x
    
    # 步骤3: 应用回撤保护
    if current_drawdown > 25%:
        base_leverage = MIN_LEVERAGE (3x)  # 🛡️ 极端回撤
    elif current_drawdown > 20%:
        base_leverage -= 7x  # 🛡️ 严重回撤
    elif current_drawdown > 15%:
        base_leverage -= 4x  # 🛡️ 中度回撤
    elif current_drawdown > 10%:
        base_leverage -= 2x  # 🛡️ 轻度回撤
    
    # 步骤4: 限制在配置范围内
    final_leverage = max(MIN_LEVERAGE, min(base_leverage, MAX_LEVERAGE))
    
    return final_leverage  # 3x - 20x
```

**动态范围**: 3x - 20x

---

### 2. 保证金比例 (Margin Percentage)

**计算逻辑**:
```python
def calculate_position_margin(account_balance, confidence_score):
    # 基于信心度动态调整保证金上限
    if confidence_score >= 0.90:
        max_margin = 50%  # 极高信心
    elif confidence_score >= 0.80:
        max_margin = 35%  # 很高信心
    elif confidence_score >= 0.70:
        max_margin = 25%  # 高信心
    elif confidence_score >= 0.60:
        max_margin = 15%  # 中高信心
    else:
        max_margin = 8%   # 普通信心
    
    # 计算实际保证金
    base_margin = account_balance * BASE_MARGIN_PCT (10%)
    confidence_adjusted = base_margin * confidence_score
    position_margin = min(confidence_adjusted, max_margin * account_balance)
    
    # 额外风险限制：单笔最多2%
    if position_margin > account_balance * 0.02:
        position_margin = account_balance * 0.02
    
    return position_margin
```

**动态范围**: 3% - 50%（取决于信心度）

---

### 3. 仓位价值 (Position Value)

```python
position_value = position_margin × leverage
```

**示例**:
- 账户余额: $1000
- 信心度: 85%（很高）
- 杠杆: 12x（良好期望值）
- 保证金: $350（35%上限）
- 仓位价值: $350 × 12 = $4,200

**风险暴露**: 420%（$4,200 / $1,000）

---

## 🛡️ 智能保护机制

### 1. 负期望值保护

**触发条件**: 期望值 < 0%

**保护措施**:
```
杠杆 = 0（拒绝所有交易）
```

**解除条件**: 期望值转正

---

### 2. 连续亏损保护

**触发条件**: 连续亏损 ≥ 6单

**保护措施**:
```
只允许高品质信号交易
- 信心度 ≥ 70%
- 胜率 ≥ 60%
```

**示例**:
```
连续亏损 4单 → 杠杆 -3x
连续亏损 6单 → 杠杆 -5x + 高品质模式
```

---

### 3. 单日亏损保护（两层）

#### Layer 3a: 谨慎模式

**触发条件**: 单日亏损 ≥ 3%

**保护措施**:
```
进入谨慎模式
只允许高品质信号交易
- 信心度 ≥ 70%
- 胜率 ≥ 60%
```

#### Layer 3b: 完全停止

**触发条件**: 单日亏损 > 15%

**保护措施**:
```
当日停止所有交易
```

---

### 4. 回撤保护（四层）

| 回撤程度 | 杠杆调整 | 说明 |
|----------|----------|------|
| >25% | 降至MIN (3x) | 极端回撤 |
| >20% | -7x | 严重回撤 |
| >15% | -4x | 中度回撤 |
| >10% | -2x | 轻度回撤 |

---

### 5. 账户级保护

**断路器**: 总亏损 > 20% → 立即暂停所有交易  
**永久停止**: 总亏损 > 30% → 永久停止交易

---

## 📊 完整评分流程示例

### 案例1: 理想信号

**ICT信号评分**:
- 趋势对齐: 1.0（三时间框架一致）
- 市场结构: 1.0（完全匹配）
- 价格位置: 0.9（距OB 0.5 ATR）
- 动量: 0.85（RSI 65, MACD金叉）
- 波动率: 0.8（ATR适中）

→ **信心度 = 91%** (极高)

**历史绩效评分**:
- 期望值: 1.8%
- 盈亏比: 1.7
- 胜率: 68%
- 连续亏损: 0
- 回撤: 5%

**动态参数**:
```
基础杠杆: 17x（优秀期望值）
连续亏损惩罚: 0x
回撤调整: 0x
最终杠杆: 17x

保证金上限: 50%（极高信心）
实际保证金: $455（91%信心调整）

仓位价值: $455 × 17 = $7,735
风险暴露: 773%
```

---

### 案例2: 谨慎模式信号

**ICT信号评分**:
- 信心度: 65%（中高）

**历史绩效评分**:
- 期望值: 0.5%
- 盈亏比: 0.9
- 胜率: 58%
- 连续亏损: 6单
- 回撤: 8%
- 单日亏损: 3.5%

**保护状态**:
- ✅ 谨慎模式启动（单日亏损≥3%）
- ✅ 连续亏损保护（6单）

**信号检查**:
```
信心度 65% < 70% ❌
胜率 58% < 60% ❌

→ 拒绝交易
原因: 不符合高品质标准（需信心≥70%且胜率≥60%）
```

---

### 案例3: 高品质谨慎信号

**ICT信号评分**:
- 信心度: 78%（高）

**历史绩效评分**:
- 期望值: 0.9%
- 盈亏比: 1.1
- 胜率: 64%
- 连续亏损: 6单
- 回撤: 12%
- 单日亏损: 3.5%

**保护状态**:
- ✅ 谨慎模式启动
- ✅ 连续亏损保护

**信号检查**:
```
信心度 78% ≥ 70% ✅
胜率 64% ≥ 60% ✅

→ 允许交易（高品质信号）
```

**动态参数**:
```
基础杠杆: 12x（良好期望值）
连续亏损惩罚: -5x
回撤调整: -2x（12%回撤）
最终杠杆: 5x

保证金上限: 25%（高信心）
实际保证金: $195（78%信心调整）

仓位价值: $195 × 5 = $975
风险暴露: 97.5%
```

---

## 🎯 评分系统总结

### 核心优势

1. **双层评分**: ICT信号 + 历史绩效
2. **动态调整**: 根据市场和绩效实时调整
3. **多层保护**: 5层独立保护机制
4. **智能学习**: 负期望值拒绝，正期望值继续
5. **风险平衡**: 高信心高杠杆，低信心低杠杆

### 关键参数范围

| 参数 | 最小值 | 最大值 | 动态依据 |
|------|--------|--------|----------|
| 信心度 | 45% | 100% | ICT五维评分 |
| 杠杆 | 3x | 20x | 期望值+盈亏比+回撤+亏损 |
| 保证金 | 3% | 50% | 信心度 |
| 风险暴露 | 9% | 1000% | 保证金×杠杆 |

### 实际风险范围

**保守场景**（普通信心 + 低期望值）:
- 保证金: 8%
- 杠杆: 4x
- 风险暴露: 32%

**激进场景**（极高信心 + 优秀期望值）:
- 保证金: 50%
- 杠杆: 17x
- 风险暴露: 850%

**谨慎场景**（高品质 + 保护模式）:
- 保证金: 25%
- 杠杆: 5x
- 风险暴露: 125%

---

## 📂 相关文件

- **ICT策略**: `src/strategies/ict_strategy.py`
- **期望值计算器**: `src/managers/expectancy_calculator.py`
- **风险管理器**: `src/managers/risk_manager.py`
- **交易服务**: `src/services/trading_service.py`
- **主流程**: `src/main.py`

---

**版本**: v3.9.2 智能风险管理版  
**更新时间**: 2025-10-27

