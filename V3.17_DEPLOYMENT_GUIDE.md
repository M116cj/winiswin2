# 🚀 v3.17+ 部署指南

## 📦 系統概述

**版本**: v3.17+ (SelfLearningTrader 絕對控制權 + 無限槓桿)  
**核心理念**: 模型擁有無限制槓桿控制權，唯一準則是「勝率 × 信心度」

---

## 🏗️ 架構升級

### 新增核心模塊

1. **ConfigProfile** (`src/core/config_profile.py`)
   - `@dataclass(frozen=True)` 確保不可變性
   - 環境變量驅動所有配置
   - 內建配置驗證

2. **LeverageEngine** (`src/core/leverage_engine.py`)
   - 無限制槓桿計算
   - 公式: `base × (1 + (winrate-0.55)/0.15 × 11) × (confidence/0.5)`
   - 最小槓桿: 0.5x，無上限

3. **PositionSizer** (`src/core/position_sizer.py`)
   - 倉位數量計算
   - Binance 交易對規格緩存（TTL=1小時）
   - 自動調整止損距離（≥0.3%）
   - 確保名義價值 ≥ $10 USDT

4. **SLTPAdjuster** (`src/core/sltp_adjuster.py`)
   - 動態 SL/TP 調整
   - 放大因子: `1 + (leverage-1) × 0.05`，上限 3.0x
   - 高槓桿 → 寬止損/止盈

5. **SelfLearningTraderController** (`src/core/self_learning_trader_controller.py`)
   - 核心編排器
   - 接收信號 → 計算槓桿 → 計算倉位 → 調整 SL/TP → 返回可執行訂單

6. **PositionMonitor24x7** (`src/core/position_monitor_24x7.py`)
   - 每 2 秒檢查所有倉位
   - PnL ≤ -99% 初始風險 → 立即市價平倉
   - 使用優先級 0 API 通道（最高優先級）

7. **ModelRatingEngine** (`src/core/model_rating_engine.py`)
   - 100 分制評分系統
   - 6 大維度: R:R (25%) + 勝率 (20%) + EV (20%) + MDD (15%) + Sharpe (10%) + 頻率 (10%)
   - 嚴懲: 每筆 100% 虧損扣 15 分

8. **DailyReporter** (`src/core/daily_reporter.py`)
   - 生成 JSON + Markdown 報告
   - 保存到 `/reports/daily/`
   - 同時輸出到 stdout（供 Railway Logs 捕獲）

---

## ⚙️ Railway 部署配置

### 必須環境變量

```bash
# ===== 核心策略配置 =====
STRATEGY_MODE=self_learning
POSITION_CONTROL_MODE=self_learning
ENABLE_SELF_LEARNING=true

# ===== 開倉條件 (v3.17+) =====
MIN_WIN_PROBABILITY=0.55
MIN_CONFIDENCE=0.50
MIN_RR_RATIO=1.0
MAX_RR_RATIO=2.0

# ===== 倉位監控 (v3.17+) =====
POSITION_MONITOR_ENABLED=true
POSITION_MONITOR_INTERVAL=2
RISK_KILL_THRESHOLD=0.99

# ===== 模型評級 (v3.17+) =====
MODEL_RATING_ENABLED=true
ENABLE_DAILY_REPORT=true
REPORTS_DIR=reports/daily

# ===== Binance API =====
BINANCE_API_KEY=your_api_key_here
BINANCE_API_SECRET=your_api_secret_here
BINANCE_TESTNET=false

# ===== 交易設置 =====
TRADING_ENABLED=true
MAX_POSITIONS=999
CYCLE_INTERVAL=60

# ===== 系統配置 =====
LOG_LEVEL=INFO
MAX_WORKERS=4
```

### 可選環境變量

```bash
# 微調槓桿計算（保持默認值即可）
LEVERAGE_BASE=1.0
LEVERAGE_WIN_THRESHOLD=0.55
LEVERAGE_WIN_SCALE=0.15
LEVERAGE_WIN_MULTIPLIER=11.0

# 微調倉位計算
EQUITY_USAGE_RATIO=0.8
MIN_NOTIONAL_VALUE=10.0
MIN_STOP_DISTANCE_PCT=0.003

# 微調 SL/TP
SLTP_SCALE_FACTOR=0.05
SLTP_MAX_SCALE=3.0
```

---

## 🚀 Railway 設定

### 1. 構建設置

- **Build Command**: 自動檢測（Nixpacks）
- **Start Command**: `python src/main.py`

### 2. Cron Job（每日報告）

在 Railway Dashboard 添加 Cron Job：

```
# 每日 00:00 UTC 生成報告
0 0 * * * python -c "from src.core.daily_reporter import DailyReporter; import asyncio; asyncio.run(DailyReporter(...).generate_daily_report())"
```

### 3. 重啟策略

- **Restart Policy**: ALWAYS
- **Health Check**: 啟用（檢查 API 連接）

---

## 📊 系統工作流程

### 1. 初始化階段

```
main.py 啟動
  ↓
創建 ConfigProfile（驗證配置）
  ↓
創建 SelfLearningTrader（加載模型）
  ↓
創建 SelfLearningTraderController（整合三大引擎）
  ↓
啟動 PositionMonitor24x7（背景運行）
  ↓
啟動交易主循環
```

### 2. 交易週期

```
掃描市場 → 獲取多時間框架數據
  ↓
SelfLearningTrader.analyze()
  生成信號（含勝率、信心度、R:R）
  ↓
SelfLearningTraderController.analyze_and_execute()
  ├─ 驗證開倉條件（勝率≥55%, 信心≥50%, R:R∈[1.0,2.0]）
  ├─ 計算槓桿（無上限）
  ├─ 計算倉位數量（含 Binance 規格檢查）
  ├─ 調整 SL/TP（高槓桿→寬止損）
  └─ 返回可執行訂單包
  ↓
TradingService.execute_order()
  執行訂單
  ↓
TradeRecorder.record_trade()
  記錄交易
```

### 3. 24/7 倉位監控

```
PositionMonitor24x7 背景循環（每 2 秒）
  ↓
獲取所有倉位（優先級 0）
  ↓
For each 倉位:
  計算 PnL 百分比（相對初始風險）
  ↓
  If PnL ≤ -99% 風險:
    立即市價平倉（優先級 0）
    記錄強制平倉事件
```

### 4. 每日報告

```
每日 00:00 UTC（或手動觸發）
  ↓
收集過去 24 小時交易記錄
  ↓
計算統計數據（勝率、P&L、R:R 等）
  ↓
ModelRatingEngine.calculate_rating()
  ├─ 計算 6 大維度分數
  ├─ 扣除 100% 虧損懲罰
  └─ 輸出最終評分（0-100）
  ↓
DailyReporter.generate_daily_report()
  ├─ 生成 JSON 報告 → reports/daily/model_report_YYYY-MM-DD.json
  ├─ 生成 Markdown 報告 → reports/daily/model_report_YYYY-MM-DD.md
  └─ 輸出到 stdout → Railway Logs
```

---

## 🔍 監控與調試

### Railway Logs 關鍵輸出

```
# 初始化
✅ SelfLearningTraderController 初始化完成（v3.17+）
   🎯 模式: 絕對控制權（無限制槓桿）

# 交易信號
✅ BTCUSDT SHORT | 勝率:62% 信心:68% → 槓桿:8.5x | 數量:0.125 入場:$42000 SL:$42500 TP:$41000

# 強制平倉
🚨🚨🚨 ETHUSDT 觸發 100% 虧損熔斷！PnL: $-98.50 (-99.5%) 風險: $99.00
✅ 強制平倉成功: ETHUSDT (訂單: 123456789)

# 每日報告
[MODEL_EVALUATOR] 📊 每日報告
✅ 評分: 78.5/100 (等級: B)
📊 交易: 15 筆 | 勝率: 60.0%
💰 P&L: $+234.50
🚨 100% 虧損: 1 筆 (懲罰: -15.00 分)
🎯 建議: ⚠️ 模型表現一般，建議觀察
```

### 健康檢查

```bash
# 查看倉位監控器狀態
curl http://localhost:5000/api/monitor/status

# 查看模型評分
curl http://localhost:5000/api/rating/latest

# 手動觸發報告
curl -X POST http://localhost:5000/api/report/generate
```

---

## 🚨 風險管理

### 1. 極高槓桿保護

- **動態 SL/TP**: 槓桿 20x → SL 放大 2x
- **止損距離**: 強制 ≥ 0.3%
- **名義價值**: 強制 ≥ $10 USDT

### 2. 100% 虧損熔斷

- **監控頻率**: 每 2 秒
- **觸發條件**: PnL ≤ -99% 初始風險
- **執行方式**: 市價平倉（優先級 0）

### 3. 模型降級機制

| 評分等級 | 分數範圍 | 建議行動 |
|---------|---------|---------|
| S | 90-100 | 加倉 |
| A | 80-89 | 維持 |
| B | 70-79 | 觀察 |
| C | <70 | 降級至純規則模式 |

---

## 🔧 故障排除

### 問題 1: 無信號生成

**原因**: 條件過嚴（勝率≥55%, 信心≥50%, R:R∈[1.0,2.0]）

**解決方案**:
```bash
# 臨時降低閾值
export MIN_WIN_PROBABILITY=0.50
export MIN_CONFIDENCE=0.45
```

### 問題 2: 槓桿異常高

**原因**: 勝率/信心度預測過於樂觀

**解決方案**:
```bash
# 檢查模型學習進度
# 如果訓練次數 <100，模型可能過於自信
# 建議設置冷啟動保護（前 100 筆交易槓桿 ≤ 10x）
```

### 問題 3: 頻繁觸發 100% 虧損熔斷

**原因**: SL 設置過近或槓桿過高

**解決方案**:
```bash
# 增加最小止損距離
export MIN_STOP_DISTANCE_PCT=0.005  # 0.5%

# 增加 SLTP 放大因子
export SLTP_SCALE_FACTOR=0.10  # 從 0.05 增加到 0.10
```

---

## 📈 性能優化

### 1. 記憶體優化（Railway 512MB 限制）

- 使用 ThreadPoolExecutor（非 ProcessPool）
- 交易對規格緩存 TTL = 1 小時
- 模型量化（XGBoost <100KB）
- 特徵緩存 TTL = 60 秒

### 2. API 限流優化

- 倉位操作: 優先級 0（最高）
- 數據獲取: 優先級 3（最低）
- 使用分級熔斷器（GradedCircuitBreaker）

### 3. 監控頻率調整

```bash
# 降低監控頻率（節省 API 配額）
export POSITION_MONITOR_INTERVAL=5  # 從 2 秒改為 5 秒
```

---

## 📚 相關文檔

- [v3.16.3 增量學習系統](V3.16.3_INCREMENTAL_LEARNING_COMPLETE.md)
- [v3.17+ 完整藍圖](attached_assets/Pasted--SelfLearningTrader-v3-17--1761636329205_1761636329206.txt)
- [架構規劃](由 Architect 生成)

---

## ✅ 驗收標準

### 1. 槓桿計算

- [x] 移除所有 MAX_LEVERAGE 限制
- [x] 基於「勝率 × 信心度」公式
- [x] 最小值 0.5x，無上限

### 2. 倉位計算

- [x] 確保止損距離 ≥ 0.3%
- [x] 確保名義價值 ≥ $10 USDT
- [x] 確保數量 ≥ Binance 最小數量

### 3. 24/7 監控

- [x] 每 2 秒檢查
- [x] -99% 風險立即平倉
- [x] 使用優先級 0 API

### 4. 模型評級

- [x] 100 分制
- [x] 6 大維度
- [x] 100% 虧損扣 15 分

### 5. 報告系統

- [x] JSON + Markdown 格式
- [x] stdout 輸出（Railway Logs）
- [x] 每日自動生成

---

**部署版本**: v3.17+  
**最後更新**: 2025-10-28  
**負責人**: SelfLearningTrader Absolute Control Team
